<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>肯德基自助点餐系统</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
		<!-- 在head中添加，放在其他script之前 -->
		<script src="https://polyfill.io/v3/polyfill.min.js?features=default,es6,es7,es2015,es2016,es2017,es2018,es2019,es2020,fetch,Promise,Symbol,Array.from,Object.assign,Object.entries,Object.values,Number.isNaN,Math.trunc"></script>
		<!-- LeanCloud SDK -->
		<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
		<style>
			/* 原有样式保持不变，只新增必要的样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .logo {
            font-size: 2.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo i {
            color: #ffcc00;
        }
        
        .header-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .info-item i {
            color: #ffcc00;
            font-size: 0.9rem;
        }
        
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 12px;
        }
        
        .header-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.03);
        }
        
        .search-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 280px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid #e31837;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .search-btn {
            position: absolute;
            right: 4px;
            top: 4px;
            background-color: #e31837;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .search-btn:hover {
            background-color: #c8102e;
        }
        
        .search-hint {
            font-size: 0.8rem;
            color: #666;
            background-color: #f9f9f9;
            padding: 6px 10px;
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
        }
        
        .nav-menu {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }
        
        .nav-title {
            font-size: 1.3rem;
            color: #e31837;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .meal-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #ffcc00;
            display: block;
            text-decoration: none;
            color: inherit;
            position: relative;
            min-height: 180px;
        }
        
        .meal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            position: relative;
        }
        
        .meal-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e31837;
            flex: 1;
            padding-right: 40px;
        }
        
        .meal-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: #e31837;
            margin-top: 5px;
        }
        
        .meal-description {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        
        .meal-tag {
            display: inline-block;
            background-color: #ffcc00;
            color: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 5px;
            margin-bottom: 4px;
        }
        
        /* 修改：分享按钮放在右上角 */
        .meal-share-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(227, 24, 55, 0.1);
            color: #e31837;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .meal-share-btn:hover {
            background-color: #e31837;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(227, 24, 55, 0.3);
        }
        
        .back-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            margin-bottom: 15px;
            text-decoration: none;
            width: fit-content;
        }
        
        .back-btn:hover {
            background-color: #c8102e;
            transform: scale(1.03);
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .menu-section {
            flex: 3;
            min-width: 280px;
        }
        
        .right-section {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
        }
        
        .delivery-form {
            background-color: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }
        
        /* 压缩购物车样式开始 */
        .cart-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #eee;
        }
        
        .cart-section .section-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
        }
        
        .cart-items {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.85rem;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-name {
            flex: 2;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: #e31837;
            font-size: 0.9rem;
        }
        
        .cart-item-remove {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 8px;
            padding: 2px;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 2px solid #eee;
        }
        
        .total-price {
            color: #e31837;
        }
        
        .checkout-btn {
            background-color: #ffcc00;
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
            transition: all 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: #e6b800;
            transform: scale(1.02);
        }
        
        .checkout-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        /* 压缩购物车样式结束 */
        
        .section-title {
            font-size: 1.5rem;
            color: #e31837;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcc00;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: #ffcc00;
        }
        
        .meal-options {
            margin-bottom: 20px;
        }
        
        .option-group {
            margin-bottom: 12px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #e31837;
        }
        
        .option-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #444;
            font-size: 1rem;
        }
        
        .option-rules {
            font-size: 0.8rem;
            color: #e31837;
            margin-bottom: 8px;
            padding: 4px 8px;
            background-color: #ffe6e6;
            border-radius: 4px;
            display: inline-block;
        }
        
        .option-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .option-item {
            background-color: #f5f5f5;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 0.85rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 160px;
            position: relative;
        }
        
        .option-item:hover {
            background-color: #e9e9e9;
        }
        
        .option-item.selected {
            background-color: #e31837;
            color: white;
            border-color: #e31837;
        }
        
        .selection-counter {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }
        
        .counter-btn {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: none;
            background-color: white;
            color: #e31837;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .counter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .counter-value {
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .add-to-cart {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }
        
        .add-to-cart:hover {
            background-color: #c8102e;
            transform: scale(1.02);
        }
        
        .add-to-cart:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .required {
            color: #e31837;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #e31837;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .pickup-type {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .pickup-type label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: all 0.3s;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .pickup-type label:hover {
            border-color: #e31837;
        }
        
        .pickup-type input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .order-type {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .order-type label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .order-type label:hover {
            border-color: #e31837;
        }
        
        .order-type input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .delivery-fields, .pickup-fields {
            transition: all 0.3s;
        }
        
        .hidden {
            display: none;
        }
        
        .store-selection {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .store-selection .form-group {
            flex: 1;
            min-width: 180px;
        }
        
        .info-method-selector {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .method-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .method-option:hover {
            border-color: #e31837;
            background-color: #fff5f5;
        }
        
        .method-option input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .method-option input:checked {
            accent-color: #e31837;
        }
        
        .screenshot-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        
        .screenshot-upload-area:hover {
            border-color: #e31837;
            background-color: #fff5f5;
        }
        
        .screenshot-upload-area i {
            font-size: 36px;
            color: #e31837;
            margin-bottom: 8px;
        }
        
        .upload-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        
        .screenshot-preview {
            position: relative;
            margin-top: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            background-color: #f9f9f9;
            max-width: 250px;
        }
        
        .screenshot-preview img {
            width: 100%;
            border-radius: 4px;
            display: block;
            max-height: 150px;
            object-fit: contain;
        }
        
        .remove-screenshot {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #e31837;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .form-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .form-hint i {
            color: #ffcc00;
            font-size: 0.8rem;
        }
        
        .instructions {
            font-size: 0.85rem;
            color: #666;
            margin-top: 20px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
        }
        
        .instructions li {
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #666;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
        }
        
        .highlight {
            color: #e31837;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: #fff5f5;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
            font-size: 0.9rem;
        }
        
        .highlight i {
            color: #ffcc00;
        }
        
        .selection-status {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: inline-block;
        }
        
        .selection-status.valid {
            background-color: #e6f7e6;
            color: #2e7d32;
        }
        
        .selection-status.invalid {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .fixed-combo-items {
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .fixed-combo-item {
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .fixed-combo-item:last-child {
            border-bottom: none;
        }
        
        .fixed-combo-item-name {
            font-weight: 500;
        }
        
        .fixed-combo-item-qty {
            color: #e31837;
            font-weight: bold;
        }
        
        .my-orders-section {
            background-color: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }
        
        .orders-search {
            margin-bottom: 15px;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .search-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .search-btn:hover {
            background-color: #c8102e;
        }
        
        .order-filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .order-filter-tab {
            padding: 6px 12px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .order-filter-tab:hover {
            background-color: #e0e0e0;
        }
        
        .order-filter-tab.active {
            background-color: #e31837;
            color: white;
        }
        
        .user-order-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #ffcc00;
        }
        
        .user-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .user-order-id {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }
        
        .user-order-time {
            color: #666;
            font-size: 0.85rem;
        }
        
        .user-order-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 18px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .user-status-new {
            background-color: #ffebee;
            color: #e31837;
        }
        
        .user-status-processing {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .user-status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .user-order-items {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .user-order-item-detail {
            padding: 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #eee;
            font-size: 0.85rem;
        }
        
        .user-order-item-detail:last-child {
            border-bottom: none;
        }
        
        .user-order-item-name {
            flex: 2;
        }
        
        .user-order-item-price {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: #e31837;
        }
        
        .user-order-info {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        
        .user-order-info p {
            margin-bottom: 4px;
        }
        
        .user-order-total {
            font-weight: bold;
            color: #e31837;
            font-size: 1.1rem;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 2px solid #eee;
            text-align: right;
        }
        
        .no-user-orders {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }
        
        .no-user-orders i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 12px;
        }
        
        .user-id-info {
            background-color: #f0f0f0;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-id-label {
            font-weight: bold;
            color: #666;
        }
        
        .user-id-value {
            font-family: monospace;
            background-color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.8rem;
        }
        
        .admin-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            background-color: white;
            z-index: 2000;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: none;
        }
        
        .admin-panel.active {
            transform: translateX(0);
            display: block;
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }
        
        .panel-overlay.active {
            display: block;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .panel-header h2 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-panel {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .close-panel:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .panel-content {
            padding: 15px;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .admin-tab {
            padding: 10px 18px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            color: #666;
            font-weight: 500;
        }
        
        .admin-tab:hover {
            color: #e31837;
            background-color: #fff5f5;
        }
        
        .admin-tab.active {
            color: #e31837;
            border-bottom-color: #e31837;
            font-weight: bold;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .order-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .filter-btn:hover {
            background-color: #e0e0e0;
        }
        
        .filter-btn.active {
            background-color: #e31837;
            color: white;
        }
        
        .orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            min-height: 250px;
        }
        
        .admin-order-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #ffcc00;
            transition: all 0.3s;
        }
        
        .admin-order-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .order-time {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        .order-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 18px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        .status-new {
            background-color: #ffebee;
            color: #e31837;
        }
        
        .status-processing {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .order-details {
            margin-bottom: 12px;
        }
        
        .order-items {
            margin-bottom: 8px;
        }
        
        .order-item-detail {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.85rem;
        }
        
        .order-total {
            font-weight: bold;
            color: #e31837;
            font-size: 1.1rem;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #eee;
        }
        
        .customer-info {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        
        .customer-info p {
            margin-bottom: 4px;
        }
        
        .screenshot-container {
            margin-top: 12px;
        }
        
        .screenshot-container img {
            width: 100%;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .screenshot-container img:hover {
            transform: scale(1.02);
        }
        
        .no-orders {
            text-align: center;
            padding: 30px 15px;
            color: #666;
            grid-column: 1 / -1;
            width: 100%;
        }
        
        .no-orders i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 12px;
        }
        
        .admin-btn {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background-color: #333;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .admin-btn:hover {
            background-color: #555;
            transform: scale(1.03);
        }
        
        .new-order-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background-color: #e31837;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
        }
        
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .password-modal.active {
            display: flex;
        }
        
        .password-box {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .password-box h3 {
            color: #e31837;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 3px;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #e31837;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .password-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .password-btn:hover {
            background-color: #c8102e;
            transform: scale(1.02);
        }
        
        .password-error {
            color: #e31837;
            margin-top: 12px;
            font-weight: bold;
            display: none;
            font-size: 0.9rem;
        }
        
        .meal-page-container {
            display: none;
        }
        
        .meal-page-container.active {
            display: block;
        }
        
        .meal-management {
            margin-top: 15px;
        }
        
        .meal-list {
            margin-bottom: 20px;
        }
        
        .meal-list-item {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #e31837;
        }
        
        .meal-list-item-info {
            flex: 1;
            font-size: 0.85rem;
        }
        
        .meal-list-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .edit-btn {
            background-color: #ffcc00;
            color: #333;
        }
        
        .edit-btn:hover {
            background-color: #e6b800;
        }
        
        .delete-btn {
            background-color: #e31837;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #c8102e;
        }
        
        .add-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .add-btn:hover {
            background-color: #3d8b40;
        }
        
        .meal-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 180px;
        }
        
        .option-groups-management {
            margin-top: 20px;
        }
        
        .option-group-item {
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #4CAF50;
        }
        
        .option-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .option-group-title {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
        }
        
        .option-items-list {
            margin-top: 8px;
            padding-left: 15px;
        }
        
        .option-item-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.85rem;
        }
        
        .option-item-list-item:last-child {
            border-bottom: none;
        }
        
        .no-meals-message {
            text-align: center;
            padding: 25px 15px;
            color: #666;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        
        .no-meals-message i {
            font-size: 2.5rem;
            color: #ddd;
            margin-bottom: 12px;
        }
        
        .fixed-items-management {
            margin-top: 15px;
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .fixed-item-list {
            margin-top: 8px;
        }
        
        .fixed-item-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.85rem;
        }
        
        .fixed-item-list-item:last-child {
            border-bottom: none;
        }
        
        .status-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }
        
        .status-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .status-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 25px;
        }
        
        .status-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .status-slider {
            background-color: #4CAF50;
        }
        
        input:checked + .status-slider:before {
            transform: translateX(24px);
        }
        
        .status-label {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-right: 12px;
        }
        
        .status-active {
            color: #4CAF50;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .status-inactive {
            color: #f44336;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .meal-card.inactive {
            opacity: 0.6;
            border-left: 4px solid #ccc;
            position: relative;
        }
        
        .meal-card.inactive:after {
            content: "已下架";
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #f44336;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .meal-card.inactive:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: not-allowed;
        }
        
        .meal-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .meal-filter-btn {
            padding: 6px 12px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .meal-filter-btn:hover {
            background-color: #e0e0e0;
        }
        
        .meal-filter-btn.active {
            background-color: #e31837;
            color: white;
        }
        
        .sort-order-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .sort-order-input {
            width: 70px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .sort-order-buttons {
            display: flex;
            gap: 4px;
        }
        
        .sort-order-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .sort-order-btn:hover {
            background-color: #f0f0f0;
            border-color: #e31837;
            color: #e31837;
        }
        
        .sort-order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .sort-order-btn:disabled:hover {
            background-color: white;
            border-color: #ddd;
            color: inherit;
        }
        
        .order-display {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e31837;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            margin-top: 15px;
            font-size: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 实时更新指示器 */
        .realtime-indicator {
            position: fixed;
            top: 70px;
            right: 15px;
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 18px;
            font-size: 0.8rem;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .submit-status {
            text-align: center;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .compress-progress {
            margin-top: 8px;
            padding: 6px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
            display: none;
        }
        
        .compress-progress.active {
            display: block;
        }
        
        .compress-progress span {
            font-weight: bold;
            color: #e31837;
        }
        
        .screenshot-preview-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .image-info {
            font-size: 0.75rem;
            color: #666;
            background-color: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 2px solid #4CAF50;
        }
        
        .edit-form-container {
            display: none;
            margin-top: 15px;
        }
        
        .edit-form-container.active {
            display: block;
        }
        
        .show {
            display: block !important;
        }
        
        .hide {
            display: none !important;
        }
        
        .quick-submit {
            position: relative;
            overflow: hidden;
        }
        
        .quick-submit:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .quick-submit:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        .admin-search-container {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .admin-search-box {
            flex: 1;
            min-width: 220px;
            position: relative;
        }
        
        .admin-search-input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid #e31837;
            border-radius: 20px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .admin-search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .admin-search-btn {
            position: absolute;
            right: 4px;
            top: 4px;
            background-color: #e31837;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .admin-search-btn:hover {
            background-color: #c8102e;
        }
        
        .admin-search-hint {
            font-size: 0.8rem;
            color: #666;
            background-color: #f9f9f9;
            padding: 5px 8px;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .delivery-tag {
            display: inline-block;
            background-color: #e31837;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        
        .no-delivery-tag {
            display: inline-block;
            background-color: #666;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        
        /* 修改：订单确认模态框样式 - 修复滚动问题 */
        .order-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .order-confirm-modal.active {
            display: flex;
        }
        
        .order-confirm-box {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            height: 85vh;
            max-height: 85vh;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .order-confirm-header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
        }
        
        .order-confirm-title {
            font-size: 1.3rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-confirm-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .order-confirm-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .order-confirm-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .order-confirm-item {
            margin-bottom: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .order-confirm-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .order-confirm-item-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e31837;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-confirm-item-content {
            padding-left: 10px;
        }
        
        .order-confirm-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .order-confirm-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .order-confirm-option:last-child {
            border-bottom: none;
        }
        
        .order-confirm-total {
            font-size: 1.3rem;
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            color: #333;
            flex-shrink: 0;
        }
        
        .order-confirm-buttons {
            display: flex;
            gap: 15px;
            padding: 15px 20px 20px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .order-confirm-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .order-confirm-btn.cancel {
            background-color: #f0f0f0;
            color: #666;
        }
        
        .order-confirm-btn.cancel:hover {
            background-color: #e0e0e0;
            transform: scale(1.02);
        }
        
        .order-confirm-btn.confirm {
            background-color: #e31837;
            color: white;
        }
        
        .order-confirm-btn.confirm:hover {
            background-color: #c8102e;
            transform: scale(1.02);
        }
        
        /* 新增：修复反馈截图样式 */
        .feedback-upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f1f8e9;
            margin-top: 8px;
            font-size: 0.85rem;
            position: relative;
            overflow: hidden;
        }
        
        .feedback-upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .feedback-upload-area:hover {
            border-color: #2e7d32;
            background-color: #e8f5e9;
        }
        
        .feedback-upload-area i {
            font-size: 20px;
            color: #4CAF50;
            margin-bottom: 6px;
        }
        
        .feedback-preview {
            position: relative;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px;
            background-color: #f9f9f9;
            display: none;
        }
        
        .feedback-preview.show {
            display: block;
        }
        
        .feedback-preview img {
            width: 100%;
            border-radius: 4px;
            display: block;
            max-height: 120px;
            object-fit: contain;
        }
        
        .remove-feedback {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .feedback-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 18px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            margin-top: 8px;
            display: none;
        }
        
        .feedback-btn.show {
            display: flex;
        }
        
        .feedback-btn:hover {
            background-color: #3d8b40;
        }
        
        /* 新增：反馈截图容器样式 - 美化 */
        .feedback-screenshot-container {
            margin-top: 12px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #4CAF50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .feedback-screenshot-container h4 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .feedback-thumbnail {
            width: 100%;
            border-radius: 6px;
            border: 1px solid #4CAF50;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .feedback-thumbnail:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* 新增：订单反馈截图显示在顶部 - 优化显示大小 */
        .order-feedback-top {
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .order-feedback-top h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 优化：增大订单反馈截图显示大小 */
        .order-feedback-thumbnail {
            max-width: 100%; /* 改为100%宽度，根据容器自适应 */
            width: auto;
            max-height: 250px; /* 增大最大高度 */
            border-radius: 8px;
            border: 2px solid #4CAF50;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: block;
            margin: 0 auto; /* 居中显示 */
        }
        
        .order-feedback-thumbnail:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        /* 新增：顾客订单页面中的反馈截图显示优化 */
        .user-order-feedback-container {
            margin-top: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .user-order-feedback-container h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-feedback-thumbnail {
            max-width: 100%; /* 改为100%宽度，根据容器自适应 */
            width: auto;
            max-height: 300px; /* 增大最大高度 */
            border-radius: 8px;
            border: 2px solid #4CAF50;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: block;
            margin: 0 auto; /* 居中显示 */
        }
        
        .user-feedback-thumbnail:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        /* 修改：套餐详情页的分享按钮样式 */
        .meal-detail-share-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            text-decoration: none;
            margin-left: auto;
        }
        
        .meal-detail-share-btn:hover {
            background-color: #3d8b40;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        .meal-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* 新增：移动端管理员订单项按钮布局优化 */
        .admin-order-item .action-buttons-container {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .admin-order-item .action-buttons-container .filter-btn {
            flex: 1;
            min-width: calc(50% - 4px);
            padding: 8px 10px;
            font-size: 0.8rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .menu-section {
                flex: 100%;
                order: 1;
                margin-bottom: 15px;
            }
            
            .right-section {
                flex: 100%;
                order: 2;
                display: flex;
                flex-direction: column;
            }
            
            .delivery-form {
                order: 1;
                width: 100%;
            }
            
            .cart-section {
                order: 2;
                width: 100%;
                position: static;
                margin-top: 15px;
            }
            
            .logo {
                font-size: 1.8rem;
            }
            
            .meal-card {
                padding: 12px;
            }
            
            .store-selection {
                flex-direction: column;
            }
            
            .store-selection .form-group {
                min-width: 100%;
            }
            
            .info-method-selector {
                flex-direction: column;
            }
            
            .admin-panel {
                width: 100%;
            }
            
            .orders-container {
                grid-template-columns: 1fr;
            }
            
            .admin-btn span {
                display: none;
            }
            
            .admin-btn {
                padding: 12px;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                justify-content: center;
                font-size: 1rem;
            }
            
            .option-items {
                flex-direction: column;
            }
            
            .option-item {
                min-width: 100%;
                justify-content: space-between;
            }
            
            .password-box {
                padding: 20px;
                width: 95%;
            }
            
            .meal-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
            
            .meal-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .meal-list-item-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .option-group-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .header-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .header-btn {
                width: 180px;
                justify-content: center;
            }
            
            .sort-order-container {
                flex-wrap: wrap;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .pickup-type {
                flex-direction: column;
            }
            
            .pickup-type label {
                width: 100%;
            }
            
            .realtime-indicator {
                top: 60px;
                right: 10px;
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            .admin-search-container {
                flex-direction: column;
            }
            
            .admin-search-box {
                min-width: 100%;
            }
            
            /* 移动端进一步压缩购物车 */
            .cart-items {
                max-height: 150px;
            }
            
            .cart-item {
                padding: 6px 0;
                font-size: 0.8rem;
            }
            
            .cart-section {
                padding: 12px;
            }
            
            /* 移动端订单确认模态框 */
            .order-confirm-box {
                width: 95%;
                height: 90vh;
                max-height: 90vh;
            }
            
            .order-confirm-buttons {
                flex-direction: column;
            }
            
            .order-confirm-body {
                padding: 15px;
                gap: 15px;
            }
            
            .order-confirm-item-title {
                font-size: 1rem;
            }
            
            /* 移动端优化反馈截图显示 */
            .order-feedback-thumbnail {
                max-height: 200px; /* 移动端适当减小 */
            }
            
            .user-feedback-thumbnail {
                max-height: 200px; /* 移动端适当减小 */
            }
            
            .order-feedback-top {
                padding: 12px;
            }
            
            .user-order-feedback-container {
                padding: 12px;
            }
            
            /* 移动端调整分享按钮位置 */
            .meal-detail-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .meal-detail-share-btn {
                margin-left: 0;
                width: 100%;
                justify-content: center;
            }
            
            .admin-order-item {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .admin-order-item .order-id {
                font-size: 1rem;
                word-break: break-all;
            }
            
            .admin-order-item .order-time {
                font-size: 0.75rem;
                margin-bottom: 8px;
            }
            
            .admin-order-item .order-status {
                font-size: 0.75rem;
                padding: 2px 8px;
                margin-bottom: 10px;
            }
            
            .admin-order-item .order-details {
                margin-bottom: 10px;
            }
            
            .admin-order-item .order-item-detail {
                font-size: 0.8rem;
                padding: 4px 0;
            }
            
            .admin-order-item .order-total {
                font-size: 1rem;
                margin-top: 6px;
                padding-top: 6px;
            }
            
            .admin-order-item .customer-info {
                padding: 10px;
                font-size: 0.8rem;
                margin-top: 10px;
            }
            
            .admin-order-item .customer-info p {
                margin-bottom: 3px;
            }
            
            /* 移动端管理员订单项按钮布局优化 */
            .admin-order-item .action-buttons-container {
                margin-top: 10px;
                gap: 5px;
                flex-direction: column;
            }
            
            .admin-order-item .action-buttons-container .filter-btn {
                min-width: 100%;
                margin-bottom: 5px;
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            /* 修复反馈截图上传区域在移动端的显示 */
            .admin-order-item .feedback-upload-area {
                padding: 10px;
                font-size: 0.8rem;
            }
            
            .admin-order-item .feedback-upload-area i {
                font-size: 18px;
                margin-bottom: 5px;
            }
            
            .admin-order-item .upload-hint {
                font-size: 0.75rem;
            }
            
            .admin-order-item .feedback-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
            
            /* 修复管理员面板内容在移动端的边距 */
            .panel-content {
                padding: 12px;
            }
            
            .admin-tabs {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .admin-tab {
                width: 100%;
                text-align: left;
                padding: 10px 12px;
                border-bottom: 1px solid #eee;
            }
            
            .order-filters {
                justify-content: center;
            }
            
            .order-filters .filter-btn {
                flex: 1;
                min-width: calc(33.33% - 8px);
                text-align: center;
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            /* 移动端订单项内部截图预览优化 */
            .admin-order-item .screenshot-container img {
                max-height: 150px;
                object-fit: contain;
            }
            
            .admin-order-item .feedback-screenshot-container {
                padding: 8px;
            }
            
            .admin-order-item .feedback-screenshot-container h4 {
                font-size: 0.85rem;
            }
            
            .admin-order-item .feedback-thumbnail {
                max-height: 180px;
            }
            
            /* 移动端订单项内部反馈上传区域优化 */
            .admin-order-item .form-group {
                margin-bottom: 12px;
            }
            
            .admin-order-item .feedback-preview {
                margin-top: 8px;
                padding: 5px;
            }
            
            .admin-order-item .feedback-preview img {
                max-height: 120px;
            }
            
            /* 移动端管理员搜索容器优化 */
            .admin-search-container {
                padding: 10px;
                gap: 8px;
            }
            
            .admin-search-hint {
                font-size: 0.75rem;
                padding: 4px 6px;
            }
            
            /* 移动端套餐管理部分优化 */
            .meal-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px;
            }
            
            .meal-list-item-actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .meal-list-item-actions > div {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .status-label {
                justify-content: flex-start;
            }
            
            .sort-order-container {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            .meal-list-item-actions > div:last-child {
                display: flex;
                width: 100%;
                justify-content: space-between;
            }
            
            .meal-list-item-actions > div:last-child button {
                flex: 1;
                max-width: calc(50% - 4px);
            }
        }
        
        /* 新增：超小屏幕设备进一步优化 */
        @media (max-width: 480px) {
            .admin-order-item .action-buttons-container {
                gap: 5px;
            }
            
            .admin-order-item .action-buttons-container .filter-btn {
                min-width: 100%;
                margin-bottom: 5px;
                font-size: 0.75rem;
                padding: 6px 8px;
            }
            
            .order-filters .filter-btn {
                min-width: calc(50% - 4px);
                font-size: 0.75rem;
                padding: 5px 6px;
            }
            
            .admin-order-item .order-status {
                font-size: 0.7rem;
                padding: 2px 6px;
            }
        }
        
        /* 确保在桌面端保持左右布局 */
        @media (min-width: 769px) {
            .main-content {
                flex-direction: row;
            }
            
            .menu-section {
                flex: 3;
                order: 1;
            }
            
            .right-section {
                flex: 1;
                order: 2;
                display: flex;
                flex-direction: column;
            }
            
            .delivery-form {
                order: 1;
            }
        }
        
        /* 新增：分享模态框样式 */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .share-modal.active {
            display: flex;
        }
        
        .share-box {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .share-box h3 {
            color: #e31837;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .share-link-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
            word-break: break-all;
            text-align: left;
        }
        
        .share-link {
            font-size: 0.9rem;
            color: #333;
            font-family: monospace;
        }
        
        .share-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .share-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .share-action-btn.copy {
            background-color: #4CAF50;
            color: white;
        }
        
        .share-action-btn.copy:hover {
            background-color: #3d8b40;
            transform: scale(1.02);
        }
        
        .share-action-btn.close {
            background-color: #f0f0f0;
            color: #666;
        }
        
        .share-action-btn.close:hover {
            background-color: #e0e0e0;
            transform: scale(1.02);
        }
        
        .copy-status {
            margin-top: 12px;
            font-size: 0.9rem;
            color: #4CAF50;
            display: none;
        }
        
        .copy-status.show {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        /* 新增：宅急送截图上传区域样式 */
        .delivery-screenshot-upload-area {
            border: 2px dashed #e31837;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #fff5f5;
            margin-top: 8px;
            font-size: 0.85rem;
            position: relative;
            overflow: hidden;
        }
        
        .delivery-screenshot-upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .delivery-screenshot-upload-area:hover {
            border-color: #c8102e;
            background-color: #ffe6e6;
        }
        
        .delivery-screenshot-upload-area i {
            font-size: 20px;
            color: #e31837;
            margin-bottom: 6px;
        }
        
        .delivery-screenshot-preview {
            position: relative;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px;
            background-color: #f9f9f9;
            display: none;
        }
        
        .delivery-screenshot-preview.show {
            display: block;
        }
        
        .delivery-screenshot-preview img {
            width: 100%;
            border-radius: 4px;
            display: block;
            max-height: 120px;
            object-fit: contain;
        }
        
        .remove-delivery-screenshot {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #e31837;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        /* 配送方式选择器样式 */
        .delivery-method-selector {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            margin-bottom: 15px;
        }
        
        .delivery-method-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .delivery-method-option:hover {
            border-color: #e31837;
            background-color: #fff5f5;
        }
        
        .delivery-method-option input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .delivery-method-option input:checked {
            accent-color: #e31837;
        }
        
        /* 可选字段提示 */
        .optional-field {
            color: #666;
            font-size: 0.8rem;
            font-style: italic;
        }
        
        /* 其他原有样式保持不变... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 新增：选项组管理中的选项项操作按钮样式 */
        .option-item-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .option-item-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 3px;
            background-color: #f0f0f0;
            color: #333;
        }
        
        .option-item-action-btn:hover {
            background-color: #e0e0e0;
        }
        
        .option-item-action-btn.add-above {
            background-color: #4CAF50;
            color: white;
        }
        
        .option-item-action-btn.add-above:hover {
            background-color: #3d8b40;
        }
        
        .option-item-action-btn.add-below {
            background-color: #2196F3;
            color: white;
        }
        
        .option-item-action-btn.add-below:hover {
            background-color: #0b7dda;
        }
        
        .option-item-action-btn.delete {
            background-color: #f44336;
            color: white;
        }
        
        .option-item-action-btn.delete:hover {
            background-color: #d32f2f;
        }
        
        /* 新增：选项组操作按钮样式 */
        .option-group-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .option-group-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
            background-color: #f0f0f0;
            color: #333;
        }
        
        .option-group-action-btn:hover {
            background-color: #e0e0e0;
        }
        
        .option-group-action-btn.add-above {
            background-color: #4CAF50;
            color: white;
        }
        
        .option-group-action-btn.add-above:hover {
            background-color: #3d8b40;
        }
        
        .option-group-action-btn.add-below {
            background-color: #2196F3;
            color: white;
        }
        
        .option-group-action-btn.add-below:hover {
            background-color: #0b7dda;
        }
        
        /* 其他样式保持不变... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        /* 添加在CSS文件的适当位置 */
       /* 解析提示样式 */
       .parse-hint {
           background-color: #f0f9ff;
           border-left: 4px solid #2196F3;
           padding: 10px 12px;
           margin: 8px 0 12px 0;
           border-radius: 4px;
           font-size: 0.85rem;
           line-height: 1.4;
           display: none;
           animation: fadeIn 0.3s ease-in-out;
       }
       
       @keyframes fadeIn {
           from { opacity: 0; transform: translateY(-5px); }
           to { opacity: 1; transform: translateY(0); }
       }
       
       /* 验证成功和失败的样式 */
       .form-input.valid {
           border-color: #4CAF50 !important;
           box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2) !important;
       }
       
       .form-input.invalid {
           border-color: #e31837 !important;
           box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2) !important;
       }
       
       /* 自动解析按钮样式 */
       #parseDeliveryInfo {
           transition: all 0.3s ease;
           margin-top: 8px;
       }
       
       #parseDeliveryInfo:hover {
           background-color: #3d8b40 !important;
           transform: translateY(-2px);
           box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
       }
       
       #parseDeliveryInfo:active {
           transform: translateY(0);
       }
        /* ... 其余样式与之前相同 ... */
        /* 添加在CSS文件的适当位置 */
        .parse-result-hint {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #2e7d32;
            display: none;
        }
        
        .parse-result-hint.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 验证成功和失败的样式 */
        .form-input.valid {
            border-color: #4CAF50 !important;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2) !important;
        }
        
        .form-input.invalid {
            border-color: #e31837 !important;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2) !important;
        }
        
        /* 自动解析按钮样式 */
        #parseDeliveryInfo {
            transition: all 0.3s ease;
        }
        
        #parseDeliveryInfo:hover {
            background-color: #3d8b40 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        #parseDeliveryInfo:active {
            transform: translateY(0);
        }
    </style>
	</head>
	<body>
		<!-- 全局加载动画 -->
		<div class="loading-overlay" id="globalLoading">
			<div>
				<div class="loading-spinner"></div>
				<div class="loading-text" id="loadingText">处理中...</div>
			</div>
		</div>

		<!-- 实时更新指示器 -->
		<div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
			<i class="fas fa-sync-alt fa-spin"></i>
			<span>实时更新中...</span>
		</div>

		<!-- 订单确认模态框 -->
		<div class="order-confirm-modal" id="orderConfirmModal">
			<div class="order-confirm-box">
				<div class="order-confirm-header">
					<h2 class="order-confirm-title">
						<i class="fas fa-clipboard-check"></i>
						确认订单信息
					</h2>
					<button class="order-confirm-close" id="orderConfirmClose">
						<i class="fas fa-times"></i>
					</button>
				</div>

				<div class="order-confirm-body order-confirm-compact" id="orderConfirmBody">
					<!-- 订单详情将通过JavaScript动态填充 -->
				</div>

				<div class="order-confirm-buttons">
					<button class="order-confirm-btn cancel" id="orderConfirmCancel">
						<i class="fas fa-times"></i>
						取消
					</button>
					<button class="order-confirm-btn confirm" id="orderConfirmSubmit">
						<i class="fas fa-check"></i>
						确认提交
					</button>
				</div>
			</div>
		</div>

		<!-- 新增：分享模态框 -->
		<div class="share-modal" id="shareModal">
			<div class="share-box">
				<h3><i class="fas fa-share-alt"></i> 分享套餐</h3>
				<p>复制下面的链接分享给朋友，点击链接可直接跳转到该套餐页面：</p>

				<div class="share-link-container">
					<div class="share-link" id="shareLink">https://sykfc.top?meal=</div>
				</div>

				<div class="copy-status" id="copyStatus">
					<i class="fas fa-check-circle"></i> 链接已复制到剪贴板！
				</div>

				<div class="share-actions">
					<button class="share-action-btn copy" id="copyLinkBtn">
						<i class="fas fa-copy"></i> 复制链接
					</button>
					<button class="share-action-btn close" id="closeShareBtn">
						<i class="fas fa-times"></i> 关闭
					</button>
				</div>
			</div>
		</div>

		<header>
			<div class="container">
				<div class="logo">
					<i class="fas fa-utensils"></i>
					<h1>肯德基自助点餐系统</h1>
					<i class="fas fa-hamburger"></i>
				</div>
				<p>宅急送免配送费 | 多人餐团餐优惠 | 外送到家</p>
				<div class="header-info">
					<div class="info-item">
						<i class="fas fa-shipping-fast"></i>
						<span>宅急送免配送费</span>
					</div>
					<div class="info-item">
						<i class="fas fa-users"></i>
						<span>多人餐团餐优惠</span>
					</div>
					<div class="info-item">
						<i class="fas fa-store"></i>
						<span>到店自提</span>
					</div>
				</div>

				<div class="header-buttons">
					<button class="header-btn" id="viewOrdersBtn">
						<i class="fas fa-clipboard-list"></i>
						查看我的订单
					</button>
					<button class="header-btn" id="viewHomeBtn" style="display: none;">
						<i class="fas fa-home"></i>
						返回首页
					</button>
				</div>
			</div>
		</header>

		<div class="container">
			<!-- 首页 -->
			<div id="homePage" class="meal-page-container active">
				<div class="search-container">
					<div class="search-box">
						<input type="text" class="search-input" id="mealSearchInput" placeholder="搜索套餐：输入标签、价格、套餐名称或编号...">
						<button class="search-btn" id="mealSearchBtn">
							<i class="fas fa-search"></i>
						</button>
					</div>
					<div class="search-hint">
						<i class="fas fa-lightbulb"></i>
						提示：可以输入标签（如"自提"、"宅急送"）、价格（如"89.9"）、套餐名称或套餐编号进行搜索
					</div>
				</div>

				<div class="nav-menu">
					<h2 class="nav-title">
						<i class="fas fa-utensils"></i>
						选择您想要的套餐
					</h2>
					<div class="instructions">
						<p><strong>下单步骤：</strong></p>
						<ol>
							<li>选择您想要的套餐</li>
							<li>在套餐中选择具体的汉堡、小吃和饮品（点击选项，使用+/-按钮调整数量）</li>
							<li>确保每个选项组的选择数量符合要求（会有提示）</li>
							<li>点击"加入购物车"按钮</li>
							<li>在右侧配送信息底部确认订单并选择配送方式</li>
							<li>提交订单完成购买</li>
							<li>提交后可以点击上方"查看我的订单"查看订单状态</li>
							<li>点击右上角"分享"按钮可以将套餐分享给朋友</li>
						</ol>
					</div>
				</div>

				<div class="meal-grid" id="mealGrid">
					<!-- 套餐卡片将通过JavaScript动态生成 -->
				</div>

				<div class="no-meals-message" id="noMealsMessage" style="display: none;">
					<i class="fas fa-utensils"></i>
					<h3>暂无套餐</h3>
					<p>请联系管理员添加套餐</p>
				</div>
			</div>

			<!-- 套餐详情页 -->
			<div id="mealDetailPage" class="meal-page-container">
				<!-- 套餐详情内容将通过JavaScript动态生成 -->
			</div>

			<!-- 我的订单页 -->
			<div id="myOrdersPage" class="meal-page-container">
				<a href="#" class="back-btn" id="backFromOrdersBtn">
					<i class="fas fa-arrow-left"></i>
					返回
				</a>

				<div class="my-orders-section">
					<h2 class="section-title">
						<i class="fas fa-clipboard-list"></i>
						我的订单
					</h2>

					<div class="user-id-info">
						<div class="user-id-label">您的用户标识符：</div>
						<div class="user-id-value" id="currentUserIdDisplay"></div>
					</div>

					<div class="orders-search">
						<div class="search-box">
							<input type="text" class="search-input" id="orderSearchInput" placeholder="输入订单号搜索...">
							<button class="search-btn" id="orderSearchBtn">搜索</button>
						</div>

						<div class="order-filter-tabs">
							<button class="order-filter-tab active" data-order-filter="all">全部订单</button>
							<button class="order-filter-tab" data-order-filter="new">新订单</button>
							<button class="order-filter-tab" data-order-filter="processing">处理中</button>
							<button class="order-filter-tab" data-order-filter="completed">已完成</button>
						</div>
					</div>

					<div id="myOrdersContainer">
						<!-- 订单内容将通过JavaScript动态生成 -->
					</div>

					<div class="no-user-orders" id="noUserOrdersMessage">
						<i class="fas fa-box-open"></i>
						<h3>暂无订单</h3>
						<p>您还没有提交过订单，快去下单吧！</p>
					</div>
				</div>
			</div>

			<div class="footer">
				<p>© 2026 肯德基自助点餐系统 | 宅急送免配送费 | 商品特殊售出不退不换</p>
			</div>
		</div>

		<!-- 后台管理按钮 -->
		<button class="admin-btn" id="adminBtn">
			<i class="fas fa-user-shield"></i>
			<span>后台管理</span>
			<div class="new-order-badge" id="newOrderBadge" style="display: none;">0</div>
		</button>

		<!-- 密码验证模态框 -->
		<div class="password-modal" id="passwordModal">
			<div class="password-box">
				<h3><i class="fas fa-lock"></i> 管理员登录</h3>
				<input type="password" class="password-input" id="adminPassword" placeholder="请输入管理员密码" maxlength="6">
				<div class="password-error" id="passwordError">密码错误，请重新输入！</div>
				<button class="password-btn" id="submitPassword">确认</button>
			</div>
		</div>

		<!-- 管理员面板遮罩 -->
		<div class="panel-overlay" id="panelOverlay"></div>

		<!-- 管理员面板 -->
		<div class="admin-panel" id="adminPanel">
			<div class="panel-header">
				<h2><i class="fas fa-clipboard-list"></i> 系统管理后台</h2>
				<button class="close-panel" id="closePanel">
					<i class="fas fa-times"></i>
				</button>
			</div>

			<div class="panel-content">
				<div class="admin-tabs">
					<button class="admin-tab active" data-tab="orders">订单管理</button>
					<button class="admin-tab" data-tab="meals">套餐管理</button>
					<button class="admin-tab" data-tab="addMeal">添加套餐</button>
				</div>

				<div id="ordersTab" class="admin-tab-content active">
					<div class="order-filters">
						<button class="filter-btn active" data-filter="all">全部订单</button>
						<button class="filter-btn" data-filter="new">新订单</button>
						<button class="filter-btn" data-filter="processing">处理中</button>
						<button class="filter-btn" data-filter="completed">已完成</button>
						<button class="filter-btn" id="clearAllOrders">清空所有订单</button>
						<button class="filter-btn" id="syncDataBtn">同步数据</button>
					</div>

					<div class="orders-container" id="ordersContainer">
						<div class="no-orders" id="noOrdersMessage">
							<i class="fas fa-box-open"></i>
							<h3>暂无订单</h3>
							<p>当顾客提交订单后，订单将显示在这里</p>
						</div>
					</div>
				</div>

				<div id="mealsTab" class="admin-tab-content">
					<!-- 搜索区域 -->
					<div class="admin-search-container">
						<div class="admin-search-box">
							<input type="text" class="admin-search-input" id="adminMealSearchInput" placeholder="搜索套餐：输入套餐名称、标签、价格或ID...">
							<button class="admin-search-btn" id="adminMealSearchBtn">
								<i class="fas fa-search"></i>
							</button>
						</div>
						<div class="admin-search-hint">
							<i class="fas fa-lightbulb"></i>
							可以输入套餐名称、标签、价格或ID进行搜索
						</div>
					</div>

					<div class="meal-filters">
						<button class="meal-filter-btn active" data-meal-filter="all">全部套餐</button>
						<button class="meal-filter-btn" data-meal-filter="active">已上架</button>
						<button class="meal-filter-btn" data-meal-filter="inactive">已下架</button>
						<button class="meal-filter-btn" data-meal-filter="delivery">支持宅急送</button>
						<button class="meal-filter-btn" data-meal-filter="no-delivery">仅自提</button>
					</div>

					<!-- 套餐列表区域 -->
					<div id="mealListSection">
						<div class="meal-list" id="mealList">
						</div>
						<div class="no-meals-message" id="noMealsAdminMessage">
							<i class="fas fa-utensils"></i>
							<h3>暂无套餐</h3>
							<p>点击"添加套餐"标签创建新套餐</p>
						</div>
					</div>

					<!-- 编辑套餐表单区域 -->
					<div class="edit-form-container" id="editMealFormContainer">
						<h3 class="section-title" id="editMealTitle">
							<i class="fas fa-edit"></i>
							编辑套餐
						</h3>

						<div class="meal-form">
							<input type="hidden" id="currentMealId" value="">

							<div class="form-row">
								<div class="form-group">
									<label class="form-label">套餐名称 <span class="required">*</span></label>
									<input type="text" class="form-input" id="mealName" placeholder="例如：【12-8】自提/宅急送12件套89.9元" required>
								</div>

								<div class="form-group">
									<label class="form-label">套餐价格 <span class="required">*</span></label>
									<input type="number" class="form-input" id="mealPrice" placeholder="例如：89.9" min="0" step="0.01" required>
								</div>
							</div>

							<div class="form-row">
								<div class="form-group">
									<label class="form-label">排序顺序 <span class="required">*</span></label>
									<input type="number" class="form-input" id="mealOrder" placeholder="数字越小越靠前，例如：1" min="0" step="1" value="9999">
									<div class="form-hint">
										<i class="fas fa-lightbulb"></i> 数字越小显示越靠前，默认9999（最后）
									</div>
								</div>

								<div class="form-group">
									<label class="form-label">套餐标签 <span class="required">*</span></label>
									<input type="text" class="form-input" id="mealTags" placeholder="用逗号分隔，例如：自提/宅急送,3人餐,12件套" required>
									<div class="form-hint">
										<i class="fas fa-lightbulb"></i> 标签将显示在套餐卡片上，用逗号分隔多个标签
									</div>
								</div>
							</div>

							<div class="form-row">
								<div class="form-group">
									<label class="form-label">套餐描述 <span class="required">*</span></label>
									<input type="text" class="form-input" id="mealDescription" placeholder="例如：适合3人享用，自提/宅急送都可用" required>
								</div>

								<div class="form-group">
									<label class="form-label">套餐状态</label>
									<div class="status-label">
										<label class="status-toggle">
											<input type="checkbox" id="mealActive" checked>
											<span class="status-slider"></span>
										</label>
										<span id="statusText" class="status-active">上架</span>
									</div>
									<div class="form-hint">
										<i class="fas fa-lightbulb"></i> 上架的套餐会在用户端显示，下架的套餐不会显示
									</div>
								</div>
							</div>

							<!-- 新增：是否支持宅急送 -->
							<div class="form-row">
								<div class="form-group">
									<label class="form-label">是否支持宅急送</label>
									<div class="status-label">
										<label class="status-toggle">
											<input type="checkbox" id="mealSupportDelivery" checked>
											<span class="status-slider"></span>
										</label>
										<span id="supportDeliveryText" class="status-active">支持</span>
									</div>
									<div class="form-hint">
										<i class="fas fa-lightbulb"></i> 支持的套餐可以选择宅急送配送，不支持的套餐只能到店自提
									</div>
								</div>
							</div>

							<h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
								<i class="fas fa-list"></i>
								选项组管理
							</h4>

							<div class="option-groups-management" id="optionGroupsManagement">
							</div>

							<button class="add-btn action-btn" id="addOptionGroupBtn">
								<i class="fas fa-plus"></i> 添加选项组
							</button>

							<h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
								<i class="fas fa-th-list"></i>
								固定搭配管理（可选）
							</h4>

							<div class="fixed-items-management" id="fixedItemsManagement">
							</div>

							<button class="add-btn action-btn" id="addFixedItemBtn">
								<i class="fas fa-plus"></i> 添加固定搭配项
							</button>

							<div style="margin-top: 20px; display: flex; gap: 12px;">
								<button class="add-btn action-btn" id="saveMealBtn" style="padding: 10px 25px;">
									<i class="fas fa-save"></i> 保存套餐
								</button>
								<button class="filter-btn" id="cancelEditBtn" style="padding: 10px 25px;">
									<i class="fas fa-arrow-left"></i> 返回列表
								</button>
							</div>
						</div>
					</div>
				</div>

				<div id="addMealTab" class="admin-tab-content">
					<h3 class="section-title" id="addMealTitle">
						<i class="fas fa-plus-circle"></i>
						添加新套餐
					</h3>

					<div class="meal-form" id="addMealForm">
						<div class="form-row">
							<div class="form-group">
								<label class="form-label">套餐名称 <span class="required">*</span></label>
								<input type="text" class="form-input" id="newMealName" placeholder="例如：【12-8】自提/宅急送12件套89.9元" required>
							</div>

							<div class="form-group">
								<label class="form-label">套餐价格 <span class="required">*</span></label>
								<input type="number" class="form-input" id="newMealPrice" placeholder="例如：89.9" min="0" step="0.01" required>
							</div>
						</div>

						<div class="form-row">
							<div class="form-group">
								<label class="form-label">排序顺序 <span class="required">*</span></label>
								<input type="number" class="form-input" id="newMealOrder" placeholder="数字越小越靠前，例如：1" min="0" step="1" value="9999">
								<div class="form-hint">
									<i class="fas fa-lightbulb"></i> 数字越小显示越靠前，默认9999（最后）
								</div>
							</div>

							<div class="form-group">
								<label class="form-label">套餐标签 <span class="required">*</span></label>
								<input type="text" class="form-input" id="newMealTags" placeholder="用逗号分隔，例如：自提/宅急送,3人餐,12件套" required>
								<div class="form-hint">
									<i class="fas fa-lightbulb"></i> 标签将显示在套餐卡片上，用逗号分隔多个标签
								</div>
							</div>
						</div>

						<div class="form-row">
							<div class="form-group">
								<label class="form-label">套餐描述 <span class="required">*</span></label>
								<input type="text" class="form-input" id="newMealDescription" placeholder="例如：适合3人享用，自提/宅急送都可用" required>
							</div>

							<div class="form-group">
								<label class="form-label">套餐状态</label>
								<div class="status-label">
									<label class="status-toggle">
										<input type="checkbox" id="newMealActive" checked>
										<span class="status-slider"></span>
									</label>
									<span id="newStatusText" class="status-active">上架</span>
								</div>
								<div class="form-hint">
									<i class="fas fa-lightbulb"></i> 上架的套餐会在用户端显示，下架的套餐不会显示
								</div>
							</div>
						</div>

						<!-- 新增：是否支持宅急送 -->
						<div class="form-row">
							<div class="form-group">
								<label class="form-label">是否支持宅急送</label>
								<div class="status-label">
									<label class="status-toggle">
										<input type="checkbox" id="newMealSupportDelivery" checked>
										<span class="status-slider"></span>
									</label>
									<span id="newSupportDeliveryText" class="status-active">支持</span>
								</div>
								<div class="form-hint">
									<i class="fas fa-lightbulb"></i> 支持的套餐可以选择宅急送配送，不支持的套餐只能到店自提
								</div>
							</div>
						</div>

						<h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
							<i class="fas fa-list"></i>
							选项组管理
						</h4>

						<div class="option-groups-management" id="newOptionGroupsManagement">
						</div>

						<button class="add-btn action-btn" id="newAddOptionGroupBtn">
							<i class="fas fa-plus"></i> 添加选项组
						</button>

						<h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
							<i class="fas fa-th-list"></i>
							固定搭配管理（可选）
						</h4>

						<div class="fixed-items-management" id="newFixedItemsManagement">
						</div>

						<button class="add-btn action-btn" id="newAddFixedItemBtn">
							<i class="fas fa-plus"></i> 添加固定搭配项
						</button>

						<div style="margin-top: 20px;">
							<button class="add-btn action-btn" id="saveNewMealBtn" style="padding: 10px 25px; width: 100%;">
								<i class="fas fa-plus-circle"></i> 添加新套餐
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 图片预览模态框 -->
		<div class="image-modal" id="imageModal">
			<button class="close-modal" id="closeModal">
				<i class="fas fa-times"></i>
			</button>
			<img class="modal-image" id="modalImage" src="" alt="预览图片">
		</div>

		<script>
			// ==================== LeanCloud 配置 ====================
			const APP_ID = 'Tu8MLJ2PHUY0z4Kgol3hockE-gzGzoHsz';
			const APP_KEY = '7sdmY7swmMFU9ppvBGheW4oz';
			const SERVER_URL = 'https://tu8mlj2p.lc-cn-n1-shared.com';

			// 初始化 LeanCloud
			AV.init({
				appId: APP_ID,
				appKey: APP_KEY,
				serverURLs: SERVER_URL || 'https://tu8mlj2p.lc-cn-n1-shared.com'
			});

			// ==================== 全局变量 ====================
			let meals = [];
			let cart = [];
			let orders = [];
			let newOrdersCount = 0;
			const ADMIN_PASSWORD = "200104";

			// 实时更新相关变量
			let adminPollingInterval = null;
			let globalPollingInterval = null;
			let isAdminPanelOpen = false;
			let lastOrderUpdateTime = 0;
			let lastUserOrderUpdateTime = Date.now();
			let lastGlobalCheckTime = Date.now();

			// 用户标识符
			let currentUserId = localStorage.getItem('kfcUserId');

			if (!currentUserId) {
				currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
				localStorage.setItem('kfcUserId', currentUserId);
			}

			// ==================== 新增：分享链接进入状态 ====================
			let isSharedLink = false; // 是否通过分享链接进入
			let sharedMealId = ''; // 分享链接中的套餐ID

			// ==================== 全局加载状态管理 ====================
			let isLoading = false;

			// 显示加载动画
			function showLoading(text = '处理中...') {
				if (!isLoading) {
					isLoading = true;
					const loadingOverlay = document.getElementById('globalLoading');
					const loadingText = document.getElementById('loadingText');
					loadingText.textContent = text;
					loadingOverlay.classList.add('active');
					document.body.style.overflow = 'hidden';
				}
			}

			// 隐藏加载动画
			function hideLoading() {
				if (isLoading) {
					isLoading = false;
					const loadingOverlay = document.getElementById('globalLoading');
					loadingOverlay.classList.remove('active');
					document.body.style.overflow = 'auto';
				}
			}

			// 显示实时更新指示器
			function showRealtimeIndicator(message = '实时更新中...') {
				const indicator = document.getElementById('realtimeIndicator');
				const indicatorSpan = indicator.querySelector('span');
				indicatorSpan.textContent = message;
				indicator.style.display = 'flex';

				setTimeout(() => {
					indicator.style.display = 'none';
				}, 3000);
			}

			// ==================== LeanCloud 数据操作类 ====================
			class LeanCloudData {
				static async loadMeals() {
					try {
						const query = new AV.Query('Meals');
						query.descending('createdAt');
						const results = await query.find();
						return results.map(item => {
							const data = item.toJSON();
							const createdAt = item.createdAt ? item.createdAt.getTime() : Date.now();
							const updatedAt = item.updatedAt ? item.updatedAt.getTime() : Date.now();
							return {
								id: data.id || item.id,
								name: data.name,
								price: data.price,
								tags: data.tags || [],
								description: data.description,
								order: data.order || 9999,
								active: data.active !== false,
								supportDelivery: data.supportDelivery !== false,
								optionGroups: data.optionGroups || [],
								fixedItems: data.fixedItems || [],
								createdAt: createdAt,
								updatedAt: updatedAt,
								objectId: item.id
							};
						});
					} catch (error) {
						console.error('加载套餐数据失败:', error);
						return [];
					}
				}

				static async saveMeal(meal) {
					try {
						const Meal = AV.Object.extend('Meals');
						let mealObj;

						if (meal.objectId) {
							mealObj = AV.Object.createWithoutData('Meals', meal.objectId);
						} else {
							mealObj = new Meal();
						}

						mealObj.set('id', meal.id);
						mealObj.set('name', meal.name);
						mealObj.set('price', meal.price);
						mealObj.set('tags', meal.tags);
						mealObj.set('description', meal.description);
						mealObj.set('order', meal.order || 9999);
						mealObj.set('active', meal.active !== false);
						mealObj.set('supportDelivery', meal.supportDelivery !== false);
						mealObj.set('optionGroups', meal.optionGroups || []);
						mealObj.set('fixedItems', meal.fixedItems || []);

						const result = await mealObj.save();

						const createdAt = result.createdAt ? result.createdAt.getTime() : Date.now();
						const updatedAt = result.updatedAt ? result.updatedAt.getTime() : Date.now();

						return {
							id: meal.id,
							name: meal.name,
							price: meal.price,
							tags: meal.tags,
							description: meal.description,
							order: meal.order || 9999,
							active: meal.active !== false,
							supportDelivery: meal.supportDelivery !== false,
							optionGroups: meal.optionGroups || [],
							fixedItems: meal.fixedItems || [],
							createdAt: createdAt,
							updatedAt: updatedAt,
							objectId: result.id
						};
					} catch (error) {
						console.error('保存套餐失败:', error);
						throw error;
					}
				}

				static async deleteMeal(mealId) {
					try {
						const query = new AV.Query('Meals');
						query.equalTo('id', mealId);
						const result = await query.first();

						if (result) {
							await result.destroy();
							return true;
						}
						return false;
					} catch (error) {
						console.error('删除套餐失败:', error);
						throw error;
					}
				}

				static async loadOrders() {
					try {
						const query = new AV.Query('Orders');
						query.descending('createdAt');
						const results = await query.find();
						return results.map(item => {
							const data = item.toJSON();
							const createdAt = item.createdAt ? item.createdAt.getTime() : Date.now();
							const updatedAt = item.updatedAt ? item.updatedAt.getTime() : Date.now();
							return {
								id: data.id,
								timestamp: data.timestamp,
								status: data.status || 'new',
								cart: data.cart || [],
								deliveryInfo: data.deliveryInfo,
								orderNote: data.orderNote || '',
								deliveryType: data.deliveryType,
								totalPrice: data.totalPrice,
								hasScreenshot: data.hasScreenshot || false,
								screenshotData: data.screenshotData,
								feedbackScreenshotData: data.feedbackScreenshotData || null,
								userId: data.userId,
								createdAt: createdAt,
								updatedAt: updatedAt,
								objectId: item.id
							};
						});
					} catch (error) {
						console.error('加载订单数据失败:', error);
						return [];
					}
				}

				static async saveOrder(order) {
					try {
						const Order = AV.Object.extend('Orders');
						let orderObj;

						if (order.objectId) {
							orderObj = AV.Object.createWithoutData('Orders', order.objectId);
						} else {
							orderObj = new Order();
						}

						orderObj.set('id', order.id);
						orderObj.set('timestamp', order.timestamp);
						orderObj.set('status', order.status || 'new');
						orderObj.set('cart', order.cart);
						orderObj.set('deliveryInfo', order.deliveryInfo);
						orderObj.set('orderNote', order.orderNote || '');
						orderObj.set('deliveryType', order.deliveryType);
						orderObj.set('totalPrice', order.totalPrice);
						orderObj.set('userId', order.userId);

						if (order.hasScreenshot && order.screenshotData) {
							orderObj.set('hasScreenshot', true);
							orderObj.set('screenshotData', order.screenshotData);
						} else {
							orderObj.set('hasScreenshot', false);
						}

						if (order.feedbackScreenshotData) {
							orderObj.set('feedbackScreenshotData', order.feedbackScreenshotData);
						}

						const result = await orderObj.save();

						const createdAt = result.createdAt ? result.createdAt.getTime() : Date.now();
						const updatedAt = result.updatedAt ? result.updatedAt.getTime() : Date.now();

						return {
							id: order.id,
							timestamp: order.timestamp,
							status: order.status || 'new',
							cart: order.cart,
							deliveryInfo: order.deliveryInfo,
							orderNote: order.orderNote || '',
							deliveryType: order.deliveryType,
							pickupType: order.pickupType || '',
							totalPrice: order.totalPrice,
							hasScreenshot: order.hasScreenshot || false,
							screenshotData: order.screenshotData,
							feedbackScreenshotData: order.feedbackScreenshotData || null,
							userId: order.userId,
							createdAt: createdAt,
							updatedAt: updatedAt,
							objectId: result.id
						};
					} catch (error) {
						console.error('保存订单失败:', error);
						throw error;
					}
				}

				static async deleteOrder(orderId) {
					try {
						const query = new AV.Query('Orders');
						query.equalTo('id', orderId);
						const result = await query.first();

						if (result) {
							await result.destroy();
							return true;
						}
						return false;
					} catch (error) {
						console.error('删除订单失败:', error);
						throw error;
					}
				}

				static async loadNewOrdersCount() {
					try {
						const query = new AV.Query('Counter');
						query.equalTo('type', 'newOrdersCount');
						const result = await query.first();

						if (result) {
							return result.get('count') || 0;
						} else {
							const Counter = AV.Object.extend('Counter');
							const counter = new Counter();
							counter.set('type', 'newOrdersCount');
							counter.set('count', 0);
							await counter.save();
							return 0;
						}
					} catch (error) {
						console.error('加载新订单计数失败:', error);
						return 0;
					}
				}

				static async updateNewOrdersCount(count) {
					try {
						const Counter = AV.Object.extend('Counter');
						const query = new AV.Query('Counter');
						query.equalTo('type', 'newOrdersCount');
						const result = await query.first();

						let counter;
						if (result) {
							counter = result;
						} else {
							counter = new Counter();
							counter.set('type', 'newOrdersCount');
						}

						counter.set('count', count);
						await counter.save();
						console.log('新订单计数更新成功:', count);
						return true;
					} catch (error) {
						console.error('更新新订单计数失败:', error);
						throw error;
					}
				}

				static async initializeTables() {
					try {
						const mealsQuery = new AV.Query('Meals');
						const mealsCount = await mealsQuery.count();
						console.log('Meals表记录数:', mealsCount);

						const ordersQuery = new AV.Query('Orders');
						const ordersCount = await ordersQuery.count();
						console.log('Orders表记录数:', ordersCount);

						return true;
					} catch (error) {
						console.log('初始化表（LeanCloud会自动创建不存在的表）');
						return true;
					}
				}

				static async checkForNewOrders(sinceTime, userId = null) {
					try {
						const query = new AV.Query('Orders');
						query.greaterThan('createdAt', new Date(sinceTime));
						if (userId) {
							query.equalTo('userId', userId);
						}
						query.descending('createdAt');
						const results = await query.find();

						return results.map(item => {
							const data = item.toJSON();
							const createdAt = item.createdAt ? item.createdAt.getTime() : Date.now();
							const updatedAt = item.updatedAt ? item.updatedAt.getTime() : Date.now();
							return {
								id: data.id,
								timestamp: data.timestamp,
								status: data.status || 'new',
								cart: data.cart || [],
								deliveryInfo: data.deliveryInfo,
								orderNote: data.orderNote || '',
								deliveryType: data.deliveryType,
								totalPrice: data.totalPrice,
								hasScreenshot: data.hasScreenshot || false,
								screenshotData: data.screenshotData,
								feedbackScreenshotData: data.feedbackScreenshotData || null,
								userId: data.userId,
								createdAt: createdAt,
								updatedAt: updatedAt,
								objectId: item.id
							};
						});
					} catch (error) {
						console.error('检查新订单失败:', error);
						return [];
					}
				}

				static async checkNewOrdersCountOnly() {
					try {
						const query = new AV.Query('Counter');
						query.equalTo('type', 'newOrdersCount');
						const result = await query.first();

						if (result) {
							return result.get('count') || 0;
						}
						return 0;
					} catch (error) {
						console.error('检查新订单计数失败:', error);
						return 0;
					}
				}

				static async quickSaveOrder(order) {
					try {
						const Order = AV.Object.extend('Orders');
						const orderObj = new Order();

						orderObj.set('id', order.id);
						orderObj.set('timestamp', order.timestamp);
						orderObj.set('status', order.status || 'new');
						orderObj.set('cart', order.cart);
						orderObj.set('deliveryInfo', order.deliveryInfo);
						orderObj.set('orderNote', order.orderNote || '');
						orderObj.set('deliveryType', order.deliveryType);
						orderObj.set('totalPrice', order.totalPrice);
						orderObj.set('userId', order.userId);

						if (order.hasScreenshot && order.screenshotData) {
							orderObj.set('hasScreenshot', true);
							orderObj.set('screenshotData', order.screenshotData);
						} else {
							orderObj.set('hasScreenshot', false);
						}

						if (order.feedbackScreenshotData) {
							orderObj.set('feedbackScreenshotData', order.feedbackScreenshotData);
						}

						orderObj.save().then(result => {
							console.log('订单快速保存成功:', order.id);
						}).catch(error => {
							console.error('订单快速保存失败:', error);
						});

						return Promise.resolve({
							id: order.id,
							timestamp: order.timestamp,
							status: order.status || 'new',
							cart: order.cart,
							deliveryInfo: order.deliveryInfo,
							orderNote: order.orderNote || '',
							deliveryType: order.deliveryType,
							pickupType: order.pickupType || '',
							totalPrice: order.totalPrice,
							hasScreenshot: order.hasScreenshot || false,
							screenshotData: order.screenshotData,
							feedbackScreenshotData: order.feedbackScreenshotData || null,
							userId: order.userId,
							createdAt: Date.now(),
							updatedAt: Date.now(),
							objectId: 'pending_' + order.id
						});
					} catch (error) {
						console.error('快速保存订单失败:', error);
						return Promise.resolve({
							id: order.id,
							timestamp: order.timestamp,
							status: order.status || 'new',
							cart: order.cart,
							deliveryInfo: order.deliveryInfo,
							orderNote: order.orderNote || '',
							deliveryType: order.deliveryType,
							pickupType: order.pickupType || '',
							totalPrice: order.totalPrice,
							hasScreenshot: order.hasScreenshot || false,
							screenshotData: order.screenshotData,
							feedbackScreenshotData: order.feedbackScreenshotData || null,
							userId: order.userId,
							createdAt: Date.now(),
							updatedAt: Date.now(),
							objectId: 'local_' + order.id
						});
					}
				}

				static async checkForOrderUpdates(sinceTime, userId) {
					try {
						const query = new AV.Query('Orders');
						query.greaterThan('updatedAt', new Date(sinceTime));
						query.equalTo('userId', userId);
						query.descending('updatedAt');
						const results = await query.find();

						return results.map(item => {
							const data = item.toJSON();
							const createdAt = item.createdAt ? item.createdAt.getTime() : Date.now();
							const updatedAt = item.updatedAt ? item.updatedAt.getTime() : Date.now();
							return {
								id: data.id,
								timestamp: data.timestamp,
								status: data.status || 'new',
								cart: data.cart || [],
								deliveryInfo: data.deliveryInfo,
								orderNote: data.orderNote || '',
								deliveryType: data.deliveryType,
								totalPrice: data.totalPrice,
								hasScreenshot: data.hasScreenshot || false,
								screenshotData: data.screenshotData,
								feedbackScreenshotData: data.feedbackScreenshotData || null,
								userId: data.userId,
								createdAt: createdAt,
								updatedAt: updatedAt,
								objectId: item.id
							};
						});
					} catch (error) {
						console.error('检查订单更新失败:', error);
						return [];
					}
				}
			}

			// ==================== 图片压缩函数 ====================
			async function compressImageOptimized(file, progressElement = null) {
				return new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.readAsDataURL(file);
					reader.onload = function(event) {
						const img = new Image();
						img.src = event.target.result;
						img.onload = function() {
							const canvas = document.createElement('canvas');
							let width = img.width;
							let height = img.height;

							let maxWidth = 800;
							let quality = 0.7;

							if (file.size > 2 * 1024 * 1024) {
								maxWidth = 600;
								quality = 0.5;
							} else if (file.size > 1 * 1024 * 1024) {
								maxWidth = 700;
								quality = 0.6;
							}

							if (width > maxWidth) {
								height = Math.round((height * maxWidth) / width);
								width = maxWidth;

								if (progressElement) {
									progressElement.textContent = '50%';
								}
							}

							canvas.width = width;
							canvas.height = height;

							const ctx = canvas.getContext('2d');
							ctx.drawImage(img, 0, 0, width, height);

							if (progressElement) {
								progressElement.textContent = '75%';
							}

							canvas.toBlob(function(blob) {
								if (progressElement) {
									progressElement.textContent = '100%';
								}
								resolve(blob);
							}, file.type, quality);
						};
						img.onerror = reject;
					};
					reader.onerror = reject;
				});
			}

			// ==================== 页面初始化 ====================
			document.addEventListener('DOMContentLoaded', async function() {
				try {
					showLoading('正在加载数据...');

					await Promise.all([
						LeanCloudData.initializeTables().catch(e => console.log('表初始化失败:', e)),
						loadAllDataFromLeanCloud().catch(e => {
							console.error('数据加载失败:', e);
							showNotification('数据加载失败，使用本地缓存数据', 'error');
							loadFromLocalCache();
						})
					]);

					initHomePage();
					initAdminPanel();
					initMealManagement();
					initNewMealManagement();
					updateCartDisplay();
					updateOrderBadge();
					initImagePreview();
					initPasswordVerification();
					initStatusToggle();
					initMyOrdersPage();
					initHeaderButtons();
					initSearchFunction();
					initOrderConfirmModal();
					initShareModal();

					document.getElementById('currentUserIdDisplay').textContent = currentUserId.substring(0, 12) + '...';

					checkUrlParams();

					showNotification('页面加载完成', 'success');
					hideLoading();

					console.log('页面初始化完成，数据已从LeanCloud加载');

					startGlobalPolling();
				} catch (error) {
					console.error('页面初始化失败:', error);
					showNotification('页面初始化失败，使用本地缓存数据', 'error');
					hideLoading();

					loadFromLocalCache();

					initHomePage();
					initAdminPanel();
					initMealManagement();
					initNewMealManagement();
					updateCartDisplay();
					updateOrderBadge();
					initImagePreview();
					initPasswordVerification();
					initStatusToggle();
					initMyOrdersPage();
					initHeaderButtons();
					initSearchFunction();
					initOrderConfirmModal();
					initShareModal();

					startGlobalPolling();
				}
			});

			// ==================== 新增：初始化分享模态框 ====================
			function initShareModal() {
				const shareModal = document.getElementById('shareModal');
				const closeShareBtn = document.getElementById('closeShareBtn');
				const copyLinkBtn = document.getElementById('copyLinkBtn');

				closeShareBtn.addEventListener('click', function() {
					shareModal.classList.remove('active');
					document.body.style.overflow = 'auto';
				});

				shareModal.addEventListener('click', function(e) {
					if (e.target === shareModal) {
						shareModal.classList.remove('active');
						document.body.style.overflow = 'auto';
					}
				});

				copyLinkBtn.addEventListener('click', function() {
					const shareLink = document.getElementById('shareLink');
					const copyStatus = document.getElementById('copyStatus');

					const textToCopy = shareLink.textContent;
					navigator.clipboard.writeText(textToCopy).then(function() {
						copyStatus.classList.add('show');

						setTimeout(function() {
							copyStatus.classList.remove('show');
						}, 2000);

						setTimeout(function() {
							shareModal.classList.remove('active');
							document.body.style.overflow = 'auto';
						}, 1000);
					}).catch(function(err) {
						console.error('复制失败: ', err);
						showNotification('复制失败，请手动复制链接', 'error');
					});
				});
			}

			// ==================== 新增：分享套餐功能 ====================
			function shareMeal(mealId) {
				const meal = meals.find(m => m.id === mealId);
				if (!meal) {
					showNotification('套餐不存在或已被删除', 'error');
					return;
				}

				currentShareMealId = mealId;

				const shareUrl = `${window.location.origin}${window.location.pathname}?meal=${mealId}`;

				const shareLink = document.getElementById('shareLink');
				const shareModal = document.getElementById('shareModal');
				const copyStatus = document.getElementById('copyStatus');

				shareLink.textContent = shareUrl;
				copyStatus.classList.remove('show');

				shareModal.classList.add('active');
				document.body.style.overflow = 'hidden';

				document.title = `分享：${meal.name} - 肯德基自助点餐系统`;
			}

			// ==================== 修改：检查URL参数 ====================
			function checkUrlParams() {
				const urlParams = new URLSearchParams(window.location.search);
				const orderId = urlParams.get('order');
				const mealId = urlParams.get('meal');

				// 检查订单参数
				if (orderId) {
					showMyOrdersPage();

					setTimeout(() => {
						document.getElementById('orderSearchInput').value = orderId;
						searchUserOrder(orderId);
					}, 100);
				}

				// 检查套餐参数
				if (mealId) {
					const meal = meals.find(m => m.id === mealId);
					if (meal && meal.active !== false) {
						// 标记为分享链接进入
						isSharedLink = true;
						sharedMealId = mealId;

						// 直接显示套餐详情页
						setTimeout(() => {
							showMealDetail(mealId);
						}, 300);
					} else if (meal && meal.active === false) {
						showNotification('该套餐已下架，无法查看', 'error');
					} else {
						showNotification('套餐不存在或已被删除', 'error');
					}
				}
			}

			// ==================== 订单确认模态框初始化 ====================
			function initOrderConfirmModal() {
				const orderConfirmModal = document.getElementById('orderConfirmModal');
				const orderConfirmClose = document.getElementById('orderConfirmClose');
				const orderConfirmCancel = document.getElementById('orderConfirmCancel');
				const orderConfirmSubmit = document.getElementById('orderConfirmSubmit');

				orderConfirmClose.addEventListener('click', function() {
					orderConfirmModal.classList.remove('active');
					document.body.style.overflow = 'auto';
				});

				orderConfirmCancel.addEventListener('click', function() {
					orderConfirmModal.classList.remove('active');
					document.body.style.overflow = 'auto';
				});

				orderConfirmModal.addEventListener('click', function(e) {
					if (e.target === orderConfirmModal) {
						orderConfirmModal.classList.remove('active');
						document.body.style.overflow = 'auto';
					}
				});
			}

			// ==================== 美化订单确认信息 ====================
			function showOrderConfirm(orderData) {
				const orderConfirmModal = document.getElementById('orderConfirmModal');
				const orderConfirmBody = document.getElementById('orderConfirmBody');
				const orderConfirmSubmit = document.getElementById('orderConfirmSubmit');

				document.body.style.overflow = 'hidden';

				let totalPrice = 0;
				cart.forEach(item => {
					totalPrice += item.totalPrice;
				});

				let itemsHTML = '';
				cart.forEach((item, index) => {
					const optionCount = {};
					item.options.forEach(option => {
						optionCount[option] = (optionCount[option] || 0) + 1;
					});

					const optionText = Object.keys(optionCount).map(option => {
						const count = optionCount[option];
						return `${option}${count > 1 ? ` ×${count}` : ''}`;
					}).join(', ');

					itemsHTML +=
						`
                    <div class="order-confirm-option">
                        <span>${item.name} (${optionText})</span>
                        <span>¥${item.totalPrice.toFixed(2)}</span>
                    </div>
                `;
				});

				let deliveryInfoHTML = '';
				const infoLines = orderData.deliveryInfo.split('\n');
				infoLines.forEach(line => {
					if (line.trim()) {
						deliveryInfoHTML += `<div>${line}</div>`;
					}
				});

				const orderConfirmHTML =
					`
                <div class="order-confirm-item">
                    <div class="order-confirm-item-title">
                        <i class="fas fa-shopping-cart"></i>
                        订单详情
                    </div>
                    <div class="order-confirm-item-content">
                        <div class="order-confirm-options">
                            ${itemsHTML}
                        </div>
                    </div>
                </div>
                
                <div class="order-confirm-item">
                    <div class="order-confirm-item-title">
                        <i class="fas fa-truck"></i>
                        配送信息
                    </div>
                    <div class="order-confirm-item-content">
                        ${deliveryInfoHTML}
                        ${orderData.orderNote ? `<div><strong>备注：</strong>${orderData.orderNote}</div>` : ''}
                    </div>
                </div>
                
                <div class="order-confirm-item">
                    <div class="order-confirm-item-title">
                        <i class="fas fa-clock"></i>
                        订单时间
                    </div>
                    <div class="order-confirm-item-content">
                        ${orderData.timestamp}
                    </div>
                </div>
                
                <div class="order-confirm-total">
                    订单总计：<span style="font-size:1.1em; color: #e31837;">¥${totalPrice.toFixed(2)}</span>
                </div>
                
                <div class="highlight" style="margin-top: 10px; padding: 6px; font-size: 0.8rem;">
                    <i class="fas fa-info-circle"></i>
                    提交订单后，您可以在"查看我的订单"页面查看订单状态
                </div>
            `;

				orderConfirmBody.innerHTML = orderConfirmHTML;

				orderConfirmSubmit.onclick = function() {
					orderConfirmModal.classList.remove('active');
					document.body.style.overflow = 'auto';
					setTimeout(() => {
						completeOrderSubmission(orderData);
					}, 300);
				};

				orderConfirmModal.classList.add('active');
			}

			// ==================== 全局轮询函数 ====================
			function startGlobalPolling() {
				if (globalPollingInterval) {
					clearInterval(globalPollingInterval);
				}

				globalPollingInterval = setInterval(async () => {
					try {
						const newCount = await LeanCloudData.checkNewOrdersCountOnly();
						if (newCount !== newOrdersCount) {
							newOrdersCount = newCount;
							updateOrderBadge();

							showRealtimeIndicator('检测到新订单！');

							console.log('全局轮询检测到新订单，数量：', newOrdersCount);

							if (isAdminPanelOpen) {
								const activeFilterBtn = document.querySelector('.filter-btn.active');
								const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
								await renderOrders(activeFilter);
							}
						}

						if (document.getElementById('myOrdersPage').classList.contains('active')) {
							const updatedOrders = await LeanCloudData.checkForOrderUpdates(lastUserOrderUpdateTime - 3000, currentUserId);
							if (updatedOrders.length > 0) {
								lastUserOrderUpdateTime = Date.now();

								updatedOrders.forEach(updatedOrder => {
									const existingIndex = orders.findIndex(o => o.id === updatedOrder.id);
									if (existingIndex !== -1) {
										orders[existingIndex].status = updatedOrder.status;
										orders[existingIndex].feedbackScreenshotData = updatedOrder.feedbackScreenshotData;
										orders[existingIndex].updatedAt = updatedOrder.updatedAt;
									}
								});

								showRealtimeIndicator(`您的订单有更新`);

								const activeFilterTab = document.querySelector('.order-filter-tab.active');
								const activeFilter = activeFilterTab ? activeFilterTab.dataset.orderFilter : 'all';
								renderUserOrders(activeFilter);
							}
						}

						lastGlobalCheckTime = Date.now();
					} catch (error) {
						console.warn('全局轮询检查新订单失败:', error);
					}
				}, 3000);
			}

			function stopGlobalPolling() {
				if (globalPollingInterval) {
					clearInterval(globalPollingInterval);
					globalPollingInterval = null;
				}
			}

			// ==================== 搜索功能初始化 ====================
			function initSearchFunction() {
				// 用户端搜索
				const mealSearchInput = document.getElementById('mealSearchInput');
				const mealSearchBtn = document.getElementById('mealSearchBtn');

				if (mealSearchInput && mealSearchBtn) {
					mealSearchBtn.addEventListener('click', function() {
						searchMeals(mealSearchInput.value.trim());
					});

					mealSearchInput.addEventListener('keypress', function(e) {
						if (e.key === 'Enter') {
							searchMeals(this.value.trim());
						}
					});
				}

				// 管理员端搜索
				const adminMealSearchInput = document.getElementById('adminMealSearchInput');
				const adminMealSearchBtn = document.getElementById('adminMealSearchBtn');

				if (adminMealSearchInput && adminMealSearchBtn) {
					adminMealSearchBtn.addEventListener('click', function() {
						adminSearchMeals(adminMealSearchInput.value.trim());
					});

					adminMealSearchInput.addEventListener('keypress', function(e) {
						if (e.key === 'Enter') {
							adminSearchMeals(this.value.trim());
						}
					});
				}
			}

			// ==================== 搜索套餐功能 ====================
			function searchMeals(searchTerm) {
				const mealGrid = document.getElementById('mealGrid');
				const noMealsMessage = document.getElementById('noMealsMessage');

				mealGrid.innerHTML = '';

				if (!searchTerm) {
					updateHomePage();
					return;
				}

				const activeMeals = meals.filter(meal => meal.active !== false);

				if (activeMeals.length === 0) {
					noMealsMessage.style.display = 'block';
					return;
				}

				noMealsMessage.style.display = 'none';

				const searchTermLower = searchTerm.toLowerCase();

				const filteredMeals = activeMeals.filter(meal => {
					if (meal.name.toLowerCase().includes(searchTermLower)) return true;
					if (meal.id.toLowerCase().includes(searchTermLower)) return true;
					if (meal.price.toString().includes(searchTerm)) return true;
					if (meal.tags && meal.tags.some(tag => tag.toLowerCase().includes(searchTermLower))) return true;
					if (meal.description && meal.description.toLowerCase().includes(searchTermLower)) return true;
					return false;
				});

				if (filteredMeals.length === 0) {
					mealGrid.innerHTML =
						`
                    <div class="no-meals-message">
                        <i class="fas fa-search"></i>
                        <h3>未找到相关套餐</h3>
                        <p>没有找到与"${searchTerm}"相关的套餐</p>
                    </div>
                `;
					return;
				}

				filteredMeals.sort((a, b) => {
					const orderDiff = (a.order || 9999) - (b.order || 9999);
					if (orderDiff !== 0) return orderDiff;
					return (b.createdAt || 0) - (a.createdAt || 0);
				});

				filteredMeals.forEach(meal => {
					const mealCard = document.createElement('a');
					mealCard.href = '#';
					mealCard.className = 'meal-card';
					if (meal.active === false) {
						mealCard.classList.add('inactive');
					}
					mealCard.onclick = function(e) {
						e.preventDefault();
						if (meal.active === false) return;
						showMealDetail(meal.id);
					};

					mealCard.innerHTML =
						`
                    <div class="meal-header">
                        <h4 class="meal-name">${meal.name}</h4>
                        <button class="meal-share-btn" onclick="event.stopPropagation(); shareMeal('${meal.id}')" title="分享套餐">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                    <div class="meal-price">¥${meal.price}</div>
                    <div class="meal-description">
                        ${meal.tags.map(tag => `<span class="meal-tag">${tag}</span>`).join('')}
                        ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'}
                        <p style="margin-top: 8px;">${meal.description}</p>
                    </div>
                `;

					mealGrid.appendChild(mealCard);
				});
			}

			// ==================== 管理员搜索套餐功能 ====================
			function adminSearchMeals(searchTerm) {
				const mealList = document.getElementById('mealList');
				const noMealsAdminMessage = document.getElementById('noMealsAdminMessage');

				mealList.innerHTML = '';

				if (!searchTerm) {
					const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
					updateMealList(activeFilter);
					return;
				}

				const searchTermLower = searchTerm.toLowerCase();

				const filteredMeals = meals.filter(meal => {
					if (meal.name.toLowerCase().includes(searchTermLower)) return true;
					if (meal.id.toLowerCase().includes(searchTermLower)) return true;
					if (meal.price.toString().includes(searchTerm)) return true;
					if (meal.tags && meal.tags.some(tag => tag.toLowerCase().includes(searchTermLower))) return true;
					if (meal.description && meal.description.toLowerCase().includes(searchTermLower)) return true;
					return false;
				});

				if (filteredMeals.length === 0) {
					mealList.innerHTML =
						`
                    <div class="no-meals-message">
                        <i class="fas fa-search"></i>
                        <h3>未找到相关套餐</h3>
                        <p>没有找到与"${searchTerm}"相关的套餐</p>
                    </div>
                `;
					return;
				}

				filteredMeals.sort((a, b) => {
					const orderDiff = (a.order || 9999) - (b.order || 9999);
					if (orderDiff !== 0) return orderDiff;
					return (b.createdAt || 0) - (a.createdAt || 0);
				});

				filteredMeals.forEach(meal => {
					const mealItem = document.createElement('div');
					mealItem.className = 'meal-list-item';

					let totalOptions = 0;
					if (meal.optionGroups && meal.optionGroups.length > 0) {
						meal.optionGroups.forEach(group => {
							if (group.items) {
								totalOptions += group.items.length;
							}
						});
					}

					let totalFixed = 0;
					if (meal.fixedItems && meal.fixedItems.length > 0) {
						meal.fixedItems.forEach(item => {
							totalFixed += item.quantity || 1;
						});
					}

					const createdAt = meal.createdAt ? new Date(meal.createdAt).toLocaleString('zh-CN') : '未知时间';

					const sortControls =
						`
                    <div class="sort-order-container">
                        <label>排序:</label>
                        <input type="number" class="sort-order-input" data-meal-id="${meal.id}" value="${meal.order || 9999}" min="0" step="1">
                        <div class="sort-order-buttons">
                            <button class="sort-order-btn" data-action="move-up" data-meal-id="${meal.id}" title="上移"><i class="fas fa-arrow-up"></i></button>
                            <button class="sort-order-btn" data-action="move-down" data-meal-id="${meal.id}" title="下移"><i class="fas fa-arrow-down"></i></button>
                            <button class="sort-order-btn" data-action="apply-order" data-meal-id="${meal.id}" title="应用排序"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                `;

					mealItem.innerHTML =
						`
                    <div class="meal-list-item-info">
                        <h4>${meal.name} ${meal.active === false ? '<span class="status-inactive">(已下架)</span>' : '<span class="status-active">(已上架)</span>'}</h4>
                        <p><strong>价格:</strong> ¥${meal.price} | <strong>标签:</strong> ${meal.tags.join(', ')}</p>
                        <p><strong>描述:</strong> ${meal.description}</p>
                        <p><strong>配送:</strong> ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'} | 
                           <strong>创建时间:</strong> ${createdAt} | <strong>排序值:</strong> <span class="order-display">${meal.order || 9999}</span></p>
                        <p><strong>选项组:</strong> ${meal.optionGroups ? meal.optionGroups.length : 0} 个 | 
                           <strong>选项项:</strong> ${totalOptions} 个 | 
                           <strong>固定搭配:</strong> ${totalFixed} 项</p>
                    </div>
                    <div class="meal-list-item-actions">
                        <div class="status-label">
                            <label class="status-toggle">
                                <input type="checkbox" class="status-toggle-input" data-meal-id="${meal.id}" ${meal.active !== false ? 'checked' : ''}>
                                <span class="status-slider"></span>
                            </label>
                            <span class="${meal.active !== false ? 'status-active' : 'status-inactive'}">${meal.active !== false ? '上架' : '下架'}</span>
                        </div>
                        ${sortControls}
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn edit-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="action-btn delete-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;

					mealList.appendChild(mealItem);
				});

				document.querySelectorAll('.status-toggle-input').forEach(toggle => {
					toggle.addEventListener('change', async function() {
						const mealId = this.dataset.mealId;
						const isActive = this.checked;
						await toggleMealStatus(mealId, isActive);
					});
				});

				document.querySelectorAll('.edit-btn').forEach(btn => {
					btn.addEventListener('click', function() {
						const mealId = this.dataset.mealId;
						editMeal(mealId);
					});
				});

				document.querySelectorAll('.delete-btn').forEach(btn => {
					btn.addEventListener('click', async function() {
						const mealId = this.dataset.mealId;
						await deleteMeal(mealId);
					});
				});

				document.querySelectorAll('.sort-order-btn').forEach(btn => {
					btn.addEventListener('click', async function() {
						const mealId = this.dataset.mealId;
						const action = this.dataset.action;
						await handleSortAction(action, mealId);
					});
				});

				document.querySelectorAll('.sort-order-input').forEach(input => {
					input.addEventListener('change', async function() {
						const mealId = this.dataset.mealId;
						const newOrder = parseInt(this.value) || 9999;
						await updateMealOrder(mealId, newOrder);
					});
				});
			}

			// ==================== 数据加载函数 ====================
			async function loadAllDataFromLeanCloud() {
				try {
					const [mealsData, ordersData, countData] = await Promise.all([
						LeanCloudData.loadMeals(),
						LeanCloudData.loadOrders(),
						LeanCloudData.loadNewOrdersCount()
					]);

					meals = mealsData;
					orders = ordersData;
					newOrdersCount = countData;

					localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
						id: m.id,
						name: m.name,
						price: m.price,
						tags: m.tags,
						description: m.description,
						order: m.order,
						active: m.active,
						supportDelivery: m.supportDelivery
					}))));

					localStorage.setItem('kfcOrdersCache', JSON.stringify(orders.map(o => ({
						id: o.id,
						timestamp: o.timestamp,
						status: o.status,
						totalPrice: o.totalPrice,
						userId: o.userId
					}))));

					localStorage.setItem('newOrdersCountCache', newOrdersCount.toString());

					console.log('数据加载完成:', {
						套餐数: meals.length,
						订单数: orders.length,
						新订单计数: newOrdersCount
					});
				} catch (error) {
					console.error('加载数据失败:', error);
					throw error;
				}
			}

			function loadFromLocalCache() {
				const mealsCache = localStorage.getItem('kfcMealsCache');
				const ordersCache = localStorage.getItem('kfcOrdersCache');
				const countCache = localStorage.getItem('newOrdersCountCache');

				if (mealsCache) {
					try {
						const parsedMeals = JSON.parse(mealsCache);
						meals = parsedMeals.map(meal => ({
							...meal,
							supportDelivery: meal.supportDelivery !== false
						}));
					} catch (e) {
						meals = [];
					}
				}

				if (ordersCache) {
					try {
						orders = JSON.parse(ordersCache);
					} catch (e) {
						orders = [];
					}
				}

				if (countCache) {
					try {
						newOrdersCount = parseInt(countCache) || 0;
					} catch (e) {
						newOrdersCount = 0;
					}
				}
			}

			// ==================== 首页功能 ====================
			function initHomePage() {
				updateHomePage();
			}

			function updateHomePage() {
				const mealGrid = document.getElementById('mealGrid');
				const noMealsMessage = document.getElementById('noMealsMessage');
				const mealSearchInput = document.getElementById('mealSearchInput');

				if (mealSearchInput && mealSearchInput.value.trim()) {
					searchMeals(mealSearchInput.value.trim());
					return;
				}

				mealGrid.innerHTML = '';

				const activeMeals = meals
					.filter(meal => meal.active !== false)
					.sort((a, b) => {
						const orderDiff = (a.order || 9999) - (b.order || 9999);
						if (orderDiff !== 0) return orderDiff;
						return (b.createdAt || 0) - (a.createdAt || 0);
					});

				if (activeMeals.length === 0) {
					noMealsMessage.style.display = 'block';
					return;
				}

				noMealsMessage.style.display = 'none';

				activeMeals.forEach(meal => {
					const mealCard = document.createElement('a');
					mealCard.href = '#';
					mealCard.className = 'meal-card';
					if (meal.active === false) {
						mealCard.classList.add('inactive');
					}
					mealCard.onclick = function(e) {
						e.preventDefault();
						if (meal.active === false) return;
						showMealDetail(meal.id);
					};

					mealCard.innerHTML =
						`
                    <div class="meal-header">
                        <h4 class="meal-name">${meal.name}</h4>
                        <button class="meal-share-btn" onclick="event.stopPropagation(); shareMeal('${meal.id}')" title="分享套餐">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                    <div class="meal-price">¥${meal.price}</div>
                    <div class="meal-description">
                        ${meal.tags.map(tag => `<span class="meal-tag">${tag}</span>`).join('')}
                        ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'}
                        <p style="margin-top: 8px;">${meal.description}</p>
                    </div>
                `;

					mealGrid.appendChild(mealCard);
				});
			}

			// ==================== 套餐详情页 ====================
			function showMealDetail(mealId) {
				const meal = meals.find(m => m.id === mealId);
				if (!meal) return;

				const mealDetailPage = document.getElementById('mealDetailPage');

				mealDetailPage.innerHTML =
					`
                ${!isSharedLink ? `
                <a href="#" class="back-btn" onclick="showPage('homePage')">
                    <i class="fas fa-arrow-left"></i>
                    返回套餐列表
                </a>
                ` : ''}
                
                <div class="main-content">
                    <div class="menu-section">
                        <div class="meal-detail-header">
                            <h2 class="section-title" style="margin-bottom: 0;">
                                <i class="fas fa-hamburger"></i>
                                ${meal.name}
                            </h2>
                        </div>
                        
                        <div class="highlight">
                            <i class="fas fa-info-circle"></i>
                            ${meal.supportDelivery === false ? '此套餐仅支持到店自提（堂食/打包）' : '此套餐支持宅急送配送和到店自提'}
                        </div>
                        
                        <div class="instructions">
                            <p><strong>套餐详情：</strong></p>
                            <ul>
                                <li>${meal.description}</li>
                                <li>请按照要求选择选项</li>
                                <li>提交订单后可在右上角"查看我的订单"查看订单状态</li>
                                ${!isSharedLink ? '<li>套餐卡片上的分享按钮可以将套餐分享给朋友</li>' : ''}
                            </ul>
                        </div>
                        
                        <div class="meal-options" id="mealOptions">
                            ${generateOptionsHTML(meal)}
                        </div>
                        <button class="add-to-cart" data-meal-id="${meal.id}" data-meal-name="${meal.name}" data-meal-price="${meal.price}" disabled>
                            <i class="fas fa-cart-plus"></i>
                            加入购物车
                        </button>
                    </div>
                    
                    <div class="right-section">
                        <!-- 配送信息和购物车在一起 -->
                        <div class="delivery-form">
                            <h3 class="section-title">
                                <i class="fas fa-truck"></i>
                                配送信息
                            </h3>
                            
                            <div class="order-type">
                                ${meal.supportDelivery !== false ? `
                                <label>
                                    <input type="radio" name="deliveryType" value="delivery" checked>
                                    <span>宅急送（免配送费）</span>
                                </label>
                                ` : ''}
                                <label>
                                    <input type="radio" name="deliveryType" value="pickup" ${meal.supportDelivery === false ? 'checked' : ''}>
                                    <span>到店自提</span>
                                </label>
                            </div>
                            
                            <!-- 宅急送配送信息 -->
                            <div class="delivery-fields" id="deliveryFields" ${meal.supportDelivery === false ? 'style="display:none;"' : ''}>
                                <div class="form-group">
                                    <label class="form-label">配送信息提供方式 <span class="required">*</span></label>
                                    <div class="delivery-method-selector">
                                        <label class="delivery-method-option">
                                            <input type="radio" name="deliveryMethod" value="text" checked>
                                            <span>手动填写</span>
                                        </label>
                                        <label class="delivery-method-option">
                                            <input type="radio" name="deliveryMethod" value="screenshot">
                                            <span>上传截图</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- 手动填写方式 -->
                                <div class="delivery-text-method-fields" id="deliveryTextMethodFields">
                                    <div class="form-group">
                                        <label class="form-label">快速粘贴配送信息（可选）</label>
                                        <textarea class="form-input" id="fullDeliveryInfo" rows="3" placeholder="您可以在这里粘贴完整的配送信息，例如：&#10;张三 13800138000&#10;北京市海淀区中关村大街1号"></textarea>
                                        <button type="button" class="action-btn" id="parseDeliveryInfo" style="margin-top: 8px; padding: 6px 12px; font-size: 0.85rem; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            <i class="fas fa-magic"></i> 自动识别并填充
                                        </button>
                                        <div class="form-hint">
                                            <i class="fas fa-lightbulb"></i> 可以粘贴完整的配送信息，系统会自动提取姓名、电话和地址
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">收货人姓名(可不填写) <span class="optional-field"></span></label>
                                        <input type="text" class="form-input" id="customerName" placeholder="请输入姓名">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">联系电话 <span class="optional-field"></span></label>
                                        <input type="tel" class="form-input" id="customerPhone" placeholder="请输入手机号码" pattern="1[3-9]\d{9}" title="请输入正确的手机号码（11位，以1开头）">
                                        <div class="form-hint">
                                            <i class="fas fa-mobile-alt"></i> 请输入11位手机号码（例如：13800138000）
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">配送地址 <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="deliveryAddress" placeholder="请输入详细地址" required>
                                    </div>
                                </div>
                                <!-- 截图上传方式 -->
                                <div class="delivery-screenshot-method-fields hidden" id="deliveryScreenshotMethodFields">
                                    <div class="form-group">
                                        <label class="form-label">上传含配送地址和联系方式截图 <span class="required">*</span></label>
                                        <div class="delivery-screenshot-upload-area" id="deliveryScreenshotUploadArea">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>点击上传配送地址截图</p>
                                            <p class="upload-hint">支持 JPG、PNG 格式，建议包含完整配送地址信息</p>
                                            <input type="file" id="deliveryScreenshot" accept="image/*">
                                        </div>
                                        <div class="delivery-screenshot-preview hidden" id="deliveryScreenshotPreview">
                                            <div class="screenshot-preview-container">
                                                <img id="deliveryPreviewImage" src="" alt="配送地址截图预览">
                                                <div class="image-info" id="deliveryImageInfo"></div>
                                            </div>
                                            <button type="button" class="remove-delivery-screenshot" id="removeDeliveryScreenshot">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="compress-progress" id="deliveryCompressProgress">
                                            <i class="fas fa-compress-alt"></i> 正在压缩图片... <span id="deliveryCompressPercent">0%</span>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-lightbulb"></i> 可以上传包含姓名电话配送地址的截图
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 到店自提信息 -->
                            <div class="pickup-fields ${meal.supportDelivery !== false ? 'hidden' : ''}" id="pickupFields" ${meal.supportDelivery === false ? 'style="display:block;"' : ''}>
                                <div class="form-group">
                                    <label class="form-label">自提方式 <span class="required">*</span></label>
                                    <div class="pickup-type">
                                        <label>
                                            <input type="radio" name="pickupType" value="堂食" checked>
                                            <span>堂食</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="pickupType" value="外带">
                                            <span>外带</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">门店信息提供方式 <span class="required">*</span></label>
                                    <div class="info-method-selector">
                                        <label class="method-option">
                                            <input type="radio" name="pickupMethod" value="text" checked>
                                            <span>手动填写</span>
                                        </label>
                                        <label class="method-option">
                                            <input type="radio" name="pickupMethod" value="screenshot">
                                            <span>上传截图</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="text-method-fields" id="textMethodFields">
                                    <div class="store-selection">
                                        <div class="form-group">
                                            <label class="form-label">自提城市 <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="pickupCityInput" placeholder="例如：北京市" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">自提门店 <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="pickupStoreInput" placeholder="例如：肯德基王府井店" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="screenshot-method-fields hidden" id="screenshotMethodFields">
                                    <div class="form-group">
                                        <label class="form-label">上传门店截图 <span class="required">*</span></label>
                                        <div class="screenshot-upload-area" id="screenshotUploadArea">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>点击或拖拽上传截图</p>
                                            <p class="upload-hint">支持 JPG、PNG 格式，大小不超过 2MB，建议压缩后上传</p>
                                            <input type="file" id="storeScreenshot" accept="image/*" style="display: none;">
                                        </div>
                                        <div class="screenshot-preview hidden" id="screenshotPreview">
                                            <div class="screenshot-preview-container">
                                                <img id="previewImage" src="" alt="截图预览">
                                                <div class="image-info" id="imageInfo"></div>
                                            </div>
                                            <button type="button" class="remove-screenshot" id="removeScreenshot">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="compress-progress" id="compressProgress">
                                            <i class="fas fa-compress-alt"></i> 正在压缩图片... <span id="compressPercent">0%</span>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-lightbulb"></i> 系统会自动压缩图片到合适大小，确保上传速度
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">订单备注</label>
                                <textarea class="form-input" id="orderNote" rows="2" placeholder="如有特殊要求请在此备注（例如：不吃辣，多要番茄酱等）"></textarea>
                            </div>
                            
                            <!-- 购物车在配送信息表单底部 -->
                            <div class="cart-section">
                                <h2 class="section-title">
                                    <i class="fas fa-shopping-cart"></i>
                                    购物车
                                </h2>
                                
                                <div class="cart-items" id="cartItems">
                                    <div class="empty-cart-message">购物车是空的，请选择套餐</div>
                                </div>
                                
                                <div class="cart-total">
                                    <span>总计：</span>
                                    <span class="total-price" id="totalPrice">¥0.00</span>
                                </div>
                                
                                <!-- 移除进度条，改为简单的状态提示 -->
                                <div class="submit-status" id="submitStatus"></div>
                                
                                <button class="checkout-btn quick-submit" id="checkoutBtn" disabled>
                                    <i class="fas fa-credit-card"></i>
                                    快速提交订单
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

				initOptionSelection(mealDetailPage);
				initDeliveryTypeToggle(mealDetailPage);
				initDeliveryMethod(mealDetailPage); // 新增：初始化宅急送配送方式
				initPickupMethod(mealDetailPage);
				initCart(mealDetailPage);
				initCheckout(mealDetailPage);

				if (!meal.optionGroups || meal.optionGroups.length === 0) {
					const addToCartBtn = mealDetailPage.querySelector('.add-to-cart');
					if (addToCartBtn) {
						addToCartBtn.disabled = false;
						addToCartBtn.style.opacity = '1';
						addToCartBtn.style.cursor = 'pointer';
					}
				}

				showPage('mealDetailPage');

				document.getElementById('viewOrdersBtn').style.display = 'flex';
				document.getElementById('viewHomeBtn').style.display = 'none';
			}

			function generateOptionsHTML(meal) {
				let html = '';

				if (meal.optionGroups && meal.optionGroups.length > 0) {
					meal.optionGroups.forEach((group, groupIndex) => {
						const groupId = `group-${meal.id}-${groupIndex}`;
						const repeat = group.repeat ? 'true' : 'false';
						const maxPerItem = group.maxPerItem || (group.repeat ? 999 : 1);

						html +=
							`
                        <div class="option-group" data-group-id="${groupId}" data-min-select="${group.minSelect}" data-max-select="${group.maxSelect}" data-repeat="${repeat}" data-max-per-item="${maxPerItem}">
                            <div class="option-title">${group.title}</div>
                            <div class="option-rules">${group.rules}</div>
                            <div class="option-items">
                    `;

						if (group.items && group.items.length > 0) {
							group.items.forEach((item, itemIndex) => {
								const itemId = `${groupId}-${itemIndex}`;
								const addPrice = item.addPrice || 0;
								const addPriceText = addPrice > 0 ? ` (+¥${addPrice})` : '';

								html +=
									`
                                <div class="option-item" data-item-id="${itemId}" data-name="${item.name}" data-add-price="${addPrice}">
                                    <span>${item.name}${addPriceText}</span>
                                    <div class="selection-counter">
                                        <button class="counter-btn decrement" disabled>-</button>
                                        <span class="counter-value">0</span>
                                        <button class="counter-btn increment">+</button>
                                    </div>
                                </div>
                            `;
							});
						}

						html +=
							`
                            </div>
                            <div class="selection-status invalid">已选择 0 份，还需选择 ${group.minSelect} 份</div>
                        </div>
                    `;
					});
				}

				if (meal.fixedItems && meal.fixedItems.length > 0) {
					html +=
						`
                    <div class="fixed-combo-items">
                        <div class="option-title">固定搭配：</div>
                        <div class="option-rules">套餐包含固定搭配，无需选择</div>
                        <div class="fixed-combo-list">
                `;

					meal.fixedItems.forEach(item => {
						html +=
							`
                        <div class="fixed-combo-item">
                            <div class="fixed-combo-item-name">${item.name}</div>
                            <div class="fixed-combo-item-qty">×${item.quantity}</div>
                        </div>
                    `;
					});

					html += `
                        </div>
                    </div>
                `;
				}

				return html;
			}

			// ==================== 修改：页面切换函数 ====================
			function showPage(pageId) {
				// 如果通过分享链接进入，禁止显示首页
				if (isSharedLink && pageId === 'homePage') {
					// 如果当前在订单页面，返回套餐详情页
					if (document.getElementById('myOrdersPage').classList.contains('active')) {
						showMealDetail(sharedMealId);
					}
					// 否则什么也不做，保持当前页面
					return;
				}

				document.querySelectorAll('.meal-page-container').forEach(page => {
					page.classList.remove('active');
				});

				document.getElementById(pageId).classList.add('active');

				window.scrollTo(0, 0);

				if (pageId === 'homePage') {
					document.getElementById('viewOrdersBtn').style.display = 'flex';
					document.getElementById('viewHomeBtn').style.display = 'none';
					document.title = '肯德基自助点餐系统';
				} else if (pageId === 'mealDetailPage') {
					document.getElementById('viewOrdersBtn').style.display = 'flex';
					document.getElementById('viewHomeBtn').style.display = isSharedLink ? 'none' : 'flex';
				} else if (pageId === 'myOrdersPage') {
					document.getElementById('viewOrdersBtn').style.display = 'none';
					document.getElementById('viewHomeBtn').style.display = isSharedLink ? 'none' : 'flex';
				}
			}

			// ==================== 选项选择功能 ====================
			function initOptionSelection(container) {
				container.querySelectorAll('.counter-btn.increment').forEach(button => {
					button.addEventListener('click', function(e) {
						e.stopPropagation();
						const optionItem = this.closest('.option-item');
						const counterValue = optionItem.querySelector('.counter-value');
						const decrementBtn = optionItem.querySelector('.decrement');
						const group = optionItem.closest('.option-group');

						const maxSelect = parseInt(group.dataset.maxSelect) || Infinity;
						const repeat = group.dataset.repeat === 'true';
						const maxPerItem = parseInt(group.dataset.maxPerItem) || (repeat ? Infinity : 1);

						let totalSelected = 0;
						group.querySelectorAll('.counter-value').forEach(value => {
							totalSelected += parseInt(value.textContent);
						});

						let currentSelected = parseInt(counterValue.textContent);

						if (totalSelected >= maxSelect) {
							showNotification(`该选项组最多只能选择${maxSelect}份`);
							return;
						}

						if (currentSelected >= maxPerItem) {
							showNotification(`该选项最多只能选择${maxPerItem}份`);
							return;
						}

						currentSelected++;
						counterValue.textContent = currentSelected;

						decrementBtn.disabled = false;
						optionItem.classList.add('selected');

						updateGroupSelectionStatus(group);
					});
				});

				container.querySelectorAll('.counter-btn.decrement').forEach(button => {
					button.addEventListener('click', function(e) {
						e.stopPropagation();
						const optionItem = this.closest('.option-item');
						const counterValue = optionItem.querySelector('.counter-value');

						let currentSelected = parseInt(counterValue.textContent);

						if (currentSelected > 0) {
							currentSelected--;
							counterValue.textContent = currentSelected;

							this.disabled = currentSelected === 0;

							if (currentSelected === 0) {
								optionItem.classList.remove('selected');
							}

							const group = optionItem.closest('.option-group');
							updateGroupSelectionStatus(group);
						}
					});
				});

				container.querySelectorAll('.option-item').forEach(item => {
					if (!item.classList.contains('selected')) {
						item.addEventListener('click', function() {
							const incrementBtn = this.querySelector('.increment');
							if (incrementBtn) {
								incrementBtn.click();
							}
						});
					}
				});
			}

			function updateGroupSelectionStatus(group) {
				if (!group.dataset.minSelect) return;

				const minSelect = parseInt(group.dataset.minSelect);
				const maxSelect = parseInt(group.dataset.maxSelect);

				let totalSelected = 0;
				group.querySelectorAll('.counter-value').forEach(value => {
					totalSelected += parseInt(value.textContent);
				});

				const statusElement = group.querySelector('.selection-status');
				if (statusElement) {
					if (totalSelected >= minSelect && totalSelected <= maxSelect) {
						statusElement.textContent = `已选择 ${totalSelected} 份，符合要求`;
						statusElement.className = 'selection-status valid';
					} else if (totalSelected < minSelect) {
						statusElement.textContent = `已选择 ${totalSelected} 份，还需选择 ${minSelect - totalSelected} 份`;
						statusElement.className = 'selection-status invalid';
					} else {
						statusElement.textContent = `已选择 ${totalSelected} 份，已超过最大 ${maxSelect} 份`;
						statusElement.className = 'selection-status invalid';
					}
				}

				const mealContainer = group.closest('.meal-page-container');
				updateAddToCartButton(mealContainer);
			}

			function updateAddToCartButton(mealContainer) {
				const addToCartBtn = mealContainer.querySelector('.add-to-cart');
				if (!addToCartBtn) return;

				const optionGroups = mealContainer.querySelectorAll('.option-group');
				if (optionGroups.length === 0) {
					addToCartBtn.disabled = false;
					addToCartBtn.style.opacity = '1';
					addToCartBtn.style.cursor = 'pointer';
					return;
				}

				let isValid = true;

				optionGroups.forEach(group => {
					if (!group.dataset.minSelect) return;

					const minSelect = parseInt(group.dataset.minSelect);
					const maxSelect = parseInt(group.dataset.maxSelect);

					let totalSelected = 0;
					group.querySelectorAll('.counter-value').forEach(value => {
						totalSelected += parseInt(value.textContent);
					});

					if (totalSelected < minSelect || totalSelected > maxSelect) {
						isValid = false;
					}
				});

				if (isValid) {
					addToCartBtn.disabled = false;
					addToCartBtn.style.opacity = '1';
					addToCartBtn.style.cursor = 'pointer';
				} else {
					addToCartBtn.disabled = true;
					addToCartBtn.style.opacity = '0.6';
					addToCartBtn.style.cursor = 'not-allowed';
				}
			}

			// ==================== 配送方式切换 ====================
			function initDeliveryTypeToggle(container) {
				container.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
					radio.addEventListener('change', function() {
						const deliveryFields = container.querySelector('.delivery-fields');
						const pickupFields = container.querySelector('.pickup-fields');

						if (this.value === 'delivery') {
							if (deliveryFields) deliveryFields.style.display = 'block';
							if (pickupFields) pickupFields.style.display = 'none';
						} else {
							if (deliveryFields) deliveryFields.style.display = 'none';
							if (pickupFields) pickupFields.style.display = 'block';
						}
					});
				});
			}

			// ==================== 新增：宅急送配送方式处理 ====================
			function initDeliveryMethod(container) {
				// 添加配送信息自动解析功能
				const fullDeliveryInfoTextarea = container.querySelector('#fullDeliveryInfo');
				const parseButton = container.querySelector('#parseDeliveryInfo');
				const nameInput = container.querySelector('#customerName');
				const phoneInput = container.querySelector('#customerPhone');
				const addressInput = container.querySelector('#deliveryAddress');

				// 修改自动解析按钮的点击事件处理
				if (parseButton) {
					parseButton.addEventListener('click', function() {
						const fullText = fullDeliveryInfoTextarea.value.trim();
						if (!fullText) {
							showNotification('请先粘贴配送信息', 'error');
							return;
						}

						// 解析配送信息
						const result = parseDeliveryInfo(fullText);

						// 填充表单字段
						if (result.phone) {
							phoneInput.value = result.phone;
							// 验证手机号格式
							if (!validatePhoneNumber(result.phone)) {
								showNotification('手机号格式不正确，请检查', 'error');
								phoneInput.style.borderColor = '#e31837';
								phoneInput.style.boxShadow = '0 0 0 2px rgba(227, 24, 55, 0.2)';
							} else {
								phoneInput.style.borderColor = '#4CAF50';
								phoneInput.style.boxShadow = '0 0 0 2px rgba(76, 175, 80, 0.2)';
								showNotification('手机号格式正确', 'success');
							}
						}

						if (result.address) {
							addressInput.value = result.address;
							// 验证地址是否有效（至少5个字符）
							if (result.address.length < 5) {
								showNotification('地址可能不完整，请检查', 'warning');
								addressInput.style.borderColor = '#ff9800';
								addressInput.style.boxShadow = '0 0 0 2px rgba(255, 152, 0, 0.2)';
							} else {
								addressInput.style.borderColor = '#4CAF50';
								addressInput.style.boxShadow = '0 0 0 2px rgba(76, 175, 80, 0.2)';
								showNotification('地址已识别', 'success');
							}
						}

						// 姓名是可选的，如果有就填充
						if (result.name && nameInput) {
							nameInput.value = result.name;
							nameInput.style.borderColor = '#4CAF50';
							nameInput.style.boxShadow = '0 0 0 2px rgba(76, 175, 80, 0.2)';
						}

						// 显示解析结果摘要
						let summary = '';
						if (result.phone) summary += `电话: ${result.phone}`;
						if (result.address) summary +=
							` | 地址: ${result.address.substring(0, 30)}${result.address.length > 30 ? '...' : ''}`;
						if (result.name) summary += ` | 姓名: ${result.name}`;

						if (summary) {
							showNotification(`已识别: ${summary}`, 'success');

							// 添加详细提示（用于调试）
							console.log('解析详情:', {
								原始文本: fullText,
								提取的电话: result.phone,
								提取的地址: result.address,
								提取的姓名: result.name,
								地址长度: result.address ? result.address.length : 0
							});
						} else {
							showNotification('未能自动识别配送信息，请手动填写', 'error');
						}

						// 3秒后移除高亮效果
						setTimeout(() => {
							if (nameInput) {
								nameInput.style.borderColor = '';
								nameInput.style.boxShadow = '';
							}
							phoneInput.style.borderColor = '';
							phoneInput.style.boxShadow = '';
							addressInput.style.borderColor = '';
							addressInput.style.boxShadow = '';
						}, 3000);
					});
				}
				if (parseButton) {
					parseButton.addEventListener('click', function() {
						const fullText = fullDeliveryInfoTextarea.value.trim();
						if (!fullText) {
							showNotification('请先粘贴配送信息', 'error');
							return;
						}

						// 解析配送信息
						const result = parseDeliveryInfo(fullText);

						// 填充表单字段
						if (result.phone) {
							phoneInput.value = result.phone;
							// 验证手机号格式
							if (!validatePhoneNumber(result.phone)) {
								showNotification('手机号格式不正确，请检查', 'error');
								phoneInput.style.borderColor = '#e31837';
								phoneInput.style.boxShadow = '0 0 0 2px rgba(227, 24, 55, 0.2)';
							} else {
								phoneInput.style.borderColor = '#4CAF50';
								phoneInput.style.boxShadow = '0 0 0 2px rgba(76, 175, 80, 0.2)';
								showNotification('手机号格式正确', 'success');
							}
						}

						if (result.address) {
							addressInput.value = result.address;
							// 验证地址是否有效（至少5个字符）
							if (result.address.length < 5) {
								showNotification('地址可能不完整，请检查', 'warning');
								addressInput.style.borderColor = '#ff9800';
								addressInput.style.boxShadow = '0 0 0 2px rgba(255, 152, 0, 0.2)';
							} else {
								addressInput.style.borderColor = '#4CAF50';
								addressInput.style.boxShadow = '0 0 0 2px rgba(76, 175, 80, 0.2)';
								showNotification('地址已识别', 'success');
							}
						}

						// 姓名是可选的，如果有就填充
						if (result.name && nameInput) {
							nameInput.value = result.name;
							nameInput.style.borderColor = '#4CAF50';
							nameInput.style.boxShadow = '0 0 0 2px rgba(76, 175, 80, 0.2)';
						}

						// 显示解析结果摘要
						let summary = '';
						if (result.phone) summary += `电话: ${result.phone}`;
						if (result.address) summary +=
							` | 地址: ${result.address.substring(0, 30)}${result.address.length > 30 ? '...' : ''}`;
						if (result.name) summary += ` | 姓名: ${result.name}`;

						if (summary) {
							showNotification(`已识别: ${summary}`, 'success');

							// 添加详细提示（用于调试）
							console.log('解析详情:', {
								原始文本: fullText,
								提取的电话: result.phone,
								提取的地址: result.address,
								提取的姓名: result.name,
								地址长度: result.address ? result.address.length : 0
							});
						} else {
							showNotification('未能自动识别配送信息，请手动填写', 'error');
						}

						// 3秒后移除高亮效果
						setTimeout(() => {
							if (nameInput) {
								nameInput.style.borderColor = '';
								nameInput.style.boxShadow = '';
							}
							phoneInput.style.borderColor = '';
							phoneInput.style.boxShadow = '';
							addressInput.style.borderColor = '';
							addressInput.style.boxShadow = '';
						}, 3000);
					});
				}
				// 添加手机号输入验证
				if (phoneInput) {
					phoneInput.addEventListener('input', function() {
						if (this.value) {
							if (!validatePhoneNumber(this.value)) {
								this.style.borderColor = '#e31837';
								this.style.boxShadow = '0 0 0 2px rgba(227, 24, 55, 0.2)';
							} else {
								this.style.borderColor = '#4CAF50';
								this.style.boxShadow = '0 0 0 2px rgba(76, 175, 80, 0.2)';
							}
						} else {
							this.style.borderColor = '';
							this.style.boxShadow = '';
						}
					});

					phoneInput.addEventListener('blur', function() {
						if (this.value && !validatePhoneNumber(this.value)) {
							showNotification('手机号格式不正确，请重新输入', 'error');
							this.focus();
						}
					});
				}
				container.querySelectorAll('input[name="deliveryMethod"]').forEach(radio => {
					radio.addEventListener('change', function() {
						const textFields = container.querySelector('.delivery-text-method-fields');
						const screenshotFields = container.querySelector('.delivery-screenshot-method-fields');

						if (this.value === 'text') {
							if (textFields) textFields.style.display = 'block';
							if (screenshotFields) screenshotFields.style.display = 'none';
						} else {
							if (screenshotFields) screenshotFields.style.display = 'block';
							if (textFields) textFields.style.display = 'none';
						}
					});
				});

				const uploadArea = container.querySelector('.delivery-screenshot-upload-area');
				if (uploadArea) {
					const fileInput = uploadArea.querySelector('input[type="file"]');
					const previewContainer = container.querySelector('.delivery-screenshot-preview');
					const previewImage = previewContainer ? previewContainer.querySelector('img') : null;
					const removeBtn = previewContainer ? previewContainer.querySelector('.remove-delivery-screenshot') : null;
					const compressProgress = container.querySelector('.delivery-compress-progress');
					const compressPercent = compressProgress ? compressProgress.querySelector('#deliveryCompressPercent') : null;
					const imageInfo = container.querySelector('#deliveryImageInfo');

					if (uploadArea && fileInput && previewContainer && previewImage && removeBtn) {
						uploadArea.addEventListener('click', function() {
							fileInput.click();
						});

						fileInput.addEventListener('change', async function(e) {
							if (e.target.files.length) {
								await handleDeliveryFileSelect(e.target.files[0], fileInput, previewContainer, previewImage, uploadArea,
									compressProgress, compressPercent, imageInfo);
							}
						});

						removeBtn.addEventListener('click', function() {
							fileInput.value = '';
							previewContainer.classList.add('hidden');
							uploadArea.style.display = 'block';
							if (compressProgress) compressProgress.classList.remove('active');
						});
					}
				}

				async function handleDeliveryFileSelect(file, fileInput, previewContainer, previewImage, uploadArea,
					compressProgress, compressPercent, imageInfo) {
					if (!file.type.match('image.*')) {
						showNotification('请选择图片文件', 'error');
						return;
					}

					if (compressProgress) {
						compressProgress.classList.add('active');
						if (compressPercent) compressPercent.textContent = '0%';
					}

					const compressedImage = await compressImageOptimized(file, compressPercent);

					const reader = new FileReader();
					reader.onload = function(e) {
						previewImage.src = e.target.result;
						previewContainer.classList.remove('hidden');
						previewContainer.classList.add('show');
						uploadArea.style.display = 'none';

						if (imageInfo) {
							const originalSize = (file.size / 1024).toFixed(2);
							const compressedSize = (compressedImage.size / 1024).toFixed(2);
							const compressionRatio = ((1 - compressedImage.size / file.size) * 100).toFixed(1);
							imageInfo.innerHTML =
								`
                            原始大小: ${originalSize}KB<br>
                            压缩后: ${compressedSize}KB<br>
                            压缩率: ${compressionRatio}%
                        `;
						}

						if (compressProgress) {
							compressProgress.classList.remove('active');
						}
					};
					reader.readAsDataURL(compressedImage);
				}
			}

			// ==================== 自提方式处理 ====================
			function initPickupMethod(container) {
				container.querySelectorAll('input[name="pickupMethod"]').forEach(radio => {
					radio.addEventListener('change', function() {
						const textFields = container.querySelector('.text-method-fields');
						const screenshotFields = container.querySelector('.screenshot-method-fields');

						if (this.value === 'text') {
							textFields.style.display = 'block';
							screenshotFields.style.display = 'none';
						} else {
							screenshotFields.style.display = 'block';
							textFields.style.display = 'none';
						}
					});
				});

				const uploadArea = container.querySelector('.screenshot-upload-area');
				if (uploadArea) {
					const fileInput = uploadArea.querySelector('input[type="file"]');
					const previewContainer = uploadArea.parentElement.querySelector('.screenshot-preview');
					const previewImage = previewContainer ? previewContainer.querySelector('img') : null;
					const removeBtn = previewContainer ? previewContainer.querySelector('.remove-screenshot') : null;
					const compressProgress = container.querySelector('.compress-progress');
					const compressPercent = compressProgress ? compressProgress.querySelector('#compressPercent') : null;
					const imageInfo = container.querySelector('#imageInfo');

					if (uploadArea && fileInput && previewContainer && previewImage && removeBtn) {
						uploadArea.addEventListener('click', function() {
							fileInput.click();
						});

						uploadArea.addEventListener('dragover', function(e) {
							e.preventDefault();
							this.style.borderColor = '#e31837';
							this.style.backgroundColor = '#fff5f5';
						});

						uploadArea.addEventListener('dragleave', function(e) {
							e.preventDefault();
							this.style.borderColor = '#ddd';
							this.style.backgroundColor = '#f9f9f9';
						});

						uploadArea.addEventListener('drop', function(e) {
							e.preventDefault();
							this.style.borderColor = '#ddd';
							this.style.backgroundColor = '#f9f9f9';

							if (e.dataTransfer.files.length) {
								handleFileSelect(e.dataTransfer.files[0], fileInput, previewContainer, previewImage, uploadArea,
									compressProgress, compressPercent, imageInfo);
							}
						});

						fileInput.addEventListener('change', function(e) {
							if (e.target.files.length) {
								handleFileSelect(e.target.files[0], fileInput, previewContainer, previewImage, uploadArea, compressProgress,
									compressPercent, imageInfo);
							}
						});

						removeBtn.addEventListener('click', function() {
							fileInput.value = '';
							previewContainer.classList.add('hidden');
							uploadArea.style.display = 'block';
							if (compressProgress) compressProgress.classList.remove('active');
						});
					}
				}

				async function handleFileSelect(file, fileInput, previewContainer, previewImage, uploadArea, compressProgress,
					compressPercent, imageInfo) {
					if (!file.type.match('image.*')) {
						showNotification('请选择图片文件', 'error');
						return;
					}

					if (compressProgress) {
						compressProgress.classList.add('active');
						if (compressPercent) compressPercent.textContent = '0%';
					}

					const compressedImage = await compressImageOptimized(file, compressPercent);

					const reader = new FileReader();
					reader.onload = function(e) {
						previewImage.src = e.target.result;
						previewContainer.classList.remove('hidden');
						uploadArea.style.display = 'none';

						if (imageInfo) {
							const originalSize = (file.size / 1024).toFixed(2);
							const compressedSize = (compressedImage.size / 1024).toFixed(2);
							const compressionRatio = ((1 - compressedImage.size / file.size) * 100).toFixed(1);
							imageInfo.innerHTML =
								`
                            原始大小: ${originalSize}KB<br>
                            压缩后: ${compressedSize}KB<br>
                            压缩率: ${compressionRatio}%
                        `;
						}

						if (compressProgress) {
							compressProgress.classList.remove('active');
						}
					};
					reader.readAsDataURL(compressedImage);
				}
			}

			// ==================== 购物车功能 ====================
			function initCart(container) {
				const addToCartBtn = container.querySelector('.add-to-cart');
				if (addToCartBtn) {
					addToCartBtn.addEventListener('click', function() {
						const optionGroups = container.querySelectorAll('.option-group');

						if (this.disabled && optionGroups.length > 0) {
							showNotification('请先完成选项选择，确保每个选项组的选择数量符合要求');
							return;
						}

						const mealId = this.dataset.mealId;
						const mealName = this.dataset.mealName;
						const mealPrice = parseFloat(this.dataset.mealPrice);

						const meal = meals.find(m => m.id === mealId);
						if (!meal) return;

						const selectedOptions = [];
						let additionalPrice = 0;

						container.querySelectorAll('.option-group').forEach(group => {
							group.querySelectorAll('.option-item').forEach(item => {
								const counterValue = item.querySelector('.counter-value');
								const count = parseInt(counterValue.textContent);

								if (count > 0) {
									const itemName = item.dataset.name || item.textContent;
									const itemAddPrice = parseFloat(item.dataset.addPrice) || 0;

									for (let i = 0; i < count; i++) {
										selectedOptions.push(itemName);
										additionalPrice += itemAddPrice;
									}
								}
							});
						});

						if (meal.fixedItems && meal.fixedItems.length > 0) {
							meal.fixedItems.forEach(item => {
								for (let i = 0; i < item.quantity; i++) {
									selectedOptions.push(item.name);
								}
							});
						}

						if (selectedOptions.length === 0) {
							showNotification('该套餐没有任何项目，无法加入购物车');
							return;
						}

						const totalPrice = mealPrice + additionalPrice;

						const mealItem = {
							id: mealId,
							name: mealName,
							basePrice: mealPrice,
							additionalPrice: additionalPrice,
							totalPrice: totalPrice,
							options: [...selectedOptions],
							supportDelivery: meal.supportDelivery
						};

						if (cart.length > 0) {
							const firstMealDelivery = cart[0].supportDelivery;
							if (firstMealDelivery !== meal.supportDelivery) {
								showNotification('无法同时添加支持宅急送和不支持宅急送的套餐到购物车', 'error');
								return;
							}
						}

						cart.push(mealItem);

						updateCartDisplay();

						showNotification(`已添加 "${mealName}" 到购物车`, 'success');

						resetOptions(container);
					});
				}
			}

			function resetOptions(container) {
				container.querySelectorAll('.option-group').forEach(group => {
					group.querySelectorAll('.option-item').forEach(item => {
						const counterValue = item.querySelector('.counter-value');
						const decrementBtn = item.querySelector('.decrement');

						counterValue.textContent = '0';
						if (decrementBtn) {
							decrementBtn.disabled = true;
						}
						item.classList.remove('selected');
					});

					updateGroupSelectionStatus(group);
				});
			}

			function updateCartDisplay() {
				document.querySelectorAll('.cart-items').forEach(container => {
					container.innerHTML = '';

					let totalPrice = 0;

					if (cart.length === 0) {
						container.innerHTML = '<div class="empty-cart-message">购物车是空的，请选择套餐</div>';
					} else {
						cart.forEach((item, index) => {
							const cartItemElement = document.createElement('div');
							cartItemElement.className = 'cart-item';

							const optionsHtml = item.options.map(option => `<div>• ${option}</div>`).join('');

							cartItemElement.innerHTML =
								`
                            <div class="cart-item-name">
                                <div><strong>${item.name}</strong></div>
                                <div style="font-size:0.8rem; color:#666; margin-top:3px;">
                                    ${optionsHtml}
                                </div>
                            </div>
                            <div class="cart-item-price">¥${item.totalPrice.toFixed(2)}</div>
                            <button class="cart-item-remove" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;

							container.appendChild(cartItemElement);

							totalPrice += item.totalPrice;

							cartItemElement.querySelector('.cart-item-remove').addEventListener('click', function() {
								const indexToRemove = parseInt(this.dataset.index);
								cart.splice(indexToRemove, 1);
								updateCartDisplay();
								showNotification('已从购物车中移除商品');
							});
						});
					}

					const totalPriceElement = container.closest('.cart-section').querySelector('.total-price');
					const checkoutBtn = container.closest('.cart-section').querySelector('.checkout-btn');

					if (totalPriceElement) {
						totalPriceElement.textContent = `¥${totalPrice.toFixed(2)}`;
					}

					if (checkoutBtn) {
						checkoutBtn.disabled = cart.length === 0;
					}
				});
			}

			// ==================== 订单提交功能 ====================
			function initCheckout(container) {
				const checkoutBtn = container.querySelector('.checkout-btn');
				if (checkoutBtn) {
					checkoutBtn.addEventListener('click', async function() {
						if (checkoutBtn.disabled) return;

						const deliveryType = container.querySelector('input[name="deliveryType"]:checked').value;
						const orderNote = container.querySelector('#orderNote') ? container.querySelector('#orderNote').value.trim() :
							'';

						let deliveryInfo = '';
						let hasScreenshot = false;
						let screenshotData = null;
						let pickupType = '';

						if (deliveryType === 'delivery') {
							const deliveryMethod = container.querySelector('input[name="deliveryMethod"]:checked').value;

							if (deliveryMethod === 'text') {
								const customerName = container.querySelector('#customerName') ? container.querySelector('#customerName').value
									.trim() : '';
								const customerPhone = container.querySelector('#customerPhone') ? container.querySelector('#customerPhone').value
									.trim() : '';
								const deliveryAddress = container.querySelector('#deliveryAddress') ? container.querySelector(
									'#deliveryAddress').value.trim() : '';

								// 修改：只验证地址是否填写，姓名和电话可选
								if (!deliveryAddress) {
									showNotification('请输入配送地址', 'error');
									const addressInput = container.querySelector('#deliveryAddress');
									if (addressInput) addressInput.focus();
									return;
								}

								deliveryInfo = `配送方式：宅急送\n信息提供：手动填写`;
								if (customerName) deliveryInfo += `\n收货人：${customerName}`;
								if (customerPhone) deliveryInfo += `\n联系电话：${customerPhone}`;
								deliveryInfo += `\n配送地址：${deliveryAddress}`;
							} else {
								const screenshotInput = container.querySelector('#deliveryScreenshot');

								if (!screenshotInput.files || !screenshotInput.files.length) {
									showNotification('请上传配送地址截图', 'error');
									return;
								}

								const submitStatus = document.getElementById('submitStatus');
								submitStatus.textContent = '正在处理图片...';

								try {
									const file = screenshotInput.files[0];
									const reader = new FileReader();

									reader.onload = function(e) {
										screenshotData = e.target.result;
										hasScreenshot = true;

										deliveryInfo = `配送方式：宅急送\n信息提供：截图上传`;

										submitStatus.textContent = '图片处理完成';

										setTimeout(() => {
											submitStatus.textContent = '';
											prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType);
										}, 500);
									};

									reader.onerror = function() {
										submitStatus.textContent = '图片读取失败，请重试';
										showNotification('图片读取失败，请重试', 'error');
									};

									reader.readAsDataURL(file);
								} catch (error) {
									submitStatus.textContent = '图片处理失败';
									showNotification('图片处理失败: ' + error.message, 'error');
								}
								return;
							}
						} else {
							pickupType = container.querySelector('input[name="pickupType"]:checked').value;
							const pickupMethod = container.querySelector('input[name="pickupMethod"]:checked').value;

							if (pickupMethod === 'text') {
								const pickupCity = container.querySelector('#pickupCityInput') ? container.querySelector('#pickupCityInput')
									.value.trim() : '';
								const pickupStore = container.querySelector('#pickupStoreInput') ? container.querySelector(
									'#pickupStoreInput').value.trim() : '';

								if (!pickupCity) {
									showNotification('请输入自提城市', 'error');
									const cityInput = container.querySelector('#pickupCityInput');
									if (cityInput) cityInput.focus();
									return;
								}

								if (!pickupStore) {
									showNotification('请输入自提门店', 'error');
									const storeInput = container.querySelector('#pickupStoreInput');
									if (storeInput) storeInput.focus();
									return;
								}

								deliveryInfo = `配送方式：到店自提\n自提方式：${pickupType}\n信息提供：手动填写\n自提城市：${pickupCity}\n自提门店：${pickupStore}`;
							} else {
								const screenshotInput = container.querySelector('#storeScreenshot');

								if (!screenshotInput.files || !screenshotInput.files.length) {
									showNotification('请上传门店截图', 'error');
									return;
								}

								const submitStatus = document.getElementById('submitStatus');
								submitStatus.textContent = '正在处理图片...';

								try {
									const file = screenshotInput.files[0];
									const reader = new FileReader();

									reader.onload = function(e) {
										screenshotData = e.target.result;
										hasScreenshot = true;

										deliveryInfo = `配送方式：到店自提\n自提方式：${pickupType}\n信息提供：截图上传`;

										submitStatus.textContent = '图片处理完成';

										setTimeout(() => {
											submitStatus.textContent = '';
											prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType);
										}, 500);
									};

									reader.onerror = function() {
										submitStatus.textContent = '图片读取失败，请重试';
										showNotification('图片读取失败，请重试', 'error');
									};

									reader.readAsDataURL(file);
								} catch (error) {
									submitStatus.textContent = '图片处理失败';
									showNotification('图片处理失败: ' + error.message, 'error');
								}
								return;
							}
						}

						prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType);
					});
				}
			}

			// 准备订单数据并显示确认模态框
			function prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType) {
				let totalPrice = 0;
				cart.forEach(item => {
					totalPrice += item.totalPrice;
				});

				const orderId = 'KFC' + Date.now().toString().slice(-6) + Math.floor(Math.random() * 100);
				const timestamp = new Date().toLocaleString('zh-CN');

				const orderData = {
					id: orderId,
					timestamp: timestamp,
					status: 'new',
					cart: JSON.parse(JSON.stringify(cart)),
					deliveryInfo: deliveryInfo,
					orderNote: orderNote,
					deliveryType: deliveryType,
					pickupType: pickupType || '',
					totalPrice: totalPrice,
					hasScreenshot: hasScreenshot,
					screenshotData: screenshotData,
					userId: currentUserId
				};

				showOrderConfirm(orderData);
			}

			// ==================== 完成订单提交 ====================
			async function completeOrderSubmission(orderData) {
				const checkoutBtn = document.querySelector('.checkout-btn');
				if (checkoutBtn.disabled) return;

				const submitStatus = document.getElementById('submitStatus');
				submitStatus.textContent = '正在提交订单...';

				checkoutBtn.disabled = true;
				checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';

				try {
					const savedOrder = await LeanCloudData.quickSaveOrder(orderData);
					console.log('订单快速提交成功:', savedOrder);

					savedOrder.objectId = savedOrder.objectId;
					orders.unshift(savedOrder);

					newOrdersCount++;

					setTimeout(async () => {
						try {
							await LeanCloudData.updateNewOrdersCount(newOrdersCount);
							console.log('新订单计数更新成功');
						} catch (countError) {
							console.warn('更新新订单计数失败，但不影响订单提交:', countError);
						}
					}, 1000);

					localStorage.setItem('kfcOrdersCache', JSON.stringify(orders.map(o => ({
						id: o.id,
						timestamp: o.timestamp,
						status: o.status,
						totalPrice: o.totalPrice,
						userId: o.userId
					}))));
					localStorage.setItem('newOrdersCountCache', newOrdersCount.toString());

					cart = [];
					updateCartDisplay();

					resetForm(document.querySelector('.meal-page-container.active'));

					updateOrderBadge();

					submitStatus.textContent = '订单提交成功！';

					setTimeout(() => {
						submitStatus.textContent = '';

						showNotification('订单提交成功！', 'success');

						showRealtimeIndicator('订单已提交！');

						if (isAdminPanelOpen) {
							const activeFilterBtn = document.querySelector('.filter-btn.active');
							const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
							renderOrders(activeFilter);
						}

						const successHTML =
							`
                        <div style="text-align: center; padding: 15px;">
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; color: #4CAF50; margin-bottom: 10px;"></i>
                            <h3 style="color: #4CAF50; margin-bottom: 8px; font-size: 1.2rem;">订单提交成功！</h3>
                            <p style="margin-bottom: 10px; font-size: 0.9rem;">订单号：<strong>${orderData.id}</strong></p>
                            <p style="margin-bottom: 15px; font-size: 0.85rem;">我们已收到您的订单，请耐心等待处理</p>
                            <div style="display: flex; gap: 8px; justify-content: center; margin-top: 15px;">
                                <button id="viewOrderDetail" style="background-color: #e31837; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;">
                                    <i class="fas fa-clipboard-list"></i> 查看订单详情
                                </button>
                                <button id="backToHome" style="background-color: #f0f0f0; color: #333; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;">
                                    <i class="fas fa-home"></i> 返回
                                </button>
                            </div>
                        </div>
                    `;

						const successModal = document.createElement('div');
						successModal.className = 'order-confirm-modal active';
						successModal.innerHTML =
							`
                        <div class="order-confirm-box" style="max-width: 350px; max-height: 400px;">
                            <div class="order-confirm-header" style="padding: 12px 15px;">
                                <h2 class="order-confirm-title" style="font-size: 1.1rem;">
                                    <i class="fas fa-check-circle"></i>
                                    提交成功
                                </h2>
                                <button class="order-confirm-close" onclick="this.closest('.order-confirm-modal').remove(); document.body.style.overflow='auto';">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="order-confirm-body" style="padding: 15px; max-height: 280px; overflow-y: auto;">
                                ${successHTML}
                            </div>
                        </div>
                    `;

						document.body.style.overflow = 'hidden';

						document.body.appendChild(successModal);

						successModal.querySelector('#viewOrderDetail').addEventListener('click', function() {
							successModal.remove();
							document.body.style.overflow = 'auto';
							showMyOrdersPage();

							const url = new URL(window.location);
							url.searchParams.set('order', orderData.id);
							window.history.pushState({}, '', url);

							setTimeout(() => {
								document.getElementById('orderSearchInput').value = orderData.id;
								searchUserOrder(orderData.id);

								const orderElements = document.querySelectorAll('.user-order-item');
								orderElements.forEach(el => {
									const orderIdElement = el.querySelector('.user-order-id');
									if (orderIdElement && orderIdElement.textContent.includes(orderData.id)) {
										el.style.animation = 'highlightOrder 2s';
										el.scrollIntoView({
											behavior: 'smooth',
											block: 'center'
										});
									}
								});
							}, 100);
						});

						successModal.querySelector('#backToHome').addEventListener('click', function() {
							successModal.remove();
							document.body.style.overflow = 'auto';
							if (isSharedLink) {
								showMealDetail(sharedMealId);
							} else {
								showPage('homePage');
							}
						});

					}, 1000);

				} catch (error) {
					console.error('提交订单失败:', error);
					submitStatus.textContent = '';
					showNotification('订单提交失败：' + (error.message || '请检查网络连接'), 'error');
					checkoutBtn.disabled = false;
					checkoutBtn.innerHTML = '<i class="fas fa-credit-card"></i> 快速提交订单';
					return;
				} finally {
					checkoutBtn.disabled = false;
					checkoutBtn.innerHTML = '<i class="fas fa-credit-card"></i> 快速提交订单';
				}
			}

			const highlightStyle = document.createElement('style');
			highlightStyle.textContent =
				`
            @keyframes highlightOrder {
                0% { box-shadow: 0 0 0 0 rgba(227, 24, 55, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(227, 24, 55, 0); }
                100% { box-shadow: 0 0 0 0 rgba(227, 24, 55, 0); }
            }
        `;
			document.head.appendChild(highlightStyle);

			function resetForm(container) {
				container.querySelectorAll('input[type="text"], input[type="tel"], textarea').forEach(input => {
					input.value = '';
				});

				const deliveryRadio = container.querySelector('input[name="deliveryType"][value="delivery"]');
				if (deliveryRadio) {
					deliveryRadio.checked = true;
					const deliveryFields = container.querySelector('.delivery-fields');
					const pickupFields = container.querySelector('.pickup-fields');
					if (deliveryFields) deliveryFields.style.display = 'block';
					if (pickupFields) pickupFields.style.display = 'none';
				}

				const textMethodRadio = container.querySelector('input[name="deliveryMethod"][value="text"]');
				if (textMethodRadio) {
					textMethodRadio.checked = true;
					const textFields = container.querySelector('.delivery-text-method-fields');
					const screenshotFields = container.querySelector('.delivery-screenshot-method-fields');
					if (textFields) textFields.style.display = 'block';
					if (screenshotFields) screenshotFields.style.display = 'none';
				}

				const pickupTextMethodRadio = container.querySelector('input[name="pickupMethod"][value="text"]');
				if (pickupTextMethodRadio) {
					pickupTextMethodRadio.checked = true;
					const textFields = container.querySelector('.text-method-fields');
					const screenshotFields = container.querySelector('.screenshot-method-fields');
					if (textFields) textFields.style.display = 'block';
					if (screenshotFields) screenshotFields.style.display = 'none';
				}

				const deliveryScreenshotInput = container.querySelector('#deliveryScreenshot');
				const deliveryPreviewContainer = container.querySelector('.delivery-screenshot-preview');
				const deliveryUploadArea = container.querySelector('.delivery-screenshot-upload-area');
				if (deliveryScreenshotInput) {
					deliveryScreenshotInput.value = '';
					if (deliveryPreviewContainer) {
						deliveryPreviewContainer.classList.add('hidden');
						deliveryPreviewContainer.classList.remove('show');
					}
					if (deliveryUploadArea) deliveryUploadArea.style.display = 'block';
				}

				const screenshotInput = container.querySelector('#storeScreenshot');
				const previewContainer = container.querySelector('.screenshot-preview');
				const uploadArea = container.querySelector('.screenshot-upload-area');
				if (screenshotInput) {
					screenshotInput.value = '';
					if (previewContainer) previewContainer.classList.add('hidden');
					if (uploadArea) uploadArea.style.display = 'block';
				}
			}

			// ==================== 我的订单页面 ====================
			function initHeaderButtons() {
				const viewOrdersBtn = document.getElementById('viewOrdersBtn');
				const viewHomeBtn = document.getElementById('viewHomeBtn');

				viewOrdersBtn.addEventListener('click', function() {
					showMyOrdersPage();
				});

				viewHomeBtn.addEventListener('click', function() {
					if (isSharedLink) {
						showMealDetail(sharedMealId);
					} else {
						showPage('homePage');
					}
					this.style.display = 'none';
					viewOrdersBtn.style.display = 'flex';
				});
			}

			function initMyOrdersPage() {
				const orderSearchBtn = document.getElementById('orderSearchBtn');
				const orderSearchInput = document.getElementById('orderSearchInput');
				const backFromOrdersBtn = document.getElementById('backFromOrdersBtn');

				orderSearchBtn.addEventListener('click', function() {
					const searchTerm = orderSearchInput.value.trim();
					if (searchTerm) {
						searchUserOrder(searchTerm);
					} else {
						renderUserOrders('all');
					}
				});

				orderSearchInput.addEventListener('keypress', function(e) {
					if (e.key === 'Enter') {
						orderSearchBtn.click();
					}
				});

				// 修改返回按钮的行为
				backFromOrdersBtn.onclick = function(e) {
					e.preventDefault();
					if (isSharedLink) {
						showMealDetail(sharedMealId);
					} else {
						showPage('homePage');
					}
				};

				document.querySelectorAll('.order-filter-tab').forEach(tab => {
					tab.addEventListener('click', function() {
						document.querySelectorAll('.order-filter-tab').forEach(t => {
							t.classList.remove('active');
						});

						this.classList.add('active');

						const filter = this.dataset.orderFilter;
						renderUserOrders(filter);
					});
				});
			}

			function showMyOrdersPage() {
				showPage('myOrdersPage');
				renderUserOrders('all');

				document.getElementById('viewOrdersBtn').style.display = 'none';
				document.getElementById('viewHomeBtn').style.display = 'flex';
			}

			function renderUserOrders(filter = 'all') {
				const myOrdersContainer = document.getElementById('myOrdersContainer');
				const noUserOrdersMessage = document.getElementById('noUserOrdersMessage');

				myOrdersContainer.innerHTML = '';

				let userOrders = orders.filter(order => order.userId === currentUserId);

				if (filter !== 'all') {
					userOrders = userOrders.filter(order => order.status === filter);
				}

				userOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

				if (userOrders.length === 0) {
					noUserOrdersMessage.style.display = 'block';
					return;
				}

				noUserOrdersMessage.style.display = 'none';

				userOrders.forEach(order => {
					const orderElement = createUserOrderElement(order);
					myOrdersContainer.appendChild(orderElement);
				});
			}

			// ==================== 优化：创建用户订单元素 ====================
			function createUserOrderElement(order) {
				const orderElement = document.createElement('div');
				orderElement.className = 'user-order-item';

				let statusText, statusClass;
				switch (order.status) {
					case 'new':
						statusText = '新订单';
						statusClass = 'user-status-new';
						break;
					case 'processing':
						statusText = '处理中';
						statusClass = 'user-status-processing';
						break;
					case 'completed':
						statusText = '已完成';
						statusClass = 'user-status-completed';
						break;
					default:
						statusText = '新订单';
						statusClass = 'user-status-new';
				}

				const deliveryTypeText = order.deliveryType === 'delivery' ? '宅急送' :
					`到店自提${order.pickupType ? ` (${order.pickupType})` : ''}`;

				let itemsHTML = '';
				order.cart.forEach((item, index) => {
					const optionCount = {};
					item.options.forEach(option => {
						optionCount[option] = (optionCount[option] || 0) + 1;
					});

					const optionText = Object.keys(optionCount).map(option => {
						const count = optionCount[option];
						return `${option}${count > 1 ? ` ×${count}` : ''}`;
					}).join(', ');

					itemsHTML +=
						`<div class="user-order-item-detail">
                    <div class="user-order-item-name">
                        <div><strong>${item.name}</strong></div>
                        <div style="font-size:0.8rem; color:#666;">${optionText}</div>
                    </div>
                    <div class="user-order-item-price">¥${item.totalPrice.toFixed(2)}</div>
                </div>`;
				});

				const infoLines = order.deliveryInfo.split('\n');
				let deliveryHTML = '';
				infoLines.forEach(line => {
					if (line.trim()) {
						deliveryHTML += `<p>${line}</p>`;
					}
				});

				let screenshotHTML = '';
				if (order.hasScreenshot && order.screenshotData) {
					screenshotHTML =
						`
                    <div class="screenshot-container">
                        <p><strong>配送/门店截图：</strong></p>
                        <img src="${order.screenshotData}" alt="配送/门店截图" class="screenshot-thumbnail" data-order-id="${order.id}">
                    </div>
                `;
				}

				let feedbackTopHTML = '';
				if (order.feedbackScreenshotData) {
					feedbackTopHTML =
						`
                    <div class="user-order-feedback-container">
                        <h4><i class="fas fa-check-circle"></i> 订单反馈截图</h4>
                        <img src="${order.feedbackScreenshotData}" alt="订单反馈截图" class="user-feedback-thumbnail" data-order-id="${order.id}">
                        <p style="font-size:0.9rem; color:#2e7d32; margin-top: 8px; font-weight: bold; text-align: center;">
                            <i class="fas fa-info-circle"></i> 商家已上传反馈信息，点击图片可查看大图
                        </p>
                    </div>
                `;
				}

				orderElement.innerHTML =
					`
                <div class="user-order-header">
                    <div>
                        <div class="user-order-id">订单号：${order.id}</div>
                        <div class="user-order-time">${order.timestamp} | ${deliveryTypeText}</div>
                    </div>
                    <div class="user-order-status ${statusClass}">${statusText}</div>
                </div>
                
                ${feedbackTopHTML}
                
                <div class="user-order-items">
                    ${itemsHTML}
                </div>
                
                <div class="user-order-total">
                    总计：¥${order.totalPrice.toFixed(2)}
                </div>
                
                <div class="user-order-info">
                    ${deliveryHTML}
                    ${order.orderNote ? `<p><strong>备注：</strong>${order.orderNote}</p>` : ''}
                    ${screenshotHTML}
                </div>
            `;

				if (order.hasScreenshot && order.screenshotData) {
					const screenshotImg = orderElement.querySelector('.screenshot-thumbnail');
					if (screenshotImg) {
						screenshotImg.addEventListener('click', function() {
							showFullImage(order.screenshotData);
						});
					}
				}

				if (order.feedbackScreenshotData) {
					const feedbackImg = orderElement.querySelector('.user-feedback-thumbnail');
					if (feedbackImg) {
						feedbackImg.addEventListener('click', function() {
							showFullImage(order.feedbackScreenshotData);
						});
					}
				}

				return orderElement;
			}

			function searchUserOrder(searchTerm) {
				const myOrdersContainer = document.getElementById('myOrdersContainer');
				const noUserOrdersMessage = document.getElementById('noUserOrdersMessage');

				myOrdersContainer.innerHTML = '';

				const searchResults = orders.filter(order =>
					order.userId === currentUserId &&
					order.id.toLowerCase().includes(searchTerm.toLowerCase())
				);

				searchResults.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

				if (searchResults.length === 0) {
					noUserOrdersMessage.style.display = 'block';
					noUserOrdersMessage.innerHTML =
						`
                    <i class="fas fa-search"></i>
                    <h3>未找到相关订单</h3>
                    <p>没有找到订单号包含"${searchTerm}"的订单</p>
                `;
					return;
				}

				noUserOrdersMessage.style.display = 'none';

				searchResults.forEach(order => {
					const orderElement = createUserOrderElement(order);
					myOrdersContainer.appendChild(orderElement);
				});
			}

			// ==================== 后台管理 ====================
			function initPasswordVerification() {
				const passwordModal = document.getElementById('passwordModal');
				const adminPasswordInput = document.getElementById('adminPassword');
				const submitPasswordBtn = document.getElementById('submitPassword');
				const passwordError = document.getElementById('passwordError');

				submitPasswordBtn.addEventListener('click', function() {
					const enteredPassword = adminPasswordInput.value.trim();

					if (enteredPassword === ADMIN_PASSWORD) {
						passwordModal.classList.remove('active');
						adminPasswordInput.value = '';
						passwordError.style.display = 'none';

						openAdminPanel();
					} else {
						passwordError.style.display = 'block';
						adminPasswordInput.value = '';
						adminPasswordInput.focus();

						adminPasswordInput.style.animation = 'none';
						setTimeout(() => {
							adminPasswordInput.style.animation = 'shake 0.5s';
						}, 10);
					}
				});

				adminPasswordInput.addEventListener('keypress', function(e) {
					if (e.key === 'Enter') {
						submitPasswordBtn.click();
					}
				});

				const style = document.createElement('style');
				style.textContent =
					`
                @keyframes shake {
                    0%, 100% {transform: translateX(0);}
                    10%, 30%, 50%, 70%, 90% {transform: translateX(-5px);}
                    20%, 40%, 60%, 80% {transform: translateX(5px);}
                }
            `;
				document.head.appendChild(style);
			}

			// ==================== 优化后的管理员面板实时更新 ====================
			async function openAdminPanel() {
				const adminPanel = document.getElementById('adminPanel');
				const panelOverlay = document.getElementById('panelOverlay');

				adminPanel.classList.add('active');
				panelOverlay.classList.add('active');
				document.body.style.overflow = 'hidden';

				isAdminPanelOpen = true;

				lastOrderUpdateTime = Date.now();

				updateOrderBadge();

				renderOrders('all');
				updateMealList('all');

				startAdminPolling();

				try {
					await forceSyncAllData();
				} catch (error) {
					console.error('打开管理员面板时同步数据失败:', error);
				}
			}

			function startAdminPolling() {
				if (adminPollingInterval) {
					clearInterval(adminPollingInterval);
				}

				adminPollingInterval = setInterval(async () => {
					if (isAdminPanelOpen) {
						try {
							const newOrders = await LeanCloudData.checkForNewOrders(lastOrderUpdateTime - 2000);
							if (newOrders.length > 0) {
								lastOrderUpdateTime = Date.now();

								newOrders.forEach(newOrder => {
									const existingIndex = orders.findIndex(o => o.id === newOrder.id);
									if (existingIndex === -1) {
										orders.unshift(newOrder);
									} else {
										orders[existingIndex] = newOrder;
									}
								});

								showRealtimeIndicator(`有${newOrders.length}个新订单`);

								const activeFilterBtn = document.querySelector('.filter-btn.active');
								const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
								renderOrders(activeFilter);

								updateOrderBadge();
							}
						} catch (error) {
							console.warn('轮询更新失败:', error);
						}
					} else {
						clearInterval(adminPollingInterval);
						adminPollingInterval = null;
					}
				}, 2000);
			}

			function initAdminPanel() {
				const adminBtn = document.getElementById('adminBtn');
				const closePanel = document.getElementById('closePanel');
				const panelOverlay = document.getElementById('panelOverlay');
				const adminPanel = document.getElementById('adminPanel');
				const clearAllOrders = document.getElementById('clearAllOrders');
				const syncDataBtn = document.getElementById('syncDataBtn');
				const adminTabs = document.querySelectorAll('.admin-tab');
				const adminMealSearchInput = document.getElementById('adminMealSearchInput');

				adminBtn.addEventListener('click', function() {
					const passwordModal = document.getElementById('passwordModal');
					const adminPasswordInput = document.getElementById('adminPassword');

					passwordModal.classList.add('active');
					adminPasswordInput.focus();
				});

				closePanel.addEventListener('click', function() {
					closeAdminPanel();
				});

				panelOverlay.addEventListener('click', function() {
					closeAdminPanel();
				});

				clearAllOrders.addEventListener('click', async function() {
					if (orders.length > 0 && confirm('确定要清空所有订单吗？此操作不可恢复！')) {
						try {
							showLoading('正在清空订单...');

							const deletePromises = orders.map(order => LeanCloudData.deleteOrder(order.id));
							await Promise.all(deletePromises);

							orders = [];
							newOrdersCount = 0;

							await LeanCloudData.updateNewOrdersCount(0);
							localStorage.setItem('newOrdersCountCache', '0');

							localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));

							updateOrderBadge();
							renderOrders('all');

							hideLoading();
							showNotification('已清空所有订单', 'success');
						} catch (error) {
							console.error('清空订单失败:', error);
							hideLoading();
							showNotification('清空失败，请检查网络连接', 'error');
						}
					}
				});

				syncDataBtn.addEventListener('click', async function() {
					showLoading('正在同步数据...');
					await forceSyncAllData();
					hideLoading();
				});

				adminTabs.forEach(tab => {
					tab.addEventListener('click', function() {
						const tabId = this.dataset.tab;

						adminTabs.forEach(t => t.classList.remove('active'));

						this.classList.add('active');

						document.querySelectorAll('.admin-tab-content').forEach(content => {
							content.classList.remove('active');
						});

						document.getElementById(`${tabId}Tab`).classList.add('active');

						if (tabId === 'meals') {
							showMealList();
						}

						if (tabId === 'meals' && adminMealSearchInput && adminMealSearchInput.value.trim()) {
							adminSearchMeals(adminMealSearchInput.value.trim());
						}
					});
				});

				document.querySelectorAll('.filter-btn').forEach(btn => {
					if (btn.id !== 'clearAllOrders' && btn.id !== 'syncDataBtn') {
						btn.addEventListener('click', function() {
							document.querySelectorAll('.filter-btn').forEach(b => {
								if (b.id !== 'clearAllOrders' && b.id !== 'syncDataBtn') {
									b.classList.remove('active');
								}
							});

							this.classList.add('active');

							const filter = this.dataset.filter;
							renderOrders(filter);
						});
					}
				});
			}

			function closeAdminPanel() {
				const adminPanel = document.getElementById('adminPanel');
				const panelOverlay = document.getElementById('panelOverlay');

				adminPanel.classList.remove('active');
				panelOverlay.classList.remove('active');
				document.body.style.overflow = 'auto';

				isAdminPanelOpen = false;

				if (adminPollingInterval) {
					clearInterval(adminPollingInterval);
					adminPollingInterval = null;
				}
			}

			function renderOrders(filter = 'all') {
				const ordersContainer = document.getElementById('ordersContainer');
				const noOrdersMessage = document.getElementById('noOrdersMessage');

				const orderElements = ordersContainer.querySelectorAll('.admin-order-item');
				orderElements.forEach(el => el.remove());

				let filteredOrders = orders;
				if (filter !== 'all') {
					filteredOrders = orders.filter(order => order.status === filter);
				}

				if (filteredOrders.length === 0) {
					noOrdersMessage.style.display = 'block';
					return;
				}

				noOrdersMessage.style.display = 'none';

				filteredOrders.forEach(order => {
					const orderElement = createOrderElement(order);
					ordersContainer.appendChild(orderElement);
					initFeedbackUpload(order.id);
				});
			}

			// ==================== 优化：创建订单元素 ====================
			function createOrderElement(order) {
				const orderElement = document.createElement('div');
				orderElement.className = 'admin-order-item';

				let statusText, statusClass;
				switch (order.status) {
					case 'new':
						statusText = '新订单';
						statusClass = 'status-new';
						break;
					case 'processing':
						statusText = '处理中';
						statusClass = 'status-processing';
						break;
					case 'completed':
						statusText = '已完成';
						statusClass = 'status-completed';
						break;
					default:
						statusText = '新订单';
						statusClass = 'status-new';
				}

				const deliveryTypeText = order.deliveryType === 'delivery' ? '宅急送' :
					`到店自提${order.pickupType ? ` (${order.pickupType})` : ''}`;

				let itemsHTML = '';
				order.cart.forEach(item => {
					const optionCount = {};
					item.options.forEach(option => {
						optionCount[option] = (optionCount[option] || 0) + 1;
					});

					const optionText = Object.keys(optionCount).map(option => {
						const count = optionCount[option];
						return `${option}${count > 1 ? ` ×${count}` : ''}`;
					}).join(', ');

					itemsHTML +=
						`<div class="order-item-detail">
                    <div><strong>${item.name}</strong> - ¥${item.totalPrice.toFixed(2)}</div>
                    <div style="font-size:0.8rem; color:#666;">${optionText}</div>
                </div>`;
				});

				const infoLines = order.deliveryInfo.split('\n');
				let deliveryHTML = '';
				infoLines.forEach(line => {
					if (line.trim()) {
						deliveryHTML += `<p>${line}</p>`;
					}
				});

				let screenshotHTML = '';
				if (order.hasScreenshot && order.screenshotData) {
					screenshotHTML =
						`
                    <div class="screenshot-container">
                        <p><strong>配送/门店截图：</strong></p>
                        <img src="${order.screenshotData}" alt="配送/门店截图" class="screenshot-thumbnail" data-order-id="${order.id}">
                    </div>
                `;
				}

				let feedbackHTML = '';
				if (order.feedbackScreenshotData) {
					feedbackHTML =
						`
                    <div class="feedback-screenshot-container">
                        <h4><i class="fas fa-check-circle"></i> 订单反馈截图（顾客可见）</h4>
                        <img src="${order.feedbackScreenshotData}" alt="订单反馈截图" class="feedback-thumbnail" data-order-id="${order.id}" style="max-height: 250px; object-fit: contain;">
                        <p style="font-size:0.9rem; color:#2e7d32; margin-top: 8px; font-weight: bold; text-align: center;">
                            <i class="fas fa-info-circle"></i> 已上传反馈给顾客，点击图片可查看大图
                        </p>
                    </div>
                `;
				}

				const userInfo = order.userId ? `<p><strong>用户ID：</strong>${order.userId.substring(0, 12)}...</p>` : '';

				const feedbackUploadHTML =
					`
                <div class="feedback-upload-area" id="feedbackUploadArea-${order.id}">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>点击上传订单反馈截图</p>
                    <p class="upload-hint">支持 JPG、PNG 格式，上传后顾客可以在"我的订单"页面查看</p>
                    <input type="file" id="feedbackScreenshot-${order.id}" accept="image/*">
                </div>
                <div class="feedback-preview" id="feedbackPreview-${order.id}">
                    <div class="screenshot-preview-container">
                        <img id="feedbackPreviewImage-${order.id}" src="" alt="反馈截图预览" style="max-height: 200px; object-fit: contain;">
                        <div class="image-info" id="feedbackImageInfo-${order.id}"></div>
                    </div>
                    <button type="button" class="remove-feedback" id="removeFeedback-${order.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <button class="feedback-btn" id="uploadFeedbackBtn-${order.id}">
                    <i class="fas fa-upload"></i>
                    上传订单反馈截图
                </button>
            `;

				orderElement.innerHTML =
					`
                <div class="order-id">订单号：${order.id}</div>
                <div class="order-time">${order.timestamp} | ${deliveryTypeText}</div>
                <div class="order-status ${statusClass}">${statusText}</div>
                
                <div class="order-details">
                    <div class="order-items">
                        ${itemsHTML}
                    </div>
                    
                    <div class="order-total">
                        总计：¥${order.totalPrice.toFixed(2)}
                    </div>
                </div>
                
                <div class="customer-info">
                    ${deliveryHTML}
                    ${userInfo}
                    ${order.orderNote ? `<p><strong>备注：</strong>${order.orderNote}</p>` : ''}
                    ${screenshotHTML}
                    ${feedbackHTML}
                </div>
                
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label">上传订单反馈截图给顾客</label>
                    ${feedbackUploadHTML}
                </div>
                
                <div class="action-buttons-container">
                    ${order.status === 'new' ? `<button class="filter-btn" data-action="process" data-order-id="${order.id}">标记为处理中</button>` : ''}
                    ${order.status === 'processing' ? `<button class="filter-btn" data-action="complete" data-order-id="${order.id}">标记为已完成</button>` : ''}
                    <button class="filter-btn" style="background-color: #f44336; color: white;" data-action="delete" data-order-id="${order.id}">删除订单</button>
                </div>
            `;

				orderElement.querySelectorAll('button[data-action]').forEach(btn => {
					btn.addEventListener('click', function() {
						const action = this.dataset.action;
						const orderId = this.dataset.orderId;
						handleOrderAction(action, orderId);
					});
				});

				if (order.hasScreenshot && order.screenshotData) {
					const screenshotImg = orderElement.querySelector('.screenshot-thumbnail');
					if (screenshotImg) {
						screenshotImg.addEventListener('click', function() {
							showFullImage(order.screenshotData);
						});
					}
				}

				if (order.feedbackScreenshotData) {
					const feedbackImg = orderElement.querySelector('.feedback-thumbnail');
					if (feedbackImg) {
						feedbackImg.addEventListener('click', function() {
							showFullImage(order.feedbackScreenshotData);
						});
					}
				}

				return orderElement;
			}

			// ==================== 修复：初始化反馈截图上传功能 ====================
			function initFeedbackUpload(orderId) {
				const uploadArea = document.getElementById(`feedbackUploadArea-${orderId}`);
				const fileInput = document.getElementById(`feedbackScreenshot-${orderId}`);
				const previewContainer = document.getElementById(`feedbackPreview-${orderId}`);
				const previewImage = document.getElementById(`feedbackPreviewImage-${orderId}`);
				const removeBtn = document.getElementById(`removeFeedback-${orderId}`);
				const uploadBtn = document.getElementById(`uploadFeedbackBtn-${orderId}`);

				if (!uploadArea || !fileInput) {
					console.warn(`找不到上传区域或文件输入，orderId: ${orderId}`);
					return;
				}

				if (previewContainer) previewContainer.style.display = 'none';
				if (uploadBtn) uploadBtn.style.display = 'none';

				fileInput.style.position = 'absolute';
				fileInput.style.top = '0';
				fileInput.style.left = '0';
				fileInput.style.width = '100%';
				fileInput.style.height = '100%';
				fileInput.style.opacity = '0';
				fileInput.style.cursor = 'pointer';

				fileInput.addEventListener('change', async function(e) {
					if (e.target.files.length) {
						await handleFeedbackFileSelect(e.target.files[0], orderId);
						if (uploadBtn) uploadBtn.style.display = 'flex';
					}
				});

				if (removeBtn) {
					removeBtn.addEventListener('click', function() {
						fileInput.value = '';
						if (previewContainer) previewContainer.style.display = 'none';
						if (uploadArea) uploadArea.style.display = 'block';
						if (uploadBtn) uploadBtn.style.display = 'none';
						if (previewImage) previewImage.src = '';

						const imageInfo = document.getElementById(`feedbackImageInfo-${orderId}`);
						if (imageInfo) {
							imageInfo.innerHTML = '';
						}
					});
				}

				if (uploadBtn) {
					uploadBtn.addEventListener('click', async function() {
						if (!previewImage || !previewImage.src) {
							showNotification('请先选择反馈截图', 'error');
							return;
						}

						try {
							const orderIndex = orders.findIndex(o => o.id === orderId);
							if (orderIndex === -1) return;

							showLoading('正在上传反馈截图...');

							const order = orders[orderIndex];
							order.feedbackScreenshotData = previewImage.src;

							const updatedOrder = await LeanCloudData.saveOrder(order);
							orders[orderIndex] = updatedOrder;

							localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));

							hideLoading();
							showNotification('订单反馈截图上传成功！顾客可以在"我的订单"页面查看', 'success');

							const activeFilterBtn = document.querySelector('.filter-btn.active');
							const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
							renderOrders(activeFilter);

							showRealtimeIndicator('订单反馈截图已上传');
						} catch (error) {
							console.error('上传反馈截图失败:', error);
							hideLoading();
							showNotification('上传失败，请检查网络连接', 'error');
						}
					});
				}
			}

			// 处理反馈截图文件选择（已修复）
			async function handleFeedbackFileSelect(file, orderId) {
				if (!file.type.match('image.*')) {
					showNotification('请选择图片文件', 'error');
					return;
				}

				const previewContainer = document.getElementById(`feedbackPreview-${orderId}`);
				const previewImage = document.getElementById(`feedbackPreviewImage-${orderId}`);
				const uploadArea = document.getElementById(`feedbackUploadArea-${orderId}`);
				const imageInfo = document.getElementById(`feedbackImageInfo-${orderId}`);

				const compressedImage = await compressImageOptimized(file);

				const reader = new FileReader();
				reader.onload = function(e) {
					if (previewImage) previewImage.src = e.target.result;
					if (previewContainer) {
						previewContainer.style.display = 'block';
						previewContainer.classList.add('show');
					}
					if (uploadArea) uploadArea.style.display = 'none';

					if (imageInfo) {
						const originalSize = (file.size / 1024).toFixed(2);
						const compressedSize = (compressedImage.size / 1024).toFixed(2);
						const compressionRatio = ((1 - compressedImage.size / file.size) * 100).toFixed(1);
						imageInfo.innerHTML =
							`
                        原始大小: ${originalSize}KB<br>
                        压缩后: ${compressedSize}KB<br>
                        压缩率: ${compressionRatio}%
                    `;
					}
				};
				reader.readAsDataURL(compressedImage);
			}

			async function handleOrderAction(action, orderId) {
				const orderIndex = orders.findIndex(o => o.id === orderId);
				if (orderIndex === -1) return;

				let confirmMessage = '';

				switch (action) {
					case 'process':
						confirmMessage = `确认将订单 ${orderId} 标记为处理中吗？`;
						break;
					case 'complete':
						confirmMessage = `确认将订单 ${orderId} 标记为已完成吗？`;
						break;
					case 'delete':
						confirmMessage = `确认删除订单 ${orderId} 吗？`;
						break;
				}

				if (confirm(confirmMessage)) {
					try {
						const order = orders[orderIndex];

						switch (action) {
							case 'process':
								order.status = 'processing';
								break;
							case 'complete':
								order.status = 'completed';
								break;
							case 'delete':
								await LeanCloudData.deleteOrder(orderId);
								orders.splice(orderIndex, 1);
								break;
						}

						if (action !== 'delete') {
							const updatedOrder = await LeanCloudData.saveOrder(order);
							orders[orderIndex] = updatedOrder;
						}

						localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));

						const activeFilterBtn = document.querySelector('.filter-btn.active');
						const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';

						renderOrders(activeFilter);

						showNotification(`订单 ${orderId} 操作成功`, 'success');
					} catch (error) {
						console.error('订单操作失败:', error);
						showNotification('操作失败，请检查网络连接', 'error');
					}
				}
			}

			// ==================== 套餐管理 ====================
			function initStatusToggle() {
				const statusToggle = document.getElementById('mealActive');
				const statusText = document.getElementById('statusText');
				const supportDeliveryToggle = document.getElementById('mealSupportDelivery');
				const supportDeliveryText = document.getElementById('supportDeliveryText');

				if (statusToggle && statusText) {
					statusToggle.addEventListener('change', function() {
						if (this.checked) {
							statusText.textContent = '上架';
							statusText.className = 'status-active';
						} else {
							statusText.textContent = '下架';
							statusText.className = 'status-inactive';
						}
					});
				}

				if (supportDeliveryToggle && supportDeliveryText) {
					supportDeliveryToggle.addEventListener('change', function() {
						if (this.checked) {
							supportDeliveryText.textContent = '支持';
							supportDeliveryText.className = 'status-active';
						} else {
							supportDeliveryText.textContent = '不支持';
							supportDeliveryText.className = 'status-inactive';
						}
					});
				}
			}

			// ==================== 新增：选项组和选项项管理功能 ====================
			function initMealManagement() {
				updateMealList('all');

				document.querySelectorAll('.meal-filter-btn').forEach(btn => {
					btn.addEventListener('click', function() {
						document.querySelectorAll('.meal-filter-btn').forEach(b => {
							b.classList.remove('active');
						});

						this.classList.add('active');

						const filter = this.dataset.mealFilter;
						showMealList();
						updateMealList(filter);
					});
				});

				document.getElementById('addOptionGroupBtn').addEventListener('click', function() {
					addOptionGroup('edit');
				});

				document.getElementById('addFixedItemBtn').addEventListener('click', function() {
					addFixedItem('edit');
				});

				document.getElementById('saveMealBtn').addEventListener('click', async function() {
					await saveMeal();
				});

				document.getElementById('cancelEditBtn').addEventListener('click', function() {
					showMealList();
				});

				document.addEventListener('keydown', function(e) {
					if ((e.ctrlKey || e.metaKey) && e.key === 's' &&
						document.getElementById('editMealFormContainer').classList.contains('active')) {
						e.preventDefault();
						saveMeal();
					}

					if (e.key === 'Escape' && document.getElementById('editMealFormContainer').classList.contains('active')) {
						showMealList();
					}
				});

				const statusToggle = document.getElementById('mealActive');
				if (statusToggle) {
					statusToggle.addEventListener('change', function() {
						const statusText = document.getElementById('statusText');
						if (this.checked) {
							statusText.textContent = '上架';
							statusText.className = 'status-active';
						} else {
							statusText.textContent = '下架';
							statusText.className = 'status-inactive';
						}
					});
				}

				const supportDeliveryToggle = document.getElementById('mealSupportDelivery');
				if (supportDeliveryToggle) {
					supportDeliveryToggle.addEventListener('change', function() {
						const supportDeliveryText = document.getElementById('supportDeliveryText');
						if (this.checked) {
							supportDeliveryText.textContent = '支持';
							supportDeliveryText.className = 'status-active';
						} else {
							supportDeliveryText.textContent = '不支持';
							supportDeliveryText.className = 'status-inactive';
						}
					});
				}

				if (document.querySelectorAll('.option-group-item').length === 0) {
					addOptionGroup('edit');
				}
			}

			// 显示套餐列表
			function showMealList() {
				document.getElementById('mealListSection').style.display = 'block';
				document.getElementById('editMealFormContainer').style.display = 'none';

				const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
				updateMealList(activeFilter);
			}

			// 显示编辑表单
			function showEditForm() {
				document.getElementById('mealListSection').style.display = 'none';
				document.getElementById('editMealFormContainer').style.display = 'block';
			}

			// ==================== 新增：添加选项组 ====================
			function addOptionGroup(type = 'edit') {
				const containerId = type === 'edit' ? 'optionGroupsManagement' : 'newOptionGroupsManagement';
				const container = document.getElementById(containerId);

				const groupId = 'group_' + Date.now();
				const groupHtml =
					`
                <div class="option-group-item" data-group-id="${groupId}">
                    <div class="option-group-header">
                        <input type="text" class="form-input" placeholder="选项组标题（例如：汉堡选择）" value="" data-field="title">
                        <div style="display: flex; gap: 8px;">
                            <button class="option-group-action-btn add-above" data-action="add-group-above" data-group-id="${groupId}">
                                <i class="fas fa-arrow-up"></i> 在上方添加选项组
                            </button>
                            <button class="option-group-action-btn add-below" data-action="add-group-below" data-group-id="${groupId}">
                                <i class="fas fa-arrow-down"></i> 在下方添加选项组
                            </button>
                            <button class="option-group-action-btn delete" data-action="delete-group" data-group-id="${groupId}">
                                <i class="fas fa-trash"></i> 删除选项组
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">选择规则</label>
                            <input type="text" class="form-input" placeholder="例如：请选择1-3个汉堡" value="" data-field="rules">
                        </div>
                        <div class="form-group">
                            <label class="form-label">最小选择数量</label>
                            <input type="number" class="form-input" min="0" value="1" data-field="minSelect">
                        </div>
                        <div class="form-group">
                            <label class="form-label">最大选择数量</label>
                            <input type="number" class="form-input" min="1" value="3" data-field="maxSelect">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">是否可重复选择</label>
                            <div class="status-label">
                                <label class="status-toggle">
                                    <input type="checkbox" data-field="repeat" checked>
                                    <span class="status-slider"></span>
                                </label>
                                <span class="status-active">是</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">每项最大选择数（可重复时有效）</label>
                            <input type="number" class="form-input" min="1" value="999" data-field="maxPerItem">
                        </div>
                    </div>
                    
                    <h4 class="option-group-title">选项项列表</h4>
                    <div class="option-items-list" id="option-items-${groupId}">
                        <div class="option-item-list-item">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <input type="text" class="form-input" placeholder="选项名称（例如：香辣鸡腿堡）" value="" data-field="item-name">
                                </div>
                                <div class="form-group">
                                    <input type="number" class="form-input" placeholder="加价（0表示不加）" min="0" step="0.01" value="0" data-field="item-addPrice">
                                </div>
                            </div>
                            <div class="option-item-actions">
                                <button class="option-item-action-btn add-above" data-action="add-item-above">
                                    <i class="fas fa-arrow-up"></i> 在上方添加
                                </button>
                                <button class="option-item-action-btn add-below" data-action="add-item-below">
                                    <i class="fas fa-arrow-down"></i> 在下方添加
                                </button>
                                <button class="option-item-action-btn delete" data-action="delete-item">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-group-actions">
                        <button class="option-group-action-btn add-above" data-action="add-item-top" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 在顶部添加选项
                        </button>
                        <button class="option-group-action-btn add-below" data-action="add-item-bottom" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 在底部添加选项
                        </button>
                    </div>
                </div>
            `;

				container.insertAdjacentHTML('beforeend', groupHtml);

				// 绑定事件
				const newGroup = container.querySelector(`[data-group-id="${groupId}"]:last-child`);
				bindOptionGroupEvents(newGroup);
			}

			// ==================== 新增：绑定选项组事件 ====================
			function bindOptionGroupEvents(groupElement) {
				const groupId = groupElement.dataset.groupId;

				// 绑定选项组操作按钮事件
				groupElement.querySelectorAll('[data-action="add-group-above"]').forEach(btn => {
					btn.addEventListener('click', function() {
						addOptionGroupAbove(groupId);
					});
				});

				groupElement.querySelectorAll('[data-action="add-group-below"]').forEach(btn => {
					btn.addEventListener('click', function() {
						addOptionGroupBelow(groupId);
					});
				});

				groupElement.querySelectorAll('[data-action="delete-group"]').forEach(btn => {
					btn.addEventListener('click', function() {
						if (confirm('确定要删除这个选项组吗？')) {
							groupElement.remove();
						}
					});
				});

				// 绑定选项项操作按钮事件
				groupElement.querySelectorAll('[data-action="add-item-top"]').forEach(btn => {
					btn.addEventListener('click', function() {
						addOptionItem(groupId, 'top');
					});
				});

				groupElement.querySelectorAll('[data-action="add-item-bottom"]').forEach(btn => {
					btn.addEventListener('click', function() {
						addOptionItem(groupId, 'bottom');
					});
				});

				// 绑定现有选项项的事件
				bindOptionItemEvents(groupElement);
			}

			// ==================== 新增：绑定选项项事件 ====================
			function bindOptionItemEvents(groupElement) {
				const itemsList = groupElement.querySelector('.option-items-list');

				// 使用事件委托来处理动态添加的选项项
				itemsList.addEventListener('click', function(e) {
					const target = e.target;

					if (target.closest('[data-action="add-item-above"]')) {
						const itemElement = target.closest('.option-item-list-item');
						addOptionItemAbove(itemElement);
					} else if (target.closest('[data-action="add-item-below"]')) {
						const itemElement = target.closest('.option-item-list-item');
						addOptionItemBelow(itemElement);
					} else if (target.closest('[data-action="delete-item"]')) {
						const itemElement = target.closest('.option-item-list-item');
						if (itemElement && confirm('确定要删除这个选项吗？')) {
							itemElement.remove();
						}
					}
				});
			}

			// ==================== 新增：在选项组上方添加选项组 ====================
			function addOptionGroupAbove(targetGroupId) {
				const container = document.getElementById('optionGroupsManagement');
				const targetGroup = container.querySelector(`[data-group-id="${targetGroupId}"]`);

				if (!targetGroup) return;

				const groupId = 'group_' + Date.now();
				const groupHtml =
					`
                <div class="option-group-item" data-group-id="${groupId}">
                    <div class="option-group-header">
                        <input type="text" class="form-input" placeholder="选项组标题（例如：汉堡选择）" value="" data-field="title">
                        <div style="display: flex; gap: 8px;">
                            <button class="option-group-action-btn add-above" data-action="add-group-above" data-group-id="${groupId}">
                                <i class="fas fa-arrow-up"></i> 在上方添加选项组
                            </button>
                            <button class="option-group-action-btn add-below" data-action="add-group-below" data-group-id="${groupId}">
                                <i class="fas fa-arrow-down"></i> 在下方添加选项组
                            </button>
                            <button class="option-group-action-btn delete" data-action="delete-group" data-group-id="${groupId}">
                                <i class="fas fa-trash"></i> 删除选项组
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">选择规则</label>
                            <input type="text" class="form-input" placeholder="例如：请选择1-3个汉堡" value="" data-field="rules">
                        </div>
                        <div class="form-group">
                            <label class="form-label">最小选择数量</label>
                            <input type="number" class="form-input" min="0" value="1" data-field="minSelect">
                        </div>
                        <div class="form-group">
                            <label class="form-label">最大选择数量</label>
                            <input type="number" class="form-input" min="1" value="3" data-field="maxSelect">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">是否可重复选择</label>
                            <div class="status-label">
                                <label class="status-toggle">
                                    <input type="checkbox" data-field="repeat" checked>
                                    <span class="status-slider"></span>
                                </label>
                                <span class="status-active">是</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">每项最大选择数（可重复时有效）</label>
                            <input type="number" class="form-input" min="1" value="999" data-field="maxPerItem">
                        </div>
                    </div>
                    
                    <h4 class="option-group-title">选项项列表</h4>
                    <div class="option-items-list" id="option-items-${groupId}">
                        <div class="option-item-list-item">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <input type="text" class="form-input" placeholder="选项名称（例如：香辣鸡腿堡）" value="" data-field="item-name">
                                </div>
                                <div class="form-group">
                                    <input type="number" class="form-input" placeholder="加价（0表示不加）" min="0" step="0.01" value="0" data-field="item-addPrice">
                                </div>
                            </div>
                            <div class="option-item-actions">
                                <button class="option-item-action-btn add-above" data-action="add-item-above">
                                    <i class="fas fa-arrow-up"></i> 在上方添加
                                </button>
                                <button class="option-item-action-btn add-below" data-action="add-item-below">
                                    <i class="fas fa-arrow-down"></i> 在下方添加
                                </button>
                                <button class="option-item-action-btn delete" data-action="delete-item">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-group-actions">
                        <button class="option-group-action-btn add-above" data-action="add-item-top" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 在顶部添加选项
                        </button>
                        <button class="option-group-action-btn add-below" data-action="add-item-bottom" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 在底部添加选项
                        </button>
                    </div>
                </div>
            `;

				targetGroup.insertAdjacentHTML('beforebegin', groupHtml);

				// 绑定新选项组的事件
				const newGroup = container.querySelector(`[data-group-id="${groupId}"]`);
				bindOptionGroupEvents(newGroup);
			}

			// ==================== 新增：在选项组下方添加选项组 ====================
			function addOptionGroupBelow(targetGroupId) {
				const container = document.getElementById('optionGroupsManagement');
				const targetGroup = container.querySelector(`[data-group-id="${targetGroupId}"]`);

				if (!targetGroup) return;

				const groupId = 'group_' + Date.now();
				const groupHtml =
					`
                <div class="option-group-item" data-group-id="${groupId}">
                    <div class="option-group-header">
                        <input type="text" class="form-input" placeholder="选项组标题（例如：汉堡选择）" value="" data-field="title">
                        <div style="display: flex; gap: 8px;">
                            <button class="option-group-action-btn add-above" data-action="add-group-above" data-group-id="${groupId}">
                                <i class="fas fa-arrow-up"></i> 在上方添加选项组
                            </button>
                            <button class="option-group-action-btn add-below" data-action="add-group-below" data-group-id="${groupId}">
                                <i class="fas fa-arrow-down"></i> 在下方添加选项组
                            </button>
                            <button class="option-group-action-btn delete" data-action="delete-group" data-group-id="${groupId}">
                                <i class="fas fa-trash"></i> 删除选项组
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">选择规则</label>
                            <input type="text" class="form-input" placeholder="例如：请选择1-3个汉堡" value="" data-field="rules">
                        </div>
                        <div class="form-group">
                            <label class="form-label">最小选择数量</label>
                            <input type="number" class="form-input" min="0" value="1" data-field="minSelect">
                        </div>
                        <div class="form-group">
                            <label class="form-label">最大选择数量</label>
                            <input type="number" class="form-input" min="1" value="3" data-field="maxSelect">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">是否可重复选择</label>
                            <div class="status-label">
                                <label class="status-toggle">
                                    <input type="checkbox" data-field="repeat" checked>
                                    <span class="status-slider"></span>
                                </label>
                                <span class="status-active">是</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">每项最大选择数（可重复时有效）</label>
                            <input type="number" class="form-input" min="1" value="999" data-field="maxPerItem">
                        </div>
                    </div>
                    
                    <h4 class="option-group-title">选项项列表</h4>
                    <div class="option-items-list" id="option-items-${groupId}">
                        <div class="option-item-list-item">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <input type="text" class="form-input" placeholder="选项名称（例如：香辣鸡腿堡）" value="" data-field="item-name">
                                </div>
                                <div class="form-group">
                                    <input type="number" class="form-input" placeholder="加价（0表示不加）" min="0" step="0.01" value="0" data-field="item-addPrice">
                                </div>
                            </div>
                            <div class="option-item-actions">
                                <button class="option-item-action-btn add-above" data-action="add-item-above">
                                    <i class="fas fa-arrow-up"></i> 在上方添加
                                </button>
                                <button class="option-item-action-btn add-below" data-action="add-item-below">
                                    <i class="fas fa-arrow-down"></i> 在下方添加
                                </button>
                                <button class="option-item-action-btn delete" data-action="delete-item">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-group-actions">
                        <button class="option-group-action-btn add-above" data-action="add-item-top" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 在顶部添加选项
                        </button>
                        <button class="option-group-action-btn add-below" data-action="add-item-bottom" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 在底部添加选项
                        </button>
                    </div>
                </div>
            `;

				targetGroup.insertAdjacentHTML('afterend', groupHtml);

				// 绑定新选项组的事件
				const newGroup = container.querySelector(`[data-group-id="${groupId}"]`);
				bindOptionGroupEvents(newGroup);
			}

			// ==================== 新增：添加选项项 ====================
			function addOptionItem(groupId, position = 'bottom', relativeItem = null) {
				const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
				if (!groupElement) return;

				const itemsList = groupElement.querySelector('.option-items-list');
				const itemHtml =
					`
                <div class="option-item-list-item">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" class="form-input" placeholder="选项名称（例如：香辣鸡腿堡）" value="" data-field="item-name">
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-input" placeholder="加价（0表示不加）" min="0" step="0.01" value="0" data-field="item-addPrice">
                        </div>
                    </div>
                    <div class="option-item-actions">
                        <button class="option-item-action-btn add-above" data-action="add-item-above">
                            <i class="fas fa-arrow-up"></i> 在上方添加
                        </button>
                        <button class="option-item-action-btn add-below" data-action="add-item-below">
                            <i class="fas fa-arrow-down"></i> 在下方添加
                        </button>
                        <button class="option-item-action-btn delete" data-action="delete-item">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `;

				if (position === 'top') {
					itemsList.insertAdjacentHTML('afterbegin', itemHtml);
				} else if (position === 'bottom') {
					itemsList.insertAdjacentHTML('beforeend', itemHtml);
				} else if (relativeItem && position === 'above') {
					relativeItem.insertAdjacentHTML('beforebegin', itemHtml);
				} else if (relativeItem && position === 'below') {
					relativeItem.insertAdjacentHTML('afterend', itemHtml);
				}

				// 重新绑定事件
				bindOptionItemEvents(groupElement);
			}

			// ==================== 新增：在选项项上方添加 ====================
			function addOptionItemAbove(itemElement) {
				const groupElement = itemElement.closest('.option-group-item');
				const groupId = groupElement.dataset.groupId;
				addOptionItem(groupId, 'above', itemElement);
			}

			// ==================== 新增：在选项项下方添加 ====================
			function addOptionItemBelow(itemElement) {
				const groupElement = itemElement.closest('.option-group-item');
				const groupId = groupElement.dataset.groupId;
				addOptionItem(groupId, 'below', itemElement);
			}

			// ==================== 新增：添加固定搭配项 ====================
			function addFixedItem(type = 'edit') {
				const containerId = type === 'edit' ? 'fixedItemsManagement' : 'newFixedItemsManagement';
				const container = document.getElementById(containerId);

				const itemHtml =
					`
                <div class="fixed-item-list-item">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" class="form-input" placeholder="固定搭配项名称（例如：香辣鸡腿堡）" value="" data-field="fixed-name">
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-input" placeholder="数量" min="1" value="1" data-field="fixed-quantity">
                        </div>
                    </div>
                    <div class="option-item-actions">
                        <button class="option-item-action-btn add-above" data-action="add-fixed-above">
                            <i class="fas fa-arrow-up"></i> 在上方添加
                        </button>
                        <button class="option-item-action-btn add-below" data-action="add-fixed-below">
                            <i class="fas fa-arrow-down"></i> 在下方添加
                        </button>
                        <button class="option-item-action-btn delete" data-action="delete-fixed">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `;

				container.insertAdjacentHTML('beforeend', itemHtml);

				// 绑定事件
				bindFixedItemEvents(container);
			}

			// ==================== 新增：绑定固定搭配项事件 ====================
			function bindFixedItemEvents(container) {
				// 使用事件委托来处理动态添加的固定搭配项
				container.addEventListener('click', function(e) {
					const target = e.target;

					if (target.closest('[data-action="add-fixed-above"]')) {
						const itemElement = target.closest('.fixed-item-list-item');
						addFixedItemAbove(itemElement);
					} else if (target.closest('[data-action="add-fixed-below"]')) {
						const itemElement = target.closest('.fixed-item-list-item');
						addFixedItemBelow(itemElement);
					} else if (target.closest('[data-action="delete-fixed"]')) {
						const itemElement = target.closest('.fixed-item-list-item');
						if (itemElement && confirm('确定要删除这个固定搭配项吗？')) {
							itemElement.remove();
						}
					}
				});
			}

			// ==================== 新增：在固定搭配项上方添加 ====================
			function addFixedItemAbove(itemElement) {
				const container = itemElement.closest('.fixed-items-management');
				const itemHtml =
					`
                <div class="fixed-item-list-item">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" class="form-input" placeholder="固定搭配项名称（例如：香辣鸡腿堡）" value="" data-field="fixed-name">
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-input" placeholder="数量" min="1" value="1" data-field="fixed-quantity">
                        </div>
                    </div>
                    <div class="option-item-actions">
                        <button class="option-item-action-btn add-above" data-action="add-fixed-above">
                            <i class="fas fa-arrow-up"></i> 在上方添加
                        </button>
                        <button class="option-item-action-btn add-below" data-action="add-fixed-below">
                            <i class="fas fa-arrow-down"></i> 在下方添加
                        </button>
                        <button class="option-item-action-btn delete" data-action="delete-fixed">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `;

				itemElement.insertAdjacentHTML('beforebegin', itemHtml);
			}

			// ==================== 新增：在固定搭配项下方添加 ====================
			function addFixedItemBelow(itemElement) {
				const container = itemElement.closest('.fixed-items-management');
				const itemHtml =
					`
                <div class="fixed-item-list-item">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" class="form-input" placeholder="固定搭配项名称（例如：香辣鸡腿堡）" value="" data-field="fixed-name">
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-input" placeholder="数量" min="1" value="1" data-field="fixed-quantity">
                        </div>
                    </div>
                    <div class="option-item-actions">
                        <button class="option-item-action-btn add-above" data-action="add-fixed-above">
                            <i class="fas fa-arrow-up"></i> 在上方添加
                        </button>
                        <button class="option-item-action-btn add-below" data-action="add-fixed-below">
                            <i class="fas fa-arrow-down"></i> 在下方添加
                        </button>
                        <button class="option-item-action-btn delete" data-action="delete-fixed">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            `;

				itemElement.insertAdjacentHTML('afterend', itemHtml);
			}

			// ==================== 新增：初始化新套餐管理 ====================
			function initNewMealManagement() {
				document.getElementById('newAddOptionGroupBtn').addEventListener('click', function() {
					addOptionGroup('new');
				});

				document.getElementById('newAddFixedItemBtn').addEventListener('click', function() {
					addFixedItem('new');
				});

				document.getElementById('saveNewMealBtn').addEventListener('click', async function() {
					await saveNewMeal();
				});

				const statusToggle = document.getElementById('newMealActive');
				if (statusToggle) {
					statusToggle.addEventListener('change', function() {
						const statusText = document.getElementById('newStatusText');
						if (this.checked) {
							statusText.textContent = '上架';
							statusText.className = 'status-active';
						} else {
							statusText.textContent = '下架';
							statusText.className = 'status-inactive';
						}
					});
				}

				const supportDeliveryToggle = document.getElementById('newMealSupportDelivery');
				if (supportDeliveryToggle) {
					supportDeliveryToggle.addEventListener('change', function() {
						const supportDeliveryText = document.getElementById('newSupportDeliveryText');
						if (this.checked) {
							supportDeliveryText.textContent = '支持';
							supportDeliveryText.className = 'status-active';
						} else {
							supportDeliveryText.textContent = '不支持';
							supportDeliveryText.className = 'status-inactive';
						}
					});
				}

				// 添加一个初始的选项组
				if (document.querySelectorAll('#newOptionGroupsManagement .option-group-item').length === 0) {
					addOptionGroup('new');
				}
			}

			// ==================== 新增：保存新套餐 ====================
			async function saveNewMeal() {
				try {
					const mealName = document.getElementById('newMealName').value.trim();
					const mealPrice = parseFloat(document.getElementById('newMealPrice').value);
					const mealOrder = parseInt(document.getElementById('newMealOrder').value) || 9999;
					const mealTags = document.getElementById('newMealTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
					const mealDescription = document.getElementById('newMealDescription').value.trim();
					const mealActive = document.getElementById('newMealActive').checked;
					const mealSupportDelivery = document.getElementById('newMealSupportDelivery').checked;

					if (!mealName || isNaN(mealPrice) || !mealTags.length || !mealDescription) {
						showNotification('请填写所有必填字段', 'error');
						return;
					}

					// 收集选项组数据
					const optionGroups = [];
					document.querySelectorAll('#newOptionGroupsManagement .option-group-item').forEach(groupElement => {
						const title = groupElement.querySelector('[data-field="title"]').value.trim();
						const rules = groupElement.querySelector('[data-field="rules"]').value.trim();
						const minSelect = parseInt(groupElement.querySelector('[data-field="minSelect"]').value) || 0;
						const maxSelect = parseInt(groupElement.querySelector('[data-field="maxSelect"]').value) || 1;
						const repeat = groupElement.querySelector('[data-field="repeat"]').checked;
						const maxPerItem = parseInt(groupElement.querySelector('[data-field="maxPerItem"]').value) || (repeat ? 999 :
							1);

						const items = [];
						groupElement.querySelectorAll('.option-item-list-item').forEach(itemElement => {
							const name = itemElement.querySelector('[data-field="item-name"]').value.trim();
							const addPrice = parseFloat(itemElement.querySelector('[data-field="item-addPrice"]').value) || 0;

							if (name) {
								items.push({
									name: name,
									addPrice: addPrice
								});
							}
						});

						if (title && items.length > 0) {
							optionGroups.push({
								title: title,
								rules: rules,
								minSelect: minSelect,
								maxSelect: maxSelect,
								repeat: repeat,
								maxPerItem: maxPerItem,
								items: items
							});
						}
					});

					// 收集固定搭配数据
					const fixedItems = [];
					document.querySelectorAll('#newFixedItemsManagement .fixed-item-list-item').forEach(itemElement => {
						const name = itemElement.querySelector('[data-field="fixed-name"]').value.trim();
						const quantity = parseInt(itemElement.querySelector('[data-field="fixed-quantity"]').value) || 1;

						if (name) {
							fixedItems.push({
								name: name,
								quantity: quantity
							});
						}
					});

					if (optionGroups.length === 0) {
						showNotification('至少需要一个有效的选项组', 'error');
						return;
					}

					showLoading('正在保存套餐...');

					const mealId = 'meal_' + Date.now().toString().slice(-6) + Math.floor(Math.random() * 100);

					const meal = {
						id: mealId,
						name: mealName,
						price: mealPrice,
						order: mealOrder,
						tags: mealTags,
						description: mealDescription,
						active: mealActive,
						supportDelivery: mealSupportDelivery,
						optionGroups: optionGroups,
						fixedItems: fixedItems,
						createdAt: Date.now(),
						updatedAt: Date.now()
					};

					const savedMeal = await LeanCloudData.saveMeal(meal);

					meals.push(savedMeal);
					localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
						id: m.id,
						name: m.name,
						price: m.price,
						tags: m.tags,
						description: m.description,
						order: m.order,
						active: m.active,
						supportDelivery: m.supportDelivery
					}))));

					// 清空表单
					document.getElementById('newMealName').value = '';
					document.getElementById('newMealPrice').value = '';
					document.getElementById('newMealOrder').value = '9999';
					document.getElementById('newMealTags').value = '';
					document.getElementById('newMealDescription').value = '';
					document.getElementById('newMealActive').checked = true;
					document.getElementById('newMealSupportDelivery').checked = true;

					// 清空选项组和固定搭配
					document.getElementById('newOptionGroupsManagement').innerHTML = '';
					document.getElementById('newFixedItemsManagement').innerHTML = '';

					// 添加一个新的初始选项组
					addOptionGroup('new');

					hideLoading();
					showNotification('套餐添加成功！', 'success');

					// 切换到套餐管理标签
					document.querySelector('.admin-tab[data-tab="meals"]').click();
					showMealList();

				} catch (error) {
					console.error('保存新套餐失败:', error);
					hideLoading();
					showNotification('保存失败: ' + (error.message || '请检查网络连接'), 'error');
				}
			}

			// ==================== 编辑套餐功能 ====================
			function editMeal(mealId) {
				const meal = meals.find(m => m.id === mealId);
				if (!meal) return;

				showEditForm();

				// 填充表单数据
				document.getElementById('currentMealId').value = meal.id;
				document.getElementById('mealName').value = meal.name;
				document.getElementById('mealPrice').value = meal.price;
				document.getElementById('mealOrder').value = meal.order || 9999;
				document.getElementById('mealTags').value = meal.tags.join(', ');
				document.getElementById('mealDescription').value = meal.description;
				document.getElementById('mealActive').checked = meal.active !== false;
				document.getElementById('mealSupportDelivery').checked = meal.supportDelivery !== false;

				// 更新状态文本
				const statusText = document.getElementById('statusText');
				const supportDeliveryText = document.getElementById('supportDeliveryText');
				statusText.textContent = meal.active !== false ? '上架' : '下架';
				statusText.className = meal.active !== false ? 'status-active' : 'status-inactive';
				supportDeliveryText.textContent = meal.supportDelivery !== false ? '支持' : '不支持';
				supportDeliveryText.className = meal.supportDelivery !== false ? 'status-active' : 'status-inactive';

				// 清空选项组和固定搭配
				document.getElementById('optionGroupsManagement').innerHTML = '';
				document.getElementById('fixedItemsManagement').innerHTML = '';

				// 填充选项组
				if (meal.optionGroups && meal.optionGroups.length > 0) {
					meal.optionGroups.forEach((group, index) => {
						const groupId = 'group_' + Date.now() + '_' + index;
						const groupHtml =
							`
                        <div class="option-group-item" data-group-id="${groupId}">
                            <div class="option-group-header">
                                <input type="text" class="form-input" placeholder="选项组标题（例如：汉堡选择）" value="${group.title || ''}" data-field="title">
                                <div style="display: flex; gap: 8px;">
                                    <button class="option-group-action-btn add-above" data-action="add-group-above" data-group-id="${groupId}">
                                        <i class="fas fa-arrow-up"></i> 在上方添加选项组
                                    </button>
                                    <button class="option-group-action-btn add-below" data-action="add-group-below" data-group-id="${groupId}">
                                        <i class="fas fa-arrow-down"></i> 在下方添加选项组
                                    </button>
                                    <button class="option-group-action-btn delete" data-action="delete-group" data-group-id="${groupId}">
                                        <i class="fas fa-trash"></i> 删除选项组
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">选择规则</label>
                                    <input type="text" class="form-input" placeholder="例如：请选择1-3个汉堡" value="${group.rules || ''}" data-field="rules">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">最小选择数量</label>
                                    <input type="number" class="form-input" min="0" value="${group.minSelect || 1}" data-field="minSelect">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">最大选择数量</label>
                                    <input type="number" class="form-input" min="1" value="${group.maxSelect || 3}" data-field="maxSelect">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">是否可重复选择</label>
                                    <div class="status-label">
                                        <label class="status-toggle">
                                            <input type="checkbox" data-field="repeat" ${group.repeat ? 'checked' : ''}>
                                            <span class="status-slider"></span>
                                        </label>
                                        <span class="${group.repeat ? 'status-active' : 'status-inactive'}">${group.repeat ? '是' : '否'}</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">每项最大选择数（可重复时有效）</label>
                                    <input type="number" class="form-input" min="1" value="${group.maxPerItem || (group.repeat ? 999 : 1)}" data-field="maxPerItem">
                                </div>
                            </div>
                            
                            <h4 class="option-group-title">选项项列表</h4>
                            <div class="option-items-list" id="option-items-${groupId}">
                                ${group.items ? group.items.map(item => `
                                    <div class="option-item-list-item">
                                        <div class="form-row">
                                            <div class="form-group" style="flex: 2;">
                                                <input type="text" class="form-input" placeholder="选项名称（例如：香辣鸡腿堡）" value="${item.name || ''}" data-field="item-name">
                                            </div>
                                            <div class="form-group">
                                                <input type="number" class="form-input" placeholder="加价（0表示不加）" min="0" step="0.01" value="${item.addPrice || 0}" data-field="item-addPrice">
                                            </div>
                                        </div>
                                        <div class="option-item-actions">
                                            <button class="option-item-action-btn add-above" data-action="add-item-above">
                                                <i class="fas fa-arrow-up"></i> 在上方添加
                                            </button>
                                            <button class="option-item-action-btn add-below" data-action="add-item-below">
                                                <i class="fas fa-arrow-down"></i> 在下方添加
                                            </button>
                                            <button class="option-item-action-btn delete" data-action="delete-item">
                                                <i class="fas fa-trash"></i> 删除
                                            </button>
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            
                            <div class="option-group-actions">
                                <button class="option-group-action-btn add-above" data-action="add-item-top" data-group-id="${groupId}">
                                    <i class="fas fa-plus"></i> 在顶部添加选项
                                </button>
                                <button class="option-group-action-btn add-below" data-action="add-item-bottom" data-group-id="${groupId}">
                                    <i class="fas fa-plus"></i> 在底部添加选项
                                </button>
                            </div>
                        </div>
                    `;

						document.getElementById('optionGroupsManagement').insertAdjacentHTML('beforeend', groupHtml);

						// 绑定事件
						const newGroup = document.querySelector(`[data-group-id="${groupId}"]:last-child`);
						bindOptionGroupEvents(newGroup);
					});
				} else {
					// 如果没有选项组，添加一个初始的
					addOptionGroup('edit');
				}

				// 填充固定搭配
				if (meal.fixedItems && meal.fixedItems.length > 0) {
					meal.fixedItems.forEach(item => {
						const itemHtml =
							`
                        <div class="fixed-item-list-item">
                            <div class="form-row">
                                <div class="form-group" style="flex: 2;">
                                    <input type="text" class="form-input" placeholder="固定搭配项名称（例如：香辣鸡腿堡）" value="${item.name || ''}" data-field="fixed-name">
                                </div>
                                <div class="form-group">
                                    <input type="number" class="form-input" placeholder="数量" min="1" value="${item.quantity || 1}" data-field="fixed-quantity">
                                </div>
                            </div>
                            <div class="option-item-actions">
                                <button class="option-item-action-btn add-above" data-action="add-fixed-above">
                                    <i class="fas fa-arrow-up"></i> 在上方添加
                                </button>
                                <button class="option-item-action-btn add-below" data-action="add-fixed-below">
                                    <i class="fas fa-arrow-down"></i> 在下方添加
                                </button>
                                <button class="option-item-action-btn delete" data-action="delete-fixed">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    `;

						document.getElementById('fixedItemsManagement').insertAdjacentHTML('beforeend', itemHtml);
					});

					// 绑定事件
					bindFixedItemEvents(document.getElementById('fixedItemsManagement'));
				}

				// 滚动到顶部
				document.getElementById('editMealFormContainer').scrollIntoView({
					behavior: 'smooth'
				});
			}

			// ==================== 保存套餐 ====================
			async function saveMeal() {
				try {
					const mealId = document.getElementById('currentMealId').value;
					const mealName = document.getElementById('mealName').value.trim();
					const mealPrice = parseFloat(document.getElementById('mealPrice').value);
					const mealOrder = parseInt(document.getElementById('mealOrder').value) || 9999;
					const mealTags = document.getElementById('mealTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
					const mealDescription = document.getElementById('mealDescription').value.trim();
					const mealActive = document.getElementById('mealActive').checked;
					const mealSupportDelivery = document.getElementById('mealSupportDelivery').checked;

					if (!mealId || !mealName || isNaN(mealPrice) || !mealTags.length || !mealDescription) {
						showNotification('请填写所有必填字段', 'error');
						return;
					}

					// 收集选项组数据
					const optionGroups = [];
					document.querySelectorAll('#optionGroupsManagement .option-group-item').forEach(groupElement => {
						const title = groupElement.querySelector('[data-field="title"]').value.trim();
						const rules = groupElement.querySelector('[data-field="rules"]').value.trim();
						const minSelect = parseInt(groupElement.querySelector('[data-field="minSelect"]').value) || 0;
						const maxSelect = parseInt(groupElement.querySelector('[data-field="maxSelect"]').value) || 1;
						const repeat = groupElement.querySelector('[data-field="repeat"]').checked;
						const maxPerItem = parseInt(groupElement.querySelector('[data-field="maxPerItem"]').value) || (repeat ? 999 :
							1);

						const items = [];
						groupElement.querySelectorAll('.option-item-list-item').forEach(itemElement => {
							const name = itemElement.querySelector('[data-field="item-name"]').value.trim();
							const addPrice = parseFloat(itemElement.querySelector('[data-field="item-addPrice"]').value) || 0;

							if (name) {
								items.push({
									name: name,
									addPrice: addPrice
								});
							}
						});

						if (title && items.length > 0) {
							optionGroups.push({
								title: title,
								rules: rules,
								minSelect: minSelect,
								maxSelect: maxSelect,
								repeat: repeat,
								maxPerItem: maxPerItem,
								items: items
							});
						}
					});

					// 收集固定搭配数据
					const fixedItems = [];
					document.querySelectorAll('#fixedItemsManagement .fixed-item-list-item').forEach(itemElement => {
						const name = itemElement.querySelector('[data-field="fixed-name"]').value.trim();
						const quantity = parseInt(itemElement.querySelector('[data-field="fixed-quantity"]').value) || 1;

						if (name) {
							fixedItems.push({
								name: name,
								quantity: quantity
							});
						}
					});

					if (optionGroups.length === 0) {
						showNotification('至少需要一个有效的选项组', 'error');
						return;
					}

					showLoading('正在保存套餐...');

					const mealIndex = meals.findIndex(m => m.id === mealId);
					if (mealIndex === -1) {
						showNotification('套餐不存在', 'error');
						hideLoading();
						return;
					}

					const meal = {
						...meals[mealIndex],
						name: mealName,
						price: mealPrice,
						order: mealOrder,
						tags: mealTags,
						description: mealDescription,
						active: mealActive,
						supportDelivery: mealSupportDelivery,
						optionGroups: optionGroups,
						fixedItems: fixedItems,
						updatedAt: Date.now()
					};

					const savedMeal = await LeanCloudData.saveMeal(meal);

					meals[mealIndex] = savedMeal;
					localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
						id: m.id,
						name: m.name,
						price: m.price,
						tags: m.tags,
						description: m.description,
						order: m.order,
						active: m.active,
						supportDelivery: m.supportDelivery
					}))));

					hideLoading();
					showNotification('套餐保存成功！', 'success');

					// 返回套餐列表
					showMealList();

					// 更新套餐列表显示
					const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
					updateMealList(activeFilter);

				} catch (error) {
					console.error('保存套餐失败:', error);
					hideLoading();
					showNotification('保存失败: ' + (error.message || '请检查网络连接'), 'error');
				}
			}

			// ==================== 删除套餐 ====================
			async function deleteMeal(mealId) {
				if (!confirm('确定要删除这个套餐吗？此操作不可恢复！')) {
					return;
				}

				try {
					showLoading('正在删除套餐...');

					await LeanCloudData.deleteMeal(mealId);

					const mealIndex = meals.findIndex(m => m.id === mealId);
					if (mealIndex !== -1) {
						meals.splice(mealIndex, 1);
					}

					localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
						id: m.id,
						name: m.name,
						price: m.price,
						tags: m.tags,
						description: m.description,
						order: m.order,
						active: m.active,
						supportDelivery: m.supportDelivery
					}))));

					hideLoading();
					showNotification('套餐删除成功！', 'success');

					const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
					updateMealList(activeFilter);

				} catch (error) {
					console.error('删除套餐失败:', error);
					hideLoading();
					showNotification('删除失败，请检查网络连接', 'error');
				}
			}

			// ==================== 更新套餐列表 ====================
			function updateMealList(filter = 'all') {
				const mealList = document.getElementById('mealList');
				const noMealsAdminMessage = document.getElementById('noMealsAdminMessage');
				const adminMealSearchInput = document.getElementById('adminMealSearchInput');

				// 如果有搜索内容，使用搜索功能
				if (adminMealSearchInput && adminMealSearchInput.value.trim()) {
					adminSearchMeals(adminMealSearchInput.value.trim());
					return;
				}

				mealList.innerHTML = '';

				let filteredMeals = meals;
				if (filter === 'active') {
					filteredMeals = meals.filter(meal => meal.active !== false);
				} else if (filter === 'inactive') {
					filteredMeals = meals.filter(meal => meal.active === false);
				} else if (filter === 'delivery') {
					filteredMeals = meals.filter(meal => meal.supportDelivery !== false);
				} else if (filter === 'no-delivery') {
					filteredMeals = meals.filter(meal => meal.supportDelivery === false);
				}

				filteredMeals.sort((a, b) => {
					const orderDiff = (a.order || 9999) - (b.order || 9999);
					if (orderDiff !== 0) return orderDiff;
					const aTime = a.createdAt || 0;
					const bTime = b.createdAt || 0;
					return bTime - aTime;
				});

				if (filteredMeals.length === 0) {
					noMealsAdminMessage.style.display = 'block';
					return;
				}

				noMealsAdminMessage.style.display = 'none';

				filteredMeals.forEach(meal => {
					const mealItem = document.createElement('div');
					mealItem.className = 'meal-list-item';

					let totalOptions = 0;
					if (meal.optionGroups && meal.optionGroups.length > 0) {
						meal.optionGroups.forEach(group => {
							if (group.items) {
								totalOptions += group.items.length;
							}
						});
					}

					let totalFixed = 0;
					if (meal.fixedItems && meal.fixedItems.length > 0) {
						meal.fixedItems.forEach(item => {
							totalFixed += item.quantity || 1;
						});
					}

					const createdAt = meal.createdAt ? new Date(meal.createdAt).toLocaleString('zh-CN') : '未知时间';

					const sortControls =
						`
                    <div class="sort-order-container">
                        <label>排序:</label>
                        <input type="number" class="sort-order-input" data-meal-id="${meal.id}" value="${meal.order || 9999}" min="0" step="1">
                        <div class="sort-order-buttons">
                            <button class="sort-order-btn" data-action="move-up" data-meal-id="${meal.id}" title="上移"><i class="fas fa-arrow-up"></i></button>
                            <button class="sort-order-btn" data-action="move-down" data-meal-id="${meal.id}" title="下移"><i class="fas fa-arrow-down"></i></button>
                            <button class="sort-order-btn" data-action="apply-order" data-meal-id="${meal.id}" title="应用排序"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                `;

					mealItem.innerHTML =
						`
                    <div class="meal-list-item-info">
                        <h4>${meal.name} ${meal.active === false ? '<span class="status-inactive">(已下架)</span>' : '<span class="status-active">(已上架)</span>'}</h4>
                        <p><strong>价格:</strong> ¥${meal.price} | <strong>标签:</strong> ${meal.tags.join(', ')}</p>
                        <p><strong>描述:</strong> ${meal.description}</p>
                        <p><strong>配送:</strong> ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'} | 
                           <strong>创建时间:</strong> ${createdAt} | <strong>排序值:</strong> <span class="order-display">${meal.order || 9999}</span></p>
                        <p><strong>选项组:</strong> ${meal.optionGroups ? meal.optionGroups.length : 0} 个 | 
                           <strong>选项项:</strong> ${totalOptions} 个 | 
                           <strong>固定搭配:</strong> ${totalFixed} 项</p>
                    </div>
                    <div class="meal-list-item-actions">
                        <div class="status-label">
                            <label class="status-toggle">
                                <input type="checkbox" class="status-toggle-input" data-meal-id="${meal.id}" ${meal.active !== false ? 'checked' : ''}>
                                <span class="status-slider"></span>
                            </label>
                            <span class="${meal.active !== false ? 'status-active' : 'status-inactive'}">${meal.active !== false ? '上架' : '下架'}</span>
                        </div>
                        ${sortControls}
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn edit-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="action-btn delete-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;

					mealList.appendChild(mealItem);
				});

				// 绑定事件
				document.querySelectorAll('.status-toggle-input').forEach(toggle => {
					toggle.addEventListener('change', async function() {
						const mealId = this.dataset.mealId;
						const isActive = this.checked;
						await toggleMealStatus(mealId, isActive);
					});
				});

				document.querySelectorAll('.edit-btn').forEach(btn => {
					btn.addEventListener('click', function() {
						const mealId = this.dataset.mealId;
						editMeal(mealId);
					});
				});

				document.querySelectorAll('.delete-btn').forEach(btn => {
					btn.addEventListener('click', async function() {
						const mealId = this.dataset.mealId;
						await deleteMeal(mealId);
					});
				});

				document.querySelectorAll('.sort-order-btn').forEach(btn => {
					btn.addEventListener('click', async function() {
						const mealId = this.dataset.mealId;
						const action = this.dataset.action;
						await handleSortAction(action, mealId);
					});
				});

				document.querySelectorAll('.sort-order-input').forEach(input => {
					input.addEventListener('change', async function() {
						const mealId = this.dataset.mealId;
						const newOrder = parseInt(this.value) || 9999;
						await updateMealOrder(mealId, newOrder);
					});
				});
			}

			// ==================== 切换套餐状态 ====================
			async function toggleMealStatus(mealId, isActive) {
				try {
					const mealIndex = meals.findIndex(m => m.id === mealId);
					if (mealIndex === -1) return;

					const meal = meals[mealIndex];
					meal.active = isActive;

					const savedMeal = await LeanCloudData.saveMeal(meal);
					meals[mealIndex] = savedMeal;

					localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
						id: m.id,
						name: m.name,
						price: m.price,
						tags: m.tags,
						description: m.description,
						order: m.order,
						active: m.active,
						supportDelivery: m.supportDelivery
					}))));

					showNotification(`套餐已${isActive ? '上架' : '下架'}`, 'success');

					// 更新用户端显示
					updateHomePage();

				} catch (error) {
					console.error('切换套餐状态失败:', error);
					showNotification('操作失败，请检查网络连接', 'error');

					// 恢复复选框状态
					const toggle = document.querySelector(`.status-toggle-input[data-meal-id="${mealId}"]`);
					if (toggle) {
						toggle.checked = !toggle.checked;
					}
				}
			}

			// ==================== 更新套餐排序 ====================
			async function updateMealOrder(mealId, newOrder) {
				try {
					const mealIndex = meals.findIndex(m => m.id === mealId);
					if (mealIndex === -1) return;

					const meal = meals[mealIndex];
					meal.order = newOrder;

					const savedMeal = await LeanCloudData.saveMeal(meal);
					meals[mealIndex] = savedMeal;

					localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
						id: m.id,
						name: m.name,
						price: m.price,
						tags: m.tags,
						description: m.description,
						order: m.order,
						active: m.active,
						supportDelivery: m.supportDelivery
					}))));

					showNotification('排序已更新', 'success');

					// 更新显示
					const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
					updateMealList(activeFilter);

				} catch (error) {
					console.error('更新套餐排序失败:', error);
					showNotification('更新失败，请检查网络连接', 'error');
				}
			}

			// ==================== 处理排序操作 ====================
			async function handleSortAction(action, mealId) {
				const mealIndex = meals.findIndex(m => m.id === mealId);
				if (mealIndex === -1) return;

				const meal = meals[mealIndex];
				let newOrder = meal.order || 9999;

				switch (action) {
					case 'move-up':
						newOrder = Math.max(0, newOrder - 1);
						break;
					case 'move-down':
						newOrder = newOrder + 1;
						break;
					case 'apply-order':
						// 从输入框获取值
						const input = document.querySelector(`.sort-order-input[data-meal-id="${mealId}"]`);
						if (input) {
							newOrder = parseInt(input.value) || 9999;
						}
						break;
				}

				await updateMealOrder(mealId, newOrder);
			}

			// ==================== 更新订单徽章 ====================
			function updateOrderBadge() {
				const newOrderBadge = document.getElementById('newOrderBadge');

				if (newOrdersCount > 0) {
					newOrderBadge.textContent = newOrdersCount > 99 ? '99+' : newOrdersCount.toString();
					newOrderBadge.style.display = 'flex';

					if (newOrdersCount > 0 && !isAdminPanelOpen) {
						newOrderBadge.style.animation = 'pulse 2s infinite';
					} else {
						newOrderBadge.style.animation = 'none';
					}
				} else {
					newOrderBadge.style.display = 'none';
				}
			}

			// ==================== 同步数据 ====================
			async function forceSyncAllData() {
				try {
					showLoading('正在同步数据...');

					const [mealsData, ordersData, countData] = await Promise.all([
						LeanCloudData.loadMeals(),
						LeanCloudData.loadOrders(),
						LeanCloudData.loadNewOrdersCount()
					]);

					meals = mealsData;
					orders = ordersData;
					newOrdersCount = countData;

					localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
						id: m.id,
						name: m.name,
						price: m.price,
						tags: m.tags,
						description: m.description,
						order: m.order,
						active: m.active,
						supportDelivery: m.supportDelivery
					}))));

					localStorage.setItem('kfcOrdersCache', JSON.stringify(orders.map(o => ({
						id: o.id,
						timestamp: o.timestamp,
						status: o.status,
						totalPrice: o.totalPrice,
						userId: o.userId
					}))));

					localStorage.setItem('newOrdersCountCache', newOrdersCount.toString());

					updateOrderBadge();

					const activeFilterBtn = document.querySelector('.filter-btn.active');
					const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
					renderOrders(activeFilter);

					const activeMealFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
					updateMealList(activeMealFilter);

					hideLoading();
					showNotification('数据同步完成', 'success');

					return true;
				} catch (error) {
					console.error('强制同步数据失败:', error);
					hideLoading();
					showNotification('同步失败，请检查网络连接', 'error');
					return false;
				}
			}

			// ==================== 图片预览功能 ====================
			function initImagePreview() {
				const imageModal = document.getElementById('imageModal');
				const closeModal = document.getElementById('closeModal');
				const modalImage = document.getElementById('modalImage');

				closeModal.addEventListener('click', function() {
					imageModal.classList.remove('active');
					document.body.style.overflow = 'auto';
				});

				imageModal.addEventListener('click', function(e) {
					if (e.target === imageModal) {
						imageModal.classList.remove('active');
						document.body.style.overflow = 'auto';
					}
				});
			}

			function showFullImage(imageSrc) {
				const imageModal = document.getElementById('imageModal');
				const modalImage = document.getElementById('modalImage');

				modalImage.src = imageSrc;
				imageModal.classList.add('active');
				document.body.style.overflow = 'hidden';
			}


			// ==================== 修改：配送信息解析函数 - 支持分行格式 ====================

			// ==================== 新增：智能地址合并函数 ====================
			function mergeAddressParts(region, detail) {
				if (!region && !detail) return '';
				if (!region) return detail;
				if (!detail) return region;

				console.log('合并地址:', {
					region,
					detail
				});

				// 如果详细地址已经包含地区信息，直接返回详细地址
				if (detail.includes(region)) {
					console.log('详细地址已包含地区信息，直接返回详细地址');
					return detail;
				}

				// 检查地区是否以常见地址单位结尾
				const regionEndsWith = [
					'省', '市', '区', '县', '街道', '镇', '乡', '村', '路', '街', '巷'
				];

				let shouldConnect = false;
				for (let end of regionEndsWith) {
					if (region.endsWith(end)) {
						shouldConnect = true;
						break;
					}
				}

				// 如果地区以这些单位结尾，直接拼接（不加空格）
				if (shouldConnect) {
					const merged = region + detail;
					console.log('直接拼接地址:', merged);
					return merged;
				}

				// 否则加空格拼接
				const merged = region + ' ' + detail;
				console.log('加空格拼接地址:', merged);
				return merged;
			}

			// ==================== 修改：配送信息解析函数 - 完整版 ====================
			function parseDeliveryInfo(text) {
				const result = {
					name: '',
					phone: '',
					address: '',
					region: '', // 新增：存储所在地区
					detailAddress: '' // 新增：存储详细地址
				};

				console.log('原始文本:', text);

				// 1. 按行分割文本
				const lines = text.split(/[\n\r]+/).map(line => line.trim()).filter(line => line);

				console.log('分割行:', lines);

				// 2. 处理带标签的分行格式
				let hasLabelFormat = false;

				for (let line of lines) {
					// 检查是否是带标签的格式（包含冒号）
					if (line.includes(':') || line.includes('：')) {
						hasLabelFormat = true;

						// 统一用中文冒号
						const normalizedLine = line.replace(':', '：');
						const parts = normalizedLine.split('：');

						if (parts.length >= 2) {
							const label = parts[0].trim();
							const value = parts.slice(1).join('：').trim();

							console.log(`标签: "${label}", 值: "${value}"`);

							// 根据标签提取信息
							if (label.includes('手机') || label.includes('电话') || label.includes('号码')) {
								result.phone = value;
							} else if (label.includes('所在地区') || label.includes('地区')) {
								// 存储为地区部分，稍后与详细地址合并
								result.region = value;
							} else if (label.includes('详细地址') || label.includes('地址') || label.includes('收货地址')) {
								// 直接是详细地址
								result.detailAddress = value;
							} else if (label.includes('收件人') || label.includes('收货人') || label.includes('姓名') || label.includes('联系人')) {
								result.name = value;
							}
						}
					}
				}

				// 3. 如果是带标签的格式，处理地址合并逻辑
				if (hasLabelFormat) {
					console.log('检测到带标签格式，处理结果:', result);

					// 地址合并逻辑
					if (result.region && result.detailAddress) {
						// 合并地区信息和详细地址
						result.address = mergeAddressParts(result.region, result.detailAddress);
						console.log('合并后的地址:', result.address);
					} else if (result.region) {
						result.address = result.region;
					} else if (result.detailAddress) {
						result.address = result.detailAddress;
					}

					// 如果没有找到地址，但文本中有地址关键词，尝试从其他行提取
					if (!result.address || result.address.length < 5) {
						for (let line of lines) {
							// 跳过已处理的行
							if (line.includes('：') || line.includes(':')) continue;

							// 检查是否包含地址关键词
							const addressIndicators = [
								'省', '市', '区', '县', '镇', '乡', '村', '街道', '路', '街', '巷',
								'号', '栋', '楼', '单元', '室', '层', '小区', '大厦', '广场', '花园',
								'校区', '学校', '学院', '大学', '宿舍', '公寓', '幢', '座'
							];

							let hasAddressIndicator = false;
							for (let indicator of addressIndicators) {
								if (line.includes(indicator)) {
									hasAddressIndicator = true;
									break;
								}
							}

							if (hasAddressIndicator && line.length >= 5) {
								result.address = line;
								break;
							}
						}
					}

					console.log('带标签格式的最终结果:', result);
					return result;
				}

				// 4. 处理无标签的普通格式
				console.log('检测到无标签格式，使用原有逻辑');

				// 4.1 提取电话号码
				const phoneRegex = /(1[3-9]\d{9})|(\d{3,4}[-]?\d{7,8})/g;
				const phoneMatches = text.match(phoneRegex);

				if (phoneMatches && phoneMatches.length > 0) {
					result.phone = phoneMatches[0];
					text = text.replace(result.phone, '[电话]');
				}

				// 4.2 按常见分隔符分割文本
				const separators = /[,，、.。;；\n\t]/;
				const parts = text.split(separators).map(part => part.trim()).filter(part => part && part !== '[电话]');

				console.log('无标签分割后的部分:', parts);

				// 4.3 查找地址
				const addressIndicators = [
					'省', '市', '区', '县', '镇', '乡', '村', '街道', '路', '街', '巷',
					'号', '栋', '楼', '单元', '室', '层', '小区', '大厦', '广场', '花园',
					'校区', '学校', '学院', '大学', '宿舍', '公寓', '幢', '座'
				];

				let addressCandidates = [];

				for (let part of parts) {
					let isAddress = false;
					for (let indicator of addressIndicators) {
						if (part.includes(indicator)) {
							isAddress = true;
							break;
						}
					}

					if (isAddress && part.length >= 5 && !/^[\u4e00-\u9fa5]{2,4}$/.test(part)) {
						addressCandidates.push(part);
					}
				}

				console.log('无标签地址候选:', addressCandidates);

				if (addressCandidates.length > 0) {
					// 优先选择最长的候选地址
					result.address = addressCandidates.reduce((longest, current) =>
						current.length > longest.length ? current : longest, '');
				} else if (parts.length > 0) {
					// 如果没有找到明确的地址，选择最长的部分
					result.address = parts.reduce((longest, current) =>
						current.length > longest.length ? current : longest, '');
				} else {
					result.address = text.replace('[电话]', '').trim();
				}

				// 4.4 清理地址格式
				result.address = result.address
					.replace(/\s+/g, ' ')
					.replace(/[，,]+/g, '，')
					.replace(/地址[:：]?\s*/, '')
					.replace(/详细地址[:：]?\s*/, '')
					.trim();

				// 4.5 尝试提取姓名
				for (let part of parts) {
					if (part !== result.address && /^[\u4e00-\u9fa5]{2,4}$/.test(part)) {
						const commonSurnames = ['赵', '钱', '孙', '李', '周', '吴', '郑', '王', '冯', '陈', '褚', '卫', '蒋', '沈', '韩', '杨', '朱', '秦',
							'尤', '许',
							'何', '吕', '施', '张', '孔', '曹', '严', '华', '金', '魏', '陶', '姜', '戚', '谢', '邹', '喻', '柏', '水', '窦', '章', '云', '苏',
							'潘', '葛', '奚', '范', '彭', '郎',
							'鲁', '韦', '昌', '马', '苗', '凤', '花', '方', '俞', '任', '袁', '柳', '酆', '鲍', '史', '唐', '费', '廉', '岑', '薛', '雷', '贺',
							'倪', '汤', '滕', '殷',
							'罗', '毕', '郝', '邬', '安', '常', '乐', '于', '时', '傅', '皮', '卞', '齐', '康', '伍', '余', '元', '卜', '顾', '孟', '平', '黄',
							'和',
							'穆', '萧', '尹', '姚', '邵', '湛', '汪', '祁', '毛', '禹', '狄', '米', '贝', '明', '臧', '计', '伏', '成', '戴', '谈', '宋', '茅',
							'庞', '熊', '纪', '舒',
							'屈', '项', '祝', '董', '梁', '杜', '阮', '蓝', '闵', '席', '季', '麻', '强', '贾', '路', '娄', '危', '江', '童', '颜', '郭', '梅',
							'盛', '林', '刁', '钟',
							'徐', '邱', '骆', '高', '夏', '蔡', '田', '樊', '胡', '凌', '霍', '虞', '万', '支', '柯', '昝', '管', '卢', '莫', '经', '房', '裘',
							'缪', '干', '解', '应',
							'宗', '丁', '宣', '贲', '邓', '郁', '单', '杭', '洪', '包', '诸', '左', '石', '崔', '吉', '钮', '龚', '程', '嵇', '邢', '滑', '裴',
							'陆', '荣', '翁', '荀',
							'羊', '于', '惠', '甄', '曲', '家', '封', '芮', '羿', '储', '靳', '汲', '邴', '糜', '松', '井', '段', '富', '巫', '乌', '焦', '巴',
							'弓', '牧', '隗', '山',
							'谷', '车', '侯', '宓', '蓬', '全', '郗', '班', '仰', '秋', '仲', '伊', '宫', '宁', '仇', '栾', '暴', '甘', '钭', '厉', '戎', '祖',
							'武', '符', '刘', '景',
							'詹', '束', '龙', '叶', '幸', '司', '韶', '郜', '黎', '蓟', '溥', '印', '宿', '白', '怀', '蒲', '邰', '从', '鄂', '索', '咸', '籍',
							'赖', '卓', '蔺', '屠',
							'蒙', '池', '乔', '阴', '郁', '胥', '能', '苍', '双', '闻', '莘', '党', '翟', '谭', '贡', '劳', '逄', '姬', '申', '扶', '堵', '冉',
							'宰', '郦', '雍', '却',
							'璩', '桑', '桂', '濮', '牛', '寿', '通', '边', '扈', '燕', '冀', '浦', '尚', '农', '温', '别', '庄', '晏', '柴', '瞿', '阎', '充',
							'慕', '连', '茹', '习',
							'宦', '艾', '鱼', '容', '向', '古', '易', '慎', '戈', '廖', '庾', '终', '暨', '居', '衡', '步', '都', '耿', '满', '弘', '匡', '国',
							'文', '寇', '广', '禄',
							'阙', '东', '欧', '殳', '沃', '利', '蔚', '越', '夔', '隆', '师', '巩', '厍', '聂', '晁', '勾', '敖', '融', '冷', '訾', '辛', '阚',
							'那', '简', '饶', '空',
							'曾', '毋', '沙', '乜', '养', '鞠', '须', '丰', '巢', '关', '蒯', '相', '查', '后', '荆', '红', '游', '竺', '权', '逮', '盍', '益',
							'桓', '公', '万俟', '司马',
							'上官', '欧阳', '夏侯', '诸葛', '闻人', '东方', '赫连', '皇甫', '尉迟', '公羊', '澹台', '公冶', '宗政', '濮阳', '淳于', '单于', '太叔', '申屠',
							'公孙', '仲孙',
							'轩辕', '令狐', '徐离', '宇文', '长孙', '慕容', '司徒', '司空'
						];

						if (commonSurnames.includes(part.charAt(0))) {
							result.name = part;
							break;
						}
					}
				}

				console.log('最终解析结果:', result);

				return result;
			}

			// ==================== 新增：手机号验证函数 ====================
			function validatePhoneNumber(phone) {
				// 简单的手机号验证：1开头，11位数字
				return /^1[3-9]\d{9}$/.test(phone);
			}

			// ==================== 修改：配送信息解析函数 - 支持分行格式 ====================

			// 原有的智能解析方法（作为备用）
			function parseSmartDeliveryInfo(text) {
				const result = {
					name: '',
					phone: '',
					address: ''
				};

				// 1. 提取手机号（11位数字，以1开头）
				const phoneRegex = /1[3-9]\d{9}/g;
				const phoneMatches = text.match(phoneRegex);
				if (phoneMatches && phoneMatches.length > 0) {
					result.phone = phoneMatches[0];
					// 从原文本中移除手机号，避免干扰地址识别
					text = text.replace(phoneMatches[0], '');
				}

				// 2. 提取固定电话（带区号）
				const telRegex = /(0\d{2,3}-?\d{7,8})/g;
				const telMatches = text.match(telRegex);
				if (telMatches && telMatches.length > 0 && !result.phone) {
					result.phone = telMatches[0];
					text = text.replace(telMatches[0], '');
				}

				// 3. 提取姓名（2-4个中文字符）
				const nameRegex = /([\u4e00-\u9fa5]{2,4})(?=\s*[1(0])|^([\u4e00-\u9fa5]{2,4})\s+/;
				const nameMatches = text.match(nameRegex);
				if (nameMatches) {
					result.name = nameMatches[1] || nameMatches[2] || nameMatches[0];
					text = text.replace(result.name, '');
				}

				// 4. 清理文本，准备提取地址
				text = text
					.replace(/[\r\n]+/g, ' ')
					.replace(/[^\u4e00-\u9fa5\d\s\-\.·()（）]/g, '')
					.replace(/\s+/g, ' ')
					.trim();

				// 5. 提取地址（剩余的文本部分）
				if (text.trim()) {
					const address = text.replace(nameRegex, '').replace(phoneRegex, '').replace(telRegex, '').trim();

					// 常见地址关键词，帮助识别有效地址
					const addressKeywords = ['省', '市', '区', '县', '镇', '乡', '村', '街道', '路', '巷', '号', '栋', '单元', '楼', '室', '小区', '花园',
						'广场', '大厦', '公寓', '组', '弄', '胡同', '里'
					];

					// 如果包含地址关键词，认为是有效地址
					if (addressKeywords.some(keyword => address.includes(keyword))) {
						result.address = address;
					} else if (address.length > 5) { // 或者长度超过5个字符也认为是地址
						result.address = address;
					}
				}

				// 6. 验证和修正结果
				if (result.phone) {
					// 清理电话号码中的非数字字符（除了开头的0和中间的-）
					if (result.phone.includes('-')) {
						result.phone = result.phone.replace(/[^\d\-]/g, '');
					} else {
						result.phone = result.phone.replace(/\D/g, '');
					}
				}

				if (result.name && result.name.length > 4) {
					// 如果姓名太长，可能包含了其他信息，只取前4个字符
					result.name = result.name.substring(0, 4);
				}

				return result;
			}
			// ==================== 添加自动解析提示 ====================
			function addAutoParseHint() {
				// 当用户点击粘贴框时显示提示
				const fullDeliveryInfo = document.getElementById('fullDeliveryInfo');
				if (fullDeliveryInfo) {
					fullDeliveryInfo.addEventListener('focus', function() {
						const hint = document.createElement('div');
						hint.className = 'form-hint';
						hint.style.marginTop = '5px';
						hint.style.padding = '8px';
						hint.style.backgroundColor = '#e8f5e9';
						hint.style.borderRadius = '4px';
						hint.style.borderLeft = '3px solid #4CAF50';
						hint.innerHTML =
							`
                <i class="fas fa-info-circle"></i>
                <strong>粘贴示例：</strong><br>
                1. 张三 13800138000 北京市海淀区中关村大街1号<br>
                2. 李四 13900139000<br>广东省深圳市南山区科技园<br>
                3. 王五 手机号:13700137000 地址:上海市浦东新区陆家嘴
            `;

						const existingHint = this.parentNode.querySelector('.parse-hint');
						if (existingHint) {
							existingHint.remove();
						}

						hint.classList.add('parse-hint');
						this.parentNode.appendChild(hint);
					});

					fullDeliveryInfo.addEventListener('blur', function() {
						const hint = this.parentNode.querySelector('.parse-hint');
						if (hint) {
							setTimeout(() => {
								hint.remove();
							}, 1000);
						}
					});
				}
			}

			// ==================== 在页面加载完成后初始化 ====================
			// 在DOMContentLoaded事件处理函数末尾添加：
			document.addEventListener('DOMContentLoaded', function() {
				// ... 其他初始化代码 ...

				// 初始化自动解析提示
				setTimeout(addAutoParseHint, 1000);
			});

			// ==================== 添加自动解析提示 ====================
			function addAutoParseHint() {
				// 当用户点击粘贴框时显示提示
				const fullDeliveryInfo = document.getElementById('fullDeliveryInfo');
				if (fullDeliveryInfo) {
					fullDeliveryInfo.addEventListener('focus', function() {
						const hint = document.createElement('div');
						hint.className = 'form-hint';
						hint.style.marginTop = '5px';
						hint.style.padding = '8px';
						hint.style.backgroundColor = '#e8f5e9';
						hint.style.borderRadius = '4px';
						hint.style.borderLeft = '3px solid #4CAF50';
						hint.innerHTML =
							`
                <i class="fas fa-info-circle"></i>
                <strong>粘贴示例：</strong><br>
                1. 张三 13800138000 北京市海淀区中关村大街1号<br>
                2. 李四 13900139000<br>广东省深圳市南山区科技园<br>
                3. 王五 手机号:13700137000 地址:上海市浦东新区陆家嘴
            `;

						const existingHint = this.parentNode.querySelector('.parse-hint');
						if (existingHint) {
							existingHint.remove();
						}

						hint.classList.add('parse-hint');
						this.parentNode.appendChild(hint);
					});

					fullDeliveryInfo.addEventListener('blur', function() {
						const hint = this.parentNode.querySelector('.parse-hint');
						if (hint) {
							setTimeout(() => {
								hint.remove();
							}, 1000);
						}
					});
				}
			}

			// ==================== 在页面加载完成后初始化 ====================
			// 在DOMContentLoaded事件处理函数末尾添加：
			document.addEventListener('DOMContentLoaded', function() {
				// ... 其他初始化代码 ...

				// 初始化自动解析提示
				setTimeout(addAutoParseHint, 1000);
			});

			// ==================== 通知函数 ====================
			function showNotification(message, type = 'info') {
				const notification = document.createElement('div');
				notification.className = `notification ${type}`;

				let icon = 'info-circle';
				if (type === 'success') icon = 'check-circle';
				if (type === 'error') icon = 'exclamation-circle';
				if (type === 'warning') icon = 'exclamation-triangle';

				notification.innerHTML =
					`
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;

				document.body.appendChild(notification);

				setTimeout(() => {
					notification.classList.add('show');
				}, 10);

				setTimeout(() => {
					notification.classList.remove('show');
					setTimeout(() => {
						notification.remove();
					}, 300);
				}, 3000);
			}

			// 添加通知样式
			const notificationStyle = document.createElement('style');
			notificationStyle.textContent =
				`
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: white;
                border-left: 4px solid #3498db;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-radius: 6px;
                padding: 15px 20px;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 9999;
                transform: translateX(120%);
                transition: transform 0.3s ease;
                max-width: 350px;
            }
            
            .notification.show {
                transform: translateX(0);
            }
            
            .notification.success {
                border-left-color: #4CAF50;
            }
            
            .notification.error {
                border-left-color: #e31837;
            }
            
            .notification.warning {
                border-left-color: #ff9800;
            }
            
            .notification i {
                font-size: 1.2rem;
            }
            
            .notification.success i {
                color: #4CAF50;
            }
            
            .notification.error i {
                color: #e31837;
            }
            
            .notification.warning i {
                color: #ff9800;
            }
        `;
			document.head.appendChild(notificationStyle);

			// ==================== 新增：更新订单徽章样式 ====================
			const badgeStyle = document.createElement('style');
			badgeStyle.textContent =
				`
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        `;
			document.head.appendChild(badgeStyle);
		</script>
	</body>
</html>
