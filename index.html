<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>肯德基自助点餐系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 2.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .logo i {
            color: #ffcc00;
        }
        
        .header-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .info-item i {
            color: #ffcc00;
        }
        
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .header-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .search-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e31837;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(227, 24, 55, 0.2);
        }
        
        .search-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            background-color: #e31837;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background-color: #c8102e;
        }
        
        .search-hint {
            font-size: 0.9rem;
            color: #666;
            background-color: #f9f9f9;
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 4px solid #ffcc00;
        }
        
        .nav-menu {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .nav-title {
            font-size: 1.6rem;
            color: #e31837;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .meal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .meal-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border-left: 5px solid #ffcc00;
            display: block;
            text-decoration: none;
            color: inherit;
        }
        
        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .meal-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #e31837;
        }
        
        .meal-price {
            font-size: 1.6rem;
            font-weight: bold;
            color: #e31837;
        }
        
        .meal-description {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .meal-tag {
            display: inline-block;
            background-color: #ffcc00;
            color: #333;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
            margin-bottom: 5px;
        }
        
        .back-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            margin-bottom: 20px;
            text-decoration: none;
            width: fit-content;
        }
        
        .back-btn:hover {
            background-color: #c8102e;
            transform: scale(1.03);
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
        }
        
        .menu-section {
            flex: 3;
            min-width: 300px;
        }
        
        .cart-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #e31837;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ffcc00;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #ffcc00;
        }
        
        .meal-options {
            margin-bottom: 30px;
        }
        
        .option-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #e31837;
        }
        
        .option-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
            font-size: 1.1rem;
        }
        
        .option-rules {
            font-size: 0.9rem;
            color: #e31837;
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #ffe6e6;
            border-radius: 4px;
            display: inline-block;
        }
        
        .option-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .option-item {
            background-color: #f5f5f5;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.95rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 180px;
            position: relative;
        }
        
        .option-item:hover {
            background-color: #e9e9e9;
        }
        
        .option-item.selected {
            background-color: #e31837;
            color: white;
            border-color: #e31837;
        }
        
        .selection-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }
        
        .counter-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background-color: white;
            color: #e31837;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .counter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .counter-value {
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .add-to-cart {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }
        
        .add-to-cart:hover {
            background-color: #c8102e;
            transform: scale(1.03);
        }
        
        .add-to-cart:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-name {
            flex: 2;
            font-weight: 500;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: #e31837;
        }
        
        .cart-item-remove {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 10px;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }
        
        .total-price {
            color: #e31837;
        }
        
        .checkout-btn {
            background-color: #ffcc00;
            color: #333;
            border: none;
            padding: 15px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: #e6b800;
            transform: scale(1.03);
        }
        
        .checkout-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .delivery-form {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .required {
            color: #e31837;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #e31837;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .pickup-type {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .pickup-type label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            transition: all 0.3s;
            flex: 1;
        }
        
        .pickup-type label:hover {
            border-color: #e31837;
        }
        
        .pickup-type input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .order-type {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .order-type label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            transition: all 0.3s;
        }
        
        .order-type label:hover {
            border-color: #e31837;
        }
        
        .order-type input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .delivery-fields, .pickup-fields {
            transition: all 0.3s;
        }
        
        .hidden {
            display: none;
        }
        
        .store-selection {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .store-selection .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .info-method-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .method-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .method-option:hover {
            border-color: #e31837;
            background-color: #fff5f5;
        }
        
        .method-option input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .method-option input:checked {
            accent-color: #e31837;
        }
        
        .screenshot-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        
        .screenshot-upload-area:hover {
            border-color: #e31837;
            background-color: #fff5f5;
        }
        
        .screenshot-upload-area i {
            font-size: 48px;
            color: #e31837;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .screenshot-preview {
            position: relative;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
            max-width: 300px;
        }
        
        .screenshot-preview img {
            width: 100%;
            border-radius: 5px;
            display: block;
            max-height: 200px;
            object-fit: contain;
        }
        
        .remove-screenshot {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e31837;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-hint {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-hint i {
            color: #ffcc00;
        }
        
        .instructions {
            font-size: 0.9rem;
            color: #666;
            margin-top: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #ffcc00;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        .highlight {
            color: #e31837;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #fff5f5;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #ffcc00;
        }
        
        .highlight i {
            color: #ffcc00;
        }
        
        .selection-status {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: inline-block;
        }
        
        .selection-status.valid {
            background-color: #e6f7e6;
            color: #2e7d32;
        }
        
        .selection-status.invalid {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .fixed-combo-items {
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .fixed-combo-item {
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fixed-combo-item:last-child {
            border-bottom: none;
        }
        
        .fixed-combo-item-name {
            font-weight: 500;
        }
        
        .fixed-combo-item-qty {
            color: #e31837;
            font-weight: bold;
        }
        
        .my-orders-section {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .orders-search {
            margin-bottom: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .search-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background-color: #c8102e;
        }
        
        .order-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .order-filter-tab {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .order-filter-tab:hover {
            background-color: #e0e0e0;
        }
        
        .order-filter-tab.active {
            background-color: #e31837;
            color: white;
        }
        
        .user-order-item {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #ffcc00;
        }
        
        .user-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .user-order-id {
            font-weight: bold;
            color: #333;
            font-size: 1.2rem;
        }
        
        .user-order-time {
            color: #666;
            font-size: 0.95rem;
        }
        
        .user-order-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .user-status-new {
            background-color: #ffebee;
            color: #e31837;
        }
        
        .user-status-processing {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .user-status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .user-order-items {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .user-order-item-detail {
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #eee;
        }
        
        .user-order-item-detail:last-child {
            border-bottom: none;
        }
        
        .user-order-item-name {
            flex: 2;
        }
        
        .user-order-item-price {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: #e31837;
        }
        
        .user-order-info {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .user-order-info p {
            margin-bottom: 5px;
        }
        
        .user-order-total {
            font-weight: bold;
            color: #e31837;
            font-size: 1.2rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            text-align: right;
        }
        
        .no-user-orders {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .no-user-orders i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .user-id-info {
            background-color: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-id-label {
            font-weight: bold;
            color: #666;
        }
        
        .user-id-value {
            font-family: monospace;
            background-color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .admin-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            background-color: white;
            z-index: 2000;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: none;
        }
        
        .admin-panel.active {
            transform: translateX(0);
            display: block;
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }
        
        .panel-overlay.active {
            display: block;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .panel-header h2 {
            font-size: 1.8rem;
            margin: 0;
        }
        
        .close-panel {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .close-panel:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .panel-content {
            padding: 20px;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .admin-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #666;
            font-weight: 500;
        }
        
        .admin-tab:hover {
            color: #e31837;
            background-color: #fff5f5;
        }
        
        .admin-tab.active {
            color: #e31837;
            border-bottom-color: #e31837;
            font-weight: bold;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .order-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background-color: #e0e0e0;
        }
        
        .filter-btn.active {
            background-color: #e31837;
            color: white;
        }
        
        .orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            min-height: 300px;
        }
        
        .admin-order-item {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #ffcc00;
            transition: all 0.3s;
        }
        
        .admin-order-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .order-time {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .order-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .status-new {
            background-color: #ffebee;
            color: #e31837;
        }
        
        .status-processing {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .order-details {
            margin-bottom: 15px;
        }
        
        .order-items {
            margin-bottom: 10px;
        }
        
        .order-item-detail {
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .order-total {
            font-weight: bold;
            color: #e31837;
            font-size: 1.2rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #eee;
        }
        
        .customer-info {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .customer-info p {
            margin-bottom: 5px;
        }
        
        .screenshot-container {
            margin-top: 15px;
        }
        
        .screenshot-container img {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .screenshot-container img:hover {
            transform: scale(1.02);
        }
        
        .no-orders {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            grid-column: 1 / -1;
            width: 100%;
        }
        
        .no-orders i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .admin-btn:hover {
            background-color: #555;
            transform: scale(1.05);
        }
        
        .new-order-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #e31837;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 3rem;
            cursor: pointer;
        }
        
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .password-modal.active {
            display: flex;
        }
        
        .password-box {
            background-color: white;
            border-radius: 15px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .password-box h3 {
            color: #e31837;
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 3px;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #e31837;
            box-shadow: 0 0 0 3px rgba(227, 24, 55, 0.2);
        }
        
        .password-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .password-btn:hover {
            background-color: #c8102e;
            transform: scale(1.03);
        }
        
        .password-error {
            color: #e31837;
            margin-top: 15px;
            font-weight: bold;
            display: none;
        }
        
        .meal-page-container {
            display: none;
        }
        
        .meal-page-container.active {
            display: block;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #e31837;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 1.2rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .cart-section {
                position: static;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .meal-card {
                padding: 15px;
            }
            
            .store-selection {
                flex-direction: column;
            }
            
            .store-selection .form-group {
                min-width: 100%;
            }
            
            .info-method-selector {
                flex-direction: column;
            }
            
            .admin-panel {
                width: 100%;
            }
            
            .orders-container {
                grid-template-columns: 1fr;
            }
            
            .admin-btn span {
                display: none;
            }
            
            .admin-btn {
                padding: 15px;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                justify-content: center;
            }
            
            .option-items {
                flex-direction: column;
            }
            
            .option-item {
                min-width: 100%;
                justify-content: space-between;
            }
            
            .password-box {
                padding: 25px;
                width: 95%;
            }
            
            .meal-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 全局加载动画 -->
    <div class="loading-overlay" id="globalLoading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">处理中...</div>
    </div>
    
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-utensils"></i>
                <h1>肯德基自助点餐系统</h1>
                <i class="fas fa-hamburger"></i>
            </div>
            <p>宅急送免配送费 | 多人餐团餐优惠 | 外送到家</p>
            <div class="header-info">
                <div class="info-item">
                    <i class="fas fa-shipping-fast"></i>
                    <span>宅急送免配送费</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-users"></i>
                    <span>多人餐团餐优惠</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-store"></i>
                    <span>到店自提</span>
                </div>
            </div>

            <div class="header-buttons">
                <button class="header-btn" id="viewOrdersBtn">
                    <i class="fas fa-clipboard-list"></i>
                    查看我的订单
                </button>
                <button class="header-btn" id="viewHomeBtn" style="display: none;">
                    <i class="fas fa-home"></i>
                    返回首页
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 首页 -->
        <div id="homePage" class="meal-page-container active">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="mealSearchInput" placeholder="搜索套餐：输入标签、价格、套餐名称或编号...">
                    <button class="search-btn" id="mealSearchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="search-hint">
                    <i class="fas fa-lightbulb"></i>
                    提示：可以输入标签（如"自提"、"宅急送"）、价格（如"89.9"）、套餐名称或套餐编号进行搜索
                </div>
            </div>

            <div class="nav-menu">
                <h2 class="nav-title">
                    <i class="fas fa-utensils"></i>
                    选择您想要的套餐
                </h2>
                <div class="instructions">
                    <p><strong>下单步骤：</strong></p>
                    <ol>
                        <li>选择您想要的套餐</li>
                        <li>在套餐中选择具体的汉堡、小吃和饮品（点击选项，使用+/-按钮调整数量）</li>
                        <li>确保每个选项组的选择数量符合要求（会有提示）</li>
                        <li>点击"加入购物车"按钮</li>
                        <li>在右侧购物车确认订单并选择配送方式</li>
                        <li>提交订单完成购买</li>
                        <li>提交后可以点击上方"查看我的订单"查看订单状态</li>
                    </ol>
                </div>
            </div>

            <div class="meal-grid" id="mealGrid">
                <!-- 套餐列表将通过JS动态生成 -->
            </div>

            <div class="no-meals-message" id="noMealsMessage" style="display: none;">
                <i class="fas fa-utensils"></i>
                <h3>暂无套餐</h3>
                <p>请联系管理员添加套餐</p>
            </div>
        </div>

        <!-- 套餐详情页 -->
        <div id="mealDetailPage" class="meal-page-container">
            <!-- 套餐详情将通过JS动态生成 -->
        </div>

        <!-- 我的订单页 -->
        <div id="myOrdersPage" class="meal-page-container">
            <a href="#" class="back-btn" onclick="showPage('homePage')">
                <i class="fas fa-arrow-left"></i>
                返回套餐列表
            </a>

            <div class="my-orders-section">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    我的订单
                </h2>

                <div class="user-id-info">
                    <div class="user-id-label">您的用户标识符：</div>
                    <div class="user-id-value" id="currentUserIdDisplay"></div>
                </div>

                <div class="orders-search">
                    <div class="search-box">
                        <input type="text" class="search-input" id="orderSearchInput" placeholder="输入订单号搜索...">
                        <button class="search-btn" id="orderSearchBtn">搜索</button>
                    </div>

                    <div class="order-filter-tabs">
                        <button class="order-filter-tab active" data-order-filter="all">全部订单</button>
                        <button class="order-filter-tab" data-order-filter="new">新订单</button>
                        <button class="order-filter-tab" data-order-filter="processing">处理中</button>
                        <button class="order-filter-tab" data-order-filter="completed">已完成</button>
                    </div>
                </div>

                <div id="myOrdersContainer">
                    <!-- 用户订单将通过JS动态生成 -->
                </div>

                <div class="no-user-orders" id="noUserOrdersMessage">
                    <i class="fas fa-box-open"></i>
                    <h3>暂无订单</h3>
                    <p>您还没有提交过订单，快去下单吧！</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2026 肯德基自助点餐系统 | 宅急送免配送费 | 商品特殊售出不退不换</p>
        </div>
    </div>

    <!-- 后台管理按钮 -->
    <button class="admin-btn" id="adminBtn">
        <i class="fas fa-user-shield"></i>
        <span>后台管理</span>
        <div class="new-order-badge" id="newOrderBadge" style="display: none;">0</div>
    </button>

    <!-- 密码验证模态框 -->
    <div class="password-modal" id="passwordModal">
        <div class="password-box">
            <h3><i class="fas fa-lock"></i> 管理员登录</h3>
            <input type="password" class="password-input" id="adminPassword" placeholder="请输入管理员密码" maxlength="6">
            <div class="password-error" id="passwordError">密码错误，请重新输入！</div>
            <button class="password-btn" id="submitPassword">确认</button>
        </div>
    </div>

    <!-- 管理员面板遮罩 -->
    <div class="panel-overlay" id="panelOverlay"></div>
    
    <!-- 管理员面板 -->
    <div class="admin-panel" id="adminPanel">
        <div class="panel-header">
            <h2><i class="fas fa-clipboard-list"></i> 系统管理后台</h2>
            <button class="close-panel" id="closePanel">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="panel-content">
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="orders">订单管理</button>
                <button class="admin-tab" data-tab="meals">套餐管理</button>
            </div>

            <!-- 订单管理标签页 -->
            <div id="ordersTab" class="admin-tab-content active">
                <div class="order-filters">
                    <button class="filter-btn active" data-filter="all">全部订单</button>
                    <button class="filter-btn" data-filter="new">新订单</button>
                    <button class="filter-btn" data-filter="processing">处理中</button>
                    <button class="filter-btn" data-filter="completed">已完成</button>
                    <button class="filter-btn" id="syncDataBtn">同步数据</button>
                </div>

                <div class="orders-container" id="ordersContainer">
                    <div class="no-orders" id="noOrdersMessage">
                        <i class="fas fa-box-open"></i>
                        <h3>暂无订单</h3>
                        <p>当顾客提交订单后，订单将显示在这里</p>
                    </div>
                </div>
            </div>

            <!-- 套餐管理标签页 -->
            <div id="mealsTab" class="admin-tab-content">
                <div class="meal-list" id="mealList">
                    <!-- 套餐列表将通过JS动态生成 -->
                </div>
                <div class="no-orders" id="noMealsAdminMessage">
                    <i class="fas fa-utensils"></i>
                    <h3>暂无套餐</h3>
                    <p>请联系开发人员添加套餐</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
        <button class="close-modal" id="closeModal">
            <i class="fas fa-times"></i>
        </button>
        <img class="modal-image" id="modalImage" src="" alt="预览图片">
    </div>

    <script>
        // ==================== LeanCloud 配置 ====================
        const APP_ID = 'Tu8MLJ2PHUY0z4Kgol3hockE-gzGzoHsz';
        const APP_KEY = '7sdmY7swmMFU9ppvBGheW4oz';
        const SERVER_URL = 'https://tu8mlj2p.lc-cn-n1-shared.com';

        // 初始化 LeanCloud
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURLs: SERVER_URL
        });

        // ==================== 全局变量 ====================
        let meals = [];
        let cart = [];
        let orders = [];
        let newOrdersCount = 0;
        const ADMIN_PASSWORD = "200104";

        // 用户标识符
        let currentUserId = localStorage.getItem('kfcUserId');
        if (!currentUserId) {
            currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('kfcUserId', currentUserId);
        }

        // 实时更新相关变量
        let adminPollingInterval = null;
        let lastCheckTime = Date.now();
        let isAdminPanelOpen = false;

        // ==================== LeanCloud 数据操作类 ====================
        class LeanCloudData {
            // 加载套餐数据
            static async loadMeals() {
                try {
                    const query = new AV.Query('Meals');
                    query.descending('createdAt');
                    const results = await query.find();
                    return results.map(item => {
                        const data = item.toJSON();
                        return {
                            id: data.id || item.id,
                            name: data.name,
                            price: data.price,
                            tags: data.tags || [],
                            description: data.description,
                            active: data.active !== false,
                            optionGroups: data.optionGroups || [],
                            fixedItems: data.fixedItems || [],
                            objectId: item.id
                        };
                    });
                } catch (error) {
                    console.error('加载套餐数据失败:', error);
                    return [];
                }
            }

            // 加载订单数据
            static async loadOrders() {
                try {
                    const query = new AV.Query('Orders');
                    query.descending('createdAt');
                    const results = await query.find();
                    return results.map(item => {
                        const data = item.toJSON();
                        const createdAt = item.createdAt ? item.createdAt.getTime() : Date.now();
                        return {
                            id: data.id,
                            timestamp: data.timestamp,
                            status: data.status || 'new',
                            cart: data.cart || [],
                            deliveryInfo: data.deliveryInfo,
                            orderNote: data.orderNote || '',
                            deliveryType: data.deliveryType,
                            totalPrice: data.totalPrice,
                            hasScreenshot: data.hasScreenshot || false,
                            screenshotData: data.screenshotData,
                            userId: data.userId,
                            createdAt: createdAt,
                            objectId: item.id
                        };
                    });
                } catch (error) {
                    console.error('加载订单数据失败:', error);
                    return [];
                }
            }

            // 保存订单
            static async saveOrder(order) {
                try {
                    const Order = AV.Object.extend('Orders');
                    let orderObj;

                    if (order.objectId) {
                        orderObj = AV.Object.createWithoutData('Orders', order.objectId);
                    } else {
                        orderObj = new Order();
                    }

                    orderObj.set('id', order.id);
                    orderObj.set('timestamp', order.timestamp);
                    orderObj.set('status', order.status || 'new');
                    orderObj.set('cart', order.cart);
                    orderObj.set('deliveryInfo', order.deliveryInfo);
                    orderObj.set('orderNote', order.orderNote || '');
                    orderObj.set('deliveryType', order.deliveryType);
                    orderObj.set('totalPrice', order.totalPrice);
                    orderObj.set('userId', order.userId);
                    
                    if (order.hasScreenshot && order.screenshotData) {
                        orderObj.set('hasScreenshot', true);
                        orderObj.set('screenshotData', order.screenshotData);
                    } else {
                        orderObj.set('hasScreenshot', false);
                    }

                    const result = await orderObj.save();
                    
                    return {
                        id: order.id,
                        timestamp: order.timestamp,
                        status: order.status || 'new',
                        cart: order.cart,
                        deliveryInfo: order.deliveryInfo,
                        orderNote: order.orderNote || '',
                        deliveryType: order.deliveryType,
                        totalPrice: order.totalPrice,
                        hasScreenshot: order.hasScreenshot || false,
                        screenshotData: order.screenshotData,
                        userId: order.userId,
                        objectId: result.id
                    };
                } catch (error) {
                    console.error('保存订单失败:', error);
                    throw error;
                }
            }

            // 检查新订单（用于实时更新）
            static async checkNewOrders(sinceTime) {
                try {
                    const query = new AV.Query('Orders');
                    query.greaterThan('createdAt', new Date(sinceTime));
                    query.ascending('createdAt');
                    const results = await query.find();
                    
                    return results.map(item => {
                        const data = item.toJSON();
                        const createdAt = item.createdAt ? item.createdAt.getTime() : Date.now();
                        return {
                            id: data.id,
                            timestamp: data.timestamp,
                            status: data.status || 'new',
                            cart: data.cart || [],
                            deliveryInfo: data.deliveryInfo,
                            orderNote: data.orderNote || '',
                            deliveryType: data.deliveryType,
                            totalPrice: data.totalPrice,
                            hasScreenshot: data.hasScreenshot || false,
                            screenshotData: data.screenshotData,
                            userId: data.userId,
                            createdAt: createdAt,
                            objectId: item.id
                        };
                    });
                } catch (error) {
                    console.error('检查新订单失败:', error);
                    return [];
                }
            }
        }

        // ==================== 页面初始化 ====================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                showLoading('正在加载数据...');
                
                // 加载数据
                await loadAllData();
                
                // 初始化功能
                initHomePage();
                initAdminPanel();
                updateCartDisplay();
                updateOrderBadge();
                initImagePreview();
                initPasswordVerification();
                initMyOrdersPage();
                initHeaderButtons();
                
                // 显示用户ID
                document.getElementById('currentUserIdDisplay').textContent = currentUserId.substring(0, 12) + '...';
                
                hideLoading();
                showNotification('页面加载完成', 'success');
                
                console.log('页面初始化完成');
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败，请刷新页面重试', 'error');
                hideLoading();
            }
        });

        // ==================== 数据加载 ====================
        async function loadAllData() {
            try {
                const [mealsData, ordersData] = await Promise.all([
                    LeanCloudData.loadMeals(),
                    LeanCloudData.loadOrders()
                ]);

                meals = mealsData;
                orders = ordersData;
                
                // 更新最后检查时间
                lastCheckTime = Date.now();
                
                // 保存到本地缓存
                localStorage.setItem('kfcMealsCache', JSON.stringify(meals));
                localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));
                
                console.log('数据加载完成:', {
                    套餐数: meals.length,
                    订单数: orders.length
                });
            } catch (error) {
                console.error('加载数据失败:', error);
                throw error;
            }
        }

        // ==================== 首页功能 ====================
        function initHomePage() {
            updateHomePage();
            
            // 搜索功能
            document.getElementById('mealSearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('mealSearchInput').value.trim();
                searchMeals(searchTerm);
            });
            
            document.getElementById('mealSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim();
                    searchMeals(searchTerm);
                }
            });
        }

        function updateHomePage() {
            const mealGrid = document.getElementById('mealGrid');
            const noMealsMessage = document.getElementById('noMealsMessage');

            mealGrid.innerHTML = '';

            const activeMeals = meals.filter(meal => meal.active !== false);

            if (activeMeals.length === 0) {
                noMealsMessage.style.display = 'block';
                return;
            }

            noMealsMessage.style.display = 'none';

            activeMeals.forEach(meal => {
                const mealCard = document.createElement('a');
                mealCard.href = '#';
                mealCard.className = 'meal-card';
                mealCard.onclick = function(e) {
                    e.preventDefault();
                    showMealDetail(meal.id);
                };

                mealCard.innerHTML =
                    `
                <div class="meal-header">
                    <h4 class="meal-name">${meal.name}</h4>
                    <div class="meal-price">¥${meal.price}</div>
                </div>
                <div class="meal-description">
                    ${meal.tags.map(tag => `<span class="meal-tag">${tag}</span>`).join('')}
                    <p style="margin-top: 10px;">${meal.description}</p>
                </div>
            `;

                mealGrid.appendChild(mealCard);
            });
        }

        function searchMeals(searchTerm) {
            const mealGrid = document.getElementById('mealGrid');
            const noMealsMessage = document.getElementById('noMealsMessage');
            
            mealGrid.innerHTML = '';

            if (!searchTerm) {
                updateHomePage();
                return;
            }

            const activeMeals = meals.filter(meal => meal.active !== false);
            
            if (activeMeals.length === 0) {
                noMealsMessage.style.display = 'block';
                return;
            }

            noMealsMessage.style.display = 'none';

            const searchTermLower = searchTerm.toLowerCase();
            const filteredMeals = activeMeals.filter(meal => {
                if (meal.name.toLowerCase().includes(searchTermLower)) return true;
                if (meal.id.toLowerCase().includes(searchTermLower)) return true;
                if (meal.price.toString().includes(searchTerm)) return true;
                if (meal.tags && meal.tags.some(tag => tag.toLowerCase().includes(searchTermLower))) return true;
                if (meal.description && meal.description.toLowerCase().includes(searchTermLower)) return true;
                return false;
            });

            if (filteredMeals.length === 0) {
                mealGrid.innerHTML = `
                    <div class="no-meals-message">
                        <i class="fas fa-search"></i>
                        <h3>未找到相关套餐</h3>
                        <p>没有找到与"${searchTerm}"相关的套餐</p>
                    </div>
                `;
                return;
            }

            filteredMeals.forEach(meal => {
                const mealCard = document.createElement('a');
                mealCard.href = '#';
                mealCard.className = 'meal-card';
                mealCard.onclick = function(e) {
                    e.preventDefault();
                    showMealDetail(meal.id);
                };

                mealCard.innerHTML =
                    `
                <div class="meal-header">
                    <h4 class="meal-name">${meal.name}</h4>
                    <div class="meal-price">¥${meal.price}</div>
                </div>
                <div class="meal-description">
                    ${meal.tags.map(tag => `<span class="meal-tag">${tag}</span>`).join('')}
                    <p style="margin-top: 10px;">${meal.description}</p>
                </div>
            `;

                mealGrid.appendChild(mealCard);
            });
        }

        // ==================== 套餐详情页 ====================
        function showMealDetail(mealId) {
            const meal = meals.find(m => m.id === mealId);
            if (!meal) return;

            const mealDetailPage = document.getElementById('mealDetailPage');

            mealDetailPage.innerHTML =
                `
            <a href="#" class="back-btn" onclick="showPage('homePage')">
                <i class="fas fa-arrow-left"></i>
                返回套餐列表
            </a>
            
            <div class="main-content">
                <div class="menu-section">
                    <h2 class="section-title">
                        <i class="fas fa-hamburger"></i>
                        ${meal.name}
                    </h2>
                    
                    <div class="instructions">
                        <p><strong>套餐详情：</strong></p>
                        <ul>
                            <li>${meal.description}</li>
                            <li>请按照要求选择选项</li>
                            <li>提交订单后可在右上角"查看我的订单"查看订单状态</li>
                        </ul>
                    </div>
                    
                    <div class="meal-options" id="mealOptions">
                        ${generateOptionsHTML(meal)}
                    </div>
                    <button class="add-to-cart" data-meal-id="${meal.id}" data-meal-name="${meal.name}" data-meal-price="${meal.price}" disabled>
                        <i class="fas fa-cart-plus"></i>
                        加入购物车
                    </button>
                </div>
                
                <div class="cart-section">
                    <h2 class="section-title">
                        <i class="fas fa-shopping-cart"></i>
                        购物车
                    </h2>
                    
                    <div class="cart-items" id="cartItems">
                        <div class="empty-cart-message">购物车是空的，请选择套餐</div>
                    </div>
                    
                    <div class="cart-total">
                        <span>总计：</span>
                        <span class="total-price" id="totalPrice">¥0.00</span>
                    </div>
                    
                    <button class="checkout-btn" id="checkoutBtn" disabled>
                        <i class="fas fa-credit-card"></i>
                        提交订单
                    </button>
                    
                    <div class="delivery-form">
                        <h3 class="section-title">
                            <i class="fas fa-truck"></i>
                            配送信息
                        </h3>
                        
                        <div class="order-type">
                            <label>
                                <input type="radio" name="deliveryType" value="delivery" checked>
                                <span>宅急送（免配送费）</span>
                            </label>
                            <label>
                                <input type="radio" name="deliveryType" value="pickup">
                                <span>到店自提</span>
                            </label>
                        </div>
                        
                        <div class="delivery-fields" id="deliveryFields">
                            <div class="form-group">
                                <label class="form-label">收货人姓名 <span class="required">*</span></label>
                                <input type="text" class="form-input" id="customerName" placeholder="请输入姓名" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">联系电话 <span class="required">*</span></label>
                                <input type="tel" class="form-input" id="customerPhone" placeholder="请输入手机号码" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">配送地址 <span class="required">*</span></label>
                                <input type="text" class="form-input" id="deliveryAddress" placeholder="请输入详细地址" required>
                            </div>
                        </div>
                        
                        <div class="pickup-fields hidden" id="pickupFields">
                            <div class="form-group">
                                <label class="form-label">自提方式 <span class="required">*</span></label>
                                <div class="pickup-type">
                                    <label>
                                        <input type="radio" name="pickupType" value="堂食" checked>
                                        <span>堂食</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="pickupType" value="外带">
                                        <span>外带</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">门店信息提供方式 <span class="required">*</span></label>
                                <div class="info-method-selector">
                                    <label class="method-option">
                                        <input type="radio" name="pickupMethod" value="text" checked>
                                        <span>手动填写</span>
                                    </label>
                                    <label class="method-option">
                                        <input type="radio" name="pickupMethod" value="screenshot">
                                        <span>上传截图</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="text-method-fields" id="textMethodFields">
                                <div class="store-selection">
                                    <div class="form-group">
                                        <label class="form-label">自提城市 <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="pickupCityInput" placeholder="例如：北京市" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">自提门店 <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="pickupStoreInput" placeholder="例如：肯德基王府井店" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="screenshot-method-fields hidden" id="screenshotMethodFields">
                                <div class="form-group">
                                    <label class="form-label">上传门店截图 <span class="required">*</span></label>
                                    <div class="screenshot-upload-area" id="screenshotUploadArea">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>点击或拖拽上传截图</p>
                                        <p class="upload-hint">支持 JPG、PNG 格式，大小不超过 5MB</p>
                                        <input type="file" id="storeScreenshot" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="screenshot-preview hidden" id="screenshotPreview">
                                        <img id="previewImage" src="" alt="截图预览">
                                        <button type="button" class="remove-screenshot" id="removeScreenshot">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">订单备注</label>
                            <textarea class="form-input" id="orderNote" rows="3" placeholder="如有特殊要求请在此备注（例如：不吃辣，多要番茄酱等）"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // 初始化选项选择
            initOptionSelection(mealDetailPage);
            // 初始化配送方式切换
            initDeliveryTypeToggle(mealDetailPage);
            // 初始化自提方式
            initPickupMethod(mealDetailPage);
            // 初始化购物车
            initCart(mealDetailPage);
            // 初始化结账
            initCheckout(mealDetailPage);

            showPage('mealDetailPage');

            document.getElementById('viewOrdersBtn').style.display = 'none';
            document.getElementById('viewHomeBtn').style.display = 'flex';
        }

        function generateOptionsHTML(meal) {
            let html = '';

            if (meal.optionGroups && meal.optionGroups.length > 0) {
                meal.optionGroups.forEach((group, groupIndex) => {
                    const groupId = `group-${meal.id}-${groupIndex}`;
                    const repeat = group.repeat ? 'true' : 'false';
                    const maxPerItem = group.maxPerItem || (group.repeat ? 999 : 1);

                    html +=
                        `
                    <div class="option-group" data-group-id="${groupId}" data-min-select="${group.minSelect}" data-max-select="${group.maxSelect}" data-repeat="${repeat}" data-max-per-item="${maxPerItem}">
                        <div class="option-title">${group.title}</div>
                        <div class="option-rules">${group.rules}</div>
                        <div class="option-items">
                `;

                    if (group.items && group.items.length > 0) {
                        group.items.forEach((item, itemIndex) => {
                            const itemId = `${groupId}-${itemIndex}`;
                            const addPrice = item.addPrice || 0;
                            const addPriceText = addPrice > 0 ? ` (+¥${addPrice})` : '';

                            html +=
                                `
                            <div class="option-item" data-item-id="${itemId}" data-name="${item.name}" data-add-price="${addPrice}">
                                <span>${item.name}${addPriceText}</span>
                                <div class="selection-counter">
                                    <button class="counter-btn decrement" disabled>-</button>
                                    <span class="counter-value">0</span>
                                    <button class="counter-btn increment">+</button>
                                </div>
                            </div>
                        `;
                        });
                    }

                    html +=
                        `
                        </div>
                        <div class="selection-status invalid">已选择 0 份，还需选择 ${group.minSelect} 份</div>
                    </div>
                `;
                });
            }

            if (meal.fixedItems && meal.fixedItems.length > 0) {
                html +=
                    `
                <div class="fixed-combo-items">
                    <div class="option-title">固定搭配：</div>
                    <div class="option-rules">套餐包含固定搭配，无需选择</div>
                    <div class="fixed-combo-list">
            `;

                meal.fixedItems.forEach(item => {
                    html +=
                        `
                    <div class="fixed-combo-item">
                        <div class="fixed-combo-item-name">${item.name}</div>
                        <div class="fixed-combo-item-qty">×${item.quantity}</div>
                    </div>
                `;
                });

                html += `
                    </div>
                </div>
            `;
            }

            return html;
        }

        // ==================== 选项选择功能 ====================
        function initOptionSelection(container) {
            container.querySelectorAll('.counter-btn.increment').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const optionItem = this.closest('.option-item');
                    const counterValue = optionItem.querySelector('.counter-value');
                    const decrementBtn = optionItem.querySelector('.decrement');
                    const group = optionItem.closest('.option-group');

                    const maxSelect = parseInt(group.dataset.maxSelect) || Infinity;
                    const repeat = group.dataset.repeat === 'true';
                    const maxPerItem = parseInt(group.dataset.maxPerItem) || (repeat ? Infinity : 1);

                    let totalSelected = 0;
                    group.querySelectorAll('.counter-value').forEach(value => {
                        totalSelected += parseInt(value.textContent);
                    });

                    let currentSelected = parseInt(counterValue.textContent);

                    if (totalSelected >= maxSelect) {
                        showNotification(`该选项组最多只能选择${maxSelect}份`);
                        return;
                    }

                    if (currentSelected >= maxPerItem) {
                        showNotification(`该选项最多只能选择${maxPerItem}份`);
                        return;
                    }

                    currentSelected++;
                    counterValue.textContent = currentSelected;

                    decrementBtn.disabled = false;
                    optionItem.classList.add('selected');

                    updateGroupSelectionStatus(group);
                });
            });

            container.querySelectorAll('.counter-btn.decrement').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const optionItem = this.closest('.option-item');
                    const counterValue = optionItem.querySelector('.counter-value');

                    let currentSelected = parseInt(counterValue.textContent);

                    if (currentSelected > 0) {
                        currentSelected--;
                        counterValue.textContent = currentSelected;

                        this.disabled = currentSelected === 0;

                        if (currentSelected === 0) {
                            optionItem.classList.remove('selected');
                        }

                        const group = optionItem.closest('.option-group');
                        updateGroupSelectionStatus(group);
                    }
                });
            });

            container.querySelectorAll('.option-item').forEach(item => {
                if (!item.classList.contains('selected')) {
                    item.addEventListener('click', function() {
                        const incrementBtn = this.querySelector('.increment');
                        if (incrementBtn) {
                            incrementBtn.click();
                        }
                    });
                }
            });
        }

        function updateGroupSelectionStatus(group) {
            if (!group.dataset.minSelect) return;

            const minSelect = parseInt(group.dataset.minSelect);
            const maxSelect = parseInt(group.dataset.maxSelect);

            let totalSelected = 0;
            group.querySelectorAll('.counter-value').forEach(value => {
                totalSelected += parseInt(value.textContent);
            });

            const statusElement = group.querySelector('.selection-status');
            if (statusElement) {
                if (totalSelected >= minSelect && totalSelected <= maxSelect) {
                    statusElement.textContent = `已选择 ${totalSelected} 份，符合要求`;
                    statusElement.className = 'selection-status valid';
                } else if (totalSelected < minSelect) {
                    statusElement.textContent = `已选择 ${totalSelected} 份，还需选择 ${minSelect - totalSelected} 份`;
                    statusElement.className = 'selection-status invalid';
                } else {
                    statusElement.textContent = `已选择 ${totalSelected} 份，已超过最大 ${maxSelect} 份`;
                    statusElement.className = 'selection-status invalid';
                }
            }

            const mealContainer = group.closest('.meal-page-container');
            updateAddToCartButton(mealContainer);
        }

        function updateAddToCartButton(mealContainer) {
            const addToCartBtn = mealContainer.querySelector('.add-to-cart');
            if (!addToCartBtn) return;

            const optionGroups = mealContainer.querySelectorAll('.option-group');
            if (optionGroups.length === 0) {
                addToCartBtn.disabled = false;
                return;
            }

            let isValid = true;

            optionGroups.forEach(group => {
                if (!group.dataset.minSelect) return;

                const minSelect = parseInt(group.dataset.minSelect);
                const maxSelect = parseInt(group.dataset.maxSelect);

                let totalSelected = 0;
                group.querySelectorAll('.counter-value').forEach(value => {
                    totalSelected += parseInt(value.textContent);
                });

                if (totalSelected < minSelect || totalSelected > maxSelect) {
                    isValid = false;
                }
            });

            addToCartBtn.disabled = !isValid;
        }

        // ==================== 配送方式切换 ====================
        function initDeliveryTypeToggle(container) {
            container.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const deliveryFields = container.querySelector('.delivery-fields');
                    const pickupFields = container.querySelector('.pickup-fields');

                    if (this.value === 'delivery') {
                        deliveryFields.classList.remove('hidden');
                        pickupFields.classList.add('hidden');
                    } else {
                        pickupFields.classList.remove('hidden');
                        deliveryFields.classList.add('hidden');
                    }
                });
            });
        }

        // ==================== 自提方式处理 ====================
        function initPickupMethod(container) {
            container.querySelectorAll('input[name="pickupMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const textFields = container.querySelector('.text-method-fields');
                    const screenshotFields = container.querySelector('.screenshot-method-fields');

                    if (this.value === 'text') {
                        textFields.classList.remove('hidden');
                        screenshotFields.classList.add('hidden');
                    } else {
                        screenshotFields.classList.remove('hidden');
                        textFields.classList.add('hidden');
                    }
                });
            });

            const uploadArea = container.querySelector('.screenshot-upload-area');
            if (uploadArea) {
                const fileInput = uploadArea.querySelector('input[type="file"]');
                const previewContainer = uploadArea.parentElement.querySelector('.screenshot-preview');
                const previewImage = previewContainer ? previewContainer.querySelector('img') : null;
                const removeBtn = previewContainer ? previewContainer.querySelector('.remove-screenshot') : null;

                uploadArea.addEventListener('click', function() {
                    fileInput.click();
                });

                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length) {
                        handleFileSelect(e.target.files[0], fileInput, previewContainer, previewImage, uploadArea);
                    }
                });

                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        fileInput.value = '';
                        previewContainer.classList.add('hidden');
                        uploadArea.style.display = 'block';
                    });
                }
            }

            function handleFileSelect(file, fileInput, previewContainer, previewImage, uploadArea) {
                if (!file.type.match('image.*')) {
                    showNotification('请选择图片文件', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showNotification('图片大小不能超过5MB', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // ==================== 购物车功能 ====================
        function initCart(container) {
            const addToCartBtn = container.querySelector('.add-to-cart');
            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', function() {
                    const optionGroups = container.querySelectorAll('.option-group');

                    if (this.disabled && optionGroups.length > 0) {
                        showNotification('请先完成选项选择，确保每个选项组的选择数量符合要求');
                        return;
                    }

                    const mealId = this.dataset.mealId;
                    const mealName = this.dataset.mealName;
                    const mealPrice = parseFloat(this.dataset.mealPrice);

                    const meal = meals.find(m => m.id === mealId);
                    if (!meal) return;

                    const selectedOptions = [];
                    let additionalPrice = 0;

                    container.querySelectorAll('.option-group').forEach(group => {
                        group.querySelectorAll('.option-item').forEach(item => {
                            const counterValue = item.querySelector('.counter-value');
                            const count = parseInt(counterValue.textContent);

                            if (count > 0) {
                                const itemName = item.dataset.name || item.textContent;
                                const itemAddPrice = parseFloat(item.dataset.addPrice) || 0;

                                for (let i = 0; i < count; i++) {
                                    selectedOptions.push(itemName);
                                    additionalPrice += itemAddPrice;
                                }
                            }
                        });
                    });

                    if (meal.fixedItems && meal.fixedItems.length > 0) {
                        meal.fixedItems.forEach(item => {
                            for (let i = 0; i < item.quantity; i++) {
                                selectedOptions.push(item.name);
                            }
                        });
                    }

                    if (selectedOptions.length === 0) {
                        showNotification('该套餐没有任何项目，无法加入购物车');
                        return;
                    }

                    const totalPrice = mealPrice + additionalPrice;

                    const mealItem = {
                        id: mealId,
                        name: mealName,
                        basePrice: mealPrice,
                        additionalPrice: additionalPrice,
                        totalPrice: totalPrice,
                        options: [...selectedOptions]
                    };

                    cart.push(mealItem);

                    updateCartDisplay();

                    showNotification(`已添加 "${mealName}" 到购物车`, 'success');

                    resetOptions(container);
                });
            }
        }

        function resetOptions(container) {
            container.querySelectorAll('.option-group').forEach(group => {
                group.querySelectorAll('.option-item').forEach(item => {
                    const counterValue = item.querySelector('.counter-value');
                    const decrementBtn = item.querySelector('.decrement');

                    counterValue.textContent = '0';
                    if (decrementBtn) {
                        decrementBtn.disabled = true;
                    }
                    item.classList.remove('selected');
                });

                updateGroupSelectionStatus(group);
            });
        }

        function updateCartDisplay() {
            document.querySelectorAll('.cart-items').forEach(container => {
                container.innerHTML = '';

                let totalPrice = 0;

                if (cart.length === 0) {
                    container.innerHTML = '<div class="empty-cart-message">购物车是空的，请选择套餐</div>';
                } else {
                    cart.forEach((item, index) => {
                        const cartItemElement = document.createElement('div');
                        cartItemElement.className = 'cart-item';

                        const optionsHtml = item.options.map(option => `<div>• ${option}</div>`).join('');

                        cartItemElement.innerHTML =
                            `
                            <div class="cart-item-name">
                                <div><strong>${item.name}</strong></div>
                                <div style="font-size:0.9rem; color:#666; margin-top:5px;">
                                    ${optionsHtml}
                                </div>
                            </div>
                            <div class="cart-item-price">¥${item.totalPrice.toFixed(2)}</div>
                            <button class="cart-item-remove" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;

                        container.appendChild(cartItemElement);

                        totalPrice += item.totalPrice;

                        cartItemElement.querySelector('.cart-item-remove').addEventListener('click', function() {
                            const indexToRemove = parseInt(this.dataset.index);
                            cart.splice(indexToRemove, 1);
                            updateCartDisplay();
                            showNotification('已从购物车中移除商品');
                        });
                    });
                }

                const totalPriceElement = container.closest('.cart-section').querySelector('.total-price');
                const checkoutBtn = container.closest('.cart-section').querySelector('.checkout-btn');

                if (totalPriceElement) {
                    totalPriceElement.textContent = `¥${totalPrice.toFixed(2)}`;
                }

                if (checkoutBtn) {
                    checkoutBtn.disabled = cart.length === 0;
                }
            });
        }

        // ==================== 订单提交功能 ====================
        function initCheckout(container) {
            const checkoutBtn = container.querySelector('.checkout-btn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', async function() {
                    if (checkoutBtn.disabled) return;
                    
                    const deliveryType = container.querySelector('input[name="deliveryType"]:checked').value;
                    const orderNote = container.querySelector('#orderNote') ? container.querySelector('#orderNote').value.trim() : '';

                    let deliveryInfo = '';
                    let hasScreenshot = false;
                    let screenshotData = null;
                    let pickupType = '';

                    if (deliveryType === 'delivery') {
                        const customerName = container.querySelector('#customerName').value.trim();
                        const customerPhone = container.querySelector('#customerPhone').value.trim();
                        const deliveryAddress = container.querySelector('#deliveryAddress').value.trim();

                        if (!customerName || !customerPhone || !deliveryAddress) {
                            showNotification('请填写完整的配送信息', 'error');
                            return;
                        }

                        deliveryInfo = `配送方式：宅急送\n收货人：${customerName}\n联系电话：${customerPhone}\n配送地址：${deliveryAddress}`;
                    } else {
                        pickupType = container.querySelector('input[name="pickupType"]:checked').value;
                        const pickupMethod = container.querySelector('input[name="pickupMethod"]:checked').value;

                        if (pickupMethod === 'text') {
                            const pickupCity = container.querySelector('#pickupCityInput').value.trim();
                            const pickupStore = container.querySelector('#pickupStoreInput').value.trim();

                            if (!pickupCity || !pickupStore) {
                                showNotification('请填写完整的自提信息', 'error');
                                return;
                            }

                            deliveryInfo = `配送方式：到店自提\n自提方式：${pickupType}\n自提城市：${pickupCity}\n自提门店：${pickupStore}`;
                        } else {
                            const screenshotInput = container.querySelector('#storeScreenshot');

                            if (!screenshotInput.files || !screenshotInput.files.length) {
                                showNotification('请上传门店截图', 'error');
                                return;
                            }

                            const file = screenshotInput.files[0];
                            const reader = new FileReader();

                            reader.onload = function(e) {
                                screenshotData = e.target.result;
                                hasScreenshot = true;

                                deliveryInfo = `配送方式：到店自提\n自提方式：${pickupType}\n信息提供：截图上传`;

                                completeCheckout(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, container, pickupType);
                            };

                            reader.readAsDataURL(file);
                            return;
                        }
                    }

                    await completeCheckout(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, container, pickupType);
                });
            }
        }

        async function completeCheckout(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, container, pickupType) {
            const checkoutBtn = container.querySelector('.checkout-btn');
            if (checkoutBtn.disabled) return;
            
            let totalPrice = 0;
            cart.forEach(item => {
                totalPrice += item.totalPrice;
            });

            let orderSummary = "订单详情：\n\n";
            cart.forEach((item, index) => {
                orderSummary += `${index + 1}. ${item.name} - ¥${item.totalPrice.toFixed(2)}\n`;

                const optionCount = {};
                item.options.forEach(option => {
                    optionCount[option] = (optionCount[option] || 0) + 1;
                });

                Object.keys(optionCount).forEach(option => {
                    const count = optionCount[option];
                    orderSummary += `   ${option}${count > 1 ? ` ×${count}` : ''}\n`;
                });
                orderSummary += "\n";
            });

            orderSummary += `\n总计：¥${totalPrice.toFixed(2)}\n`;
            orderSummary += `\n${deliveryInfo}\n`;
            if (orderNote) {
                orderSummary += `备注：${orderNote}\n`;
            }

            const confirmed = confirm(`请确认订单信息：\n\n${orderSummary}\n\n确认提交订单吗？`);

            if (confirmed) {
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = '提交中...';
                
                showLoading('正在提交订单...');
                
                const orderId = 'KFC' + Date.now().toString().slice(-6) + Math.floor(Math.random() * 100);
                const timestamp = new Date().toLocaleString('zh-CN');

                const orderData = {
                    id: orderId,
                    timestamp: timestamp,
                    status: 'new',
                    cart: JSON.parse(JSON.stringify(cart)),
                    deliveryInfo: deliveryInfo,
                    orderNote: orderNote,
                    deliveryType: deliveryType,
                    pickupType: pickupType || '',
                    totalPrice: totalPrice,
                    hasScreenshot: hasScreenshot,
                    screenshotData: screenshotData,
                    userId: currentUserId
                };

                try {
                    const savedOrder = await LeanCloudData.saveOrder(orderData);
                    console.log('订单保存成功:', savedOrder);

                    savedOrder.objectId = savedOrder.objectId;
                    orders.unshift(savedOrder);

                    // 更新新订单计数
                    newOrdersCount++;
                    updateOrderBadge();

                    // 更新本地缓存
                    localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));

                    cart = [];
                    updateCartDisplay();

                    resetForm(container);

                    hideLoading();
                    showNotification('订单提交成功！', 'success');

                    // 如果管理员面板是打开的，立即更新订单列表
                    if (isAdminPanelOpen) {
                        const activeFilterBtn = document.querySelector('.filter-btn.active');
                        const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                        renderOrders(activeFilter);
                    }

                    const orderSubmitted = confirm(`订单提交成功！\n订单号：${orderId}\n\n点击"确定"查看您的订单详情，或点击"取消"返回首页。`);

                    if (orderSubmitted) {
                        showMyOrdersPage();

                        setTimeout(() => {
                            document.getElementById('orderSearchInput').value = orderId;
                            searchUserOrder(orderId);
                        }, 100);
                    } else {
                        showPage('homePage');
                    }

                } catch (error) {
                    console.error('提交订单失败:', error);
                    hideLoading();
                    showNotification('订单提交失败：请检查网络连接', 'error');
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = '提交订单';
                    return;
                } finally {
                    checkoutBtn.disabled = false;
                    checkoutBtn.innerHTML = '<i class="fas fa-credit-card"></i> 提交订单';
                }
            }
        }

        function resetForm(container) {
            container.querySelectorAll('input[type="text"], input[type="tel"], textarea').forEach(input => {
                input.value = '';
            });

            const deliveryRadio = container.querySelector('input[name="deliveryType"][value="delivery"]');
            if (deliveryRadio) {
                deliveryRadio.checked = true;
                const deliveryFields = container.querySelector('.delivery-fields');
                const pickupFields = container.querySelector('.pickup-fields');
                if (deliveryFields) deliveryFields.classList.remove('hidden');
                if (pickupFields) pickupFields.classList.add('hidden');
            }

            const textMethodRadio = container.querySelector('input[name="pickupMethod"][value="text"]');
            if (textMethodRadio) {
                textMethodRadio.checked = true;
                const textFields = container.querySelector('.text-method-fields');
                const screenshotFields = container.querySelector('.screenshot-method-fields');
                if (textFields) textFields.classList.remove('hidden');
                if (screenshotFields) screenshotFields.classList.add('hidden');
            }

            const screenshotInput = container.querySelector('#storeScreenshot');
            const previewContainer = container.querySelector('.screenshot-preview');
            const uploadArea = container.querySelector('.screenshot-upload-area');
            if (screenshotInput) {
                screenshotInput.value = '';
                if (previewContainer) previewContainer.classList.add('hidden');
                if (uploadArea) uploadArea.style.display = 'block';
            }
        }

        // ==================== 我的订单页面 ====================
        function initHeaderButtons() {
            const viewOrdersBtn = document.getElementById('viewOrdersBtn');
            const viewHomeBtn = document.getElementById('viewHomeBtn');

            viewOrdersBtn.addEventListener('click', function() {
                showMyOrdersPage();
            });

            viewHomeBtn.addEventListener('click', function() {
                showPage('homePage');
                this.style.display = 'none';
                viewOrdersBtn.style.display = 'flex';
            });
        }

        function initMyOrdersPage() {
            const orderSearchBtn = document.getElementById('orderSearchBtn');
            const orderSearchInput = document.getElementById('orderSearchInput');

            orderSearchBtn.addEventListener('click', function() {
                const searchTerm = orderSearchInput.value.trim();
                if (searchTerm) {
                    searchUserOrder(searchTerm);
                } else {
                    renderUserOrders('all');
                }
            });

            orderSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    orderSearchBtn.click();
                }
            });

            document.querySelectorAll('.order-filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.order-filter-tab').forEach(t => {
                        t.classList.remove('active');
                    });

                    this.classList.add('active');

                    const filter = this.dataset.orderFilter;
                    renderUserOrders(filter);
                });
            });
        }

        function showMyOrdersPage() {
            showPage('myOrdersPage');
            renderUserOrders('all');

            document.getElementById('viewOrdersBtn').style.display = 'none';
            document.getElementById('viewHomeBtn').style.display = 'flex';
        }

        function renderUserOrders(filter = 'all') {
            const myOrdersContainer = document.getElementById('myOrdersContainer');
            const noUserOrdersMessage = document.getElementById('noUserOrdersMessage');

            myOrdersContainer.innerHTML = '';

            let userOrders = orders.filter(order => order.userId === currentUserId);

            if (filter !== 'all') {
                userOrders = userOrders.filter(order => order.status === filter);
            }

            userOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (userOrders.length === 0) {
                noUserOrdersMessage.style.display = 'block';
                return;
            }

            noUserOrdersMessage.style.display = 'none';

            userOrders.forEach(order => {
                const orderElement = createUserOrderElement(order);
                myOrdersContainer.appendChild(orderElement);
            });
        }

        function createUserOrderElement(order) {
            const orderElement = document.createElement('div');
            orderElement.className = 'user-order-item';

            let statusText, statusClass;
            switch (order.status) {
                case 'new':
                    statusText = '新订单';
                    statusClass = 'user-status-new';
                    break;
                case 'processing':
                    statusText = '处理中';
                    statusClass = 'user-status-processing';
                    break;
                case 'completed':
                    statusText = '已完成';
                    statusClass = 'user-status-completed';
                    break;
                default:
                    statusText = '新订单';
                    statusClass = 'user-status-new';
            }

            const deliveryTypeText = order.deliveryType === 'delivery' ? '宅急送' : `到店自提${order.pickupType ? ` (${order.pickupType})` : ''}`;

            let itemsHTML = '';
            order.cart.forEach((item, index) => {
                const optionCount = {};
                item.options.forEach(option => {
                    optionCount[option] = (optionCount[option] || 0) + 1;
                });

                const optionText = Object.keys(optionCount).map(option => {
                    const count = optionCount[option];
                    return `${option}${count > 1 ? ` ×${count}` : ''}`;
                }).join(', ');

                itemsHTML +=
                    `<div class="user-order-item-detail">
                    <div class="user-order-item-name">
                        <div><strong>${item.name}</strong></div>
                        <div style="font-size:0.9rem; color:#666;">${optionText}</div>
                    </div>
                    <div class="user-order-item-price">¥${item.totalPrice.toFixed(2)}</div>
                </div>`;
            });

            const infoLines = order.deliveryInfo.split('\n');
            let deliveryHTML = '';
            infoLines.forEach(line => {
                if (line.trim()) {
                    deliveryHTML += `<p>${line}</p>`;
                }
            });

            let screenshotHTML = '';
            if (order.hasScreenshot && order.screenshotData) {
                screenshotHTML =
                    `
                    <div class="screenshot-container">
                        <p><strong>门店截图：</strong></p>
                        <img src="${order.screenshotData}" alt="门店截图" class="screenshot-thumbnail" data-order-id="${order.id}">
                    </div>
                `;
            }

            orderElement.innerHTML =
                `
                <div class="user-order-header">
                    <div>
                        <div class="user-order-id">订单号：${order.id}</div>
                        <div class="user-order-time">${order.timestamp} | ${deliveryTypeText}</div>
                    </div>
                    <div class="user-order-status ${statusClass}">${statusText}</div>
                </div>
                
                <div class="user-order-items">
                    ${itemsHTML}
                </div>
                
                <div class="user-order-total">
                    总计：¥${order.totalPrice.toFixed(2)}
                </div>
                
                <div class="user-order-info">
                    ${deliveryHTML}
                    ${order.orderNote ? `<p><strong>备注：</strong>${order.orderNote}</p>` : ''}
                    ${screenshotHTML}
                </div>
            `;

            if (order.hasScreenshot && order.screenshotData) {
                const screenshotImg = orderElement.querySelector('.screenshot-thumbnail');
                if (screenshotImg) {
                    screenshotImg.addEventListener('click', function() {
                        showFullImage(order.screenshotData);
                    });
                }
            }

            return orderElement;
        }

        function searchUserOrder(searchTerm) {
            const myOrdersContainer = document.getElementById('myOrdersContainer');
            const noUserOrdersMessage = document.getElementById('noUserOrdersMessage');

            myOrdersContainer.innerHTML = '';

            const searchResults = orders.filter(order =>
                order.userId === currentUserId &&
                order.id.toLowerCase().includes(searchTerm.toLowerCase())
            );

            searchResults.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (searchResults.length === 0) {
                noUserOrdersMessage.style.display = 'block';
                noUserOrdersMessage.innerHTML =
                    `
                    <i class="fas fa-search"></i>
                    <h3>未找到相关订单</h3>
                    <p>没有找到订单号包含"${searchTerm}"的订单</p>
                `;
                return;
            }

            noUserOrdersMessage.style.display = 'none';

            searchResults.forEach(order => {
                const orderElement = createUserOrderElement(order);
                myOrdersContainer.appendChild(orderElement);
            });
        }

        // ==================== 页面切换 ====================
        function showPage(pageId) {
            document.querySelectorAll('.meal-page-container').forEach(page => {
                page.classList.remove('active');
            });

            document.getElementById(pageId).classList.add('active');

            window.scrollTo(0, 0);

            if (pageId === 'homePage') {
                document.getElementById('viewOrdersBtn').style.display = 'flex';
                document.getElementById('viewHomeBtn').style.display = 'none';
            }
        }

        // ==================== 后台管理 ====================
        function initPasswordVerification() {
            const passwordModal = document.getElementById('passwordModal');
            const adminPasswordInput = document.getElementById('adminPassword');
            const submitPasswordBtn = document.getElementById('submitPassword');
            const passwordError = document.getElementById('passwordError');

            submitPasswordBtn.addEventListener('click', function() {
                const enteredPassword = adminPasswordInput.value.trim();

                if (enteredPassword === ADMIN_PASSWORD) {
                    passwordModal.classList.remove('active');
                    adminPasswordInput.value = '';
                    passwordError.style.display = 'none';

                    openAdminPanel();
                } else {
                    passwordError.style.display = 'block';
                    adminPasswordInput.value = '';
                    adminPasswordInput.focus();
                }
            });

            adminPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPasswordBtn.click();
                }
            });
        }

        function initAdminPanel() {
            const adminBtn = document.getElementById('adminBtn');
            const closePanel = document.getElementById('closePanel');
            const panelOverlay = document.getElementById('panelOverlay');
            const adminPanel = document.getElementById('adminPanel');
            const syncDataBtn = document.getElementById('syncDataBtn');
            const adminTabs = document.querySelectorAll('.admin-tab');

            adminBtn.addEventListener('click', function() {
                const passwordModal = document.getElementById('passwordModal');
                const adminPasswordInput = document.getElementById('adminPassword');

                passwordModal.classList.add('active');
                adminPasswordInput.focus();
            });

            closePanel.addEventListener('click', function() {
                adminPanel.classList.remove('active');
                panelOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                // 停止轮询
                isAdminPanelOpen = false;
                stopAdminPolling();
            });

            panelOverlay.addEventListener('click', function() {
                adminPanel.classList.remove('active');
                panelOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                // 停止轮询
                isAdminPanelOpen = false;
                stopAdminPolling();
            });

            syncDataBtn.addEventListener('click', async function() {
                showLoading('正在同步数据...');
                await loadAllData();
                renderOrders('all');
                hideLoading();
                showNotification('数据同步完成', 'success');
            });

            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;

                    adminTabs.forEach(t => t.classList.remove('active'));

                    this.classList.add('active');

                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    document.getElementById(`${tabId}Tab`).classList.add('active');
                });
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.id !== 'syncDataBtn') {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.filter-btn').forEach(b => {
                            if (b.id !== 'syncDataBtn') {
                                b.classList.remove('active');
                            }
                        });

                        this.classList.add('active');

                        const filter = this.dataset.filter;
                        renderOrders(filter);
                    });
                }
            });
        }

        function openAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            const panelOverlay = document.getElementById('panelOverlay');

            adminPanel.classList.add('active');
            panelOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // 设置管理员面板打开状态
            isAdminPanelOpen = true;
            
            // 重置最后检查时间
            lastCheckTime = Date.now();

            // 重置新订单计数
            newOrdersCount = 0;
            updateOrderBadge();

            renderOrders('all');
            
            // 启动轮询
            startAdminPolling();
        }

        // ==================== 实时订单轮询 ====================
        function startAdminPolling() {
            // 清除已有的轮询
            stopAdminPolling();
            
            // 设置轮询间隔为3秒
            adminPollingInterval = setInterval(async () => {
                if (!isAdminPanelOpen) return;
                
                try {
                    // 检查新订单
                    const newOrders = await LeanCloudData.checkNewOrders(lastCheckTime);
                    
                    if (newOrders.length > 0) {
                        // 更新最后检查时间
                        lastCheckTime = Date.now();
                        
                        // 添加新订单到订单列表
                        newOrders.reverse().forEach(order => {
                            if (!orders.find(o => o.id === order.id)) {
                                orders.unshift(order);
                                newOrdersCount++;
                            }
                        });
                        
                        // 更新徽章
                        updateOrderBadge();
                        
                        // 重新渲染订单列表
                        const activeFilterBtn = document.querySelector('.filter-btn.active');
                        const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                        renderOrders(activeFilter);
                        
                        // 显示通知
                        showNotification(`有 ${newOrders.length} 个新订单`, 'success');
                    }
                } catch (error) {
                    console.warn('轮询检查新订单失败:', error);
                }
            }, 3000); // 每3秒检查一次
        }
        
        function stopAdminPolling() {
            if (adminPollingInterval) {
                clearInterval(adminPollingInterval);
                adminPollingInterval = null;
            }
        }

        function renderOrders(filter = 'all') {
            const ordersContainer = document.getElementById('ordersContainer');
            const noOrdersMessage = document.getElementById('noOrdersMessage');

            ordersContainer.innerHTML = '';

            let filteredOrders = orders;
            if (filter !== 'all') {
                filteredOrders = orders.filter(order => order.status === filter);
            }

            if (filteredOrders.length === 0) {
                noOrdersMessage.style.display = 'block';
                return;
            }

            noOrdersMessage.style.display = 'none';

            filteredOrders.forEach(order => {
                const orderElement = createOrderElement(order);
                ordersContainer.appendChild(orderElement);
            });
        }

        function createOrderElement(order) {
            const orderElement = document.createElement('div');
            orderElement.className = 'admin-order-item';

            let statusText, statusClass;
            switch (order.status) {
                case 'new':
                    statusText = '新订单';
                    statusClass = 'status-new';
                    break;
                case 'processing':
                    statusText = '处理中';
                    statusClass = 'status-processing';
                    break;
                case 'completed':
                    statusText = '已完成';
                    statusClass = 'status-completed';
                    break;
                default:
                    statusText = '新订单';
                    statusClass = 'status-new';
            }

            const deliveryTypeText = order.deliveryType === 'delivery' ? '宅急送' : `到店自提${order.pickupType ? ` (${order.pickupType})` : ''}`;

            let itemsHTML = '';
            order.cart.forEach(item => {
                const optionCount = {};
                item.options.forEach(option => {
                    optionCount[option] = (optionCount[option] || 0) + 1;
                });

                const optionText = Object.keys(optionCount).map(option => {
                    const count = optionCount[option];
                    return `${option}${count > 1 ? ` ×${count}` : ''}`;
                }).join(', ');

                itemsHTML +=
                    `<div class="order-item-detail">
                    <div><strong>${item.name}</strong> - ¥${item.totalPrice.toFixed(2)}</div>
                    <div style="font-size:0.9rem; color:#666;">${optionText}</div>
                </div>`;
            });

            const infoLines = order.deliveryInfo.split('\n');
            let deliveryHTML = '';
            infoLines.forEach(line => {
                if (line.trim()) {
                    deliveryHTML += `<p>${line}</p>`;
                }
            });

            let screenshotHTML = '';
            if (order.hasScreenshot && order.screenshotData) {
                screenshotHTML =
                    `
                    <div class="screenshot-container">
                        <p><strong>门店截图：</strong></p>
                        <img src="${order.screenshotData}" alt="门店截图" class="screenshot-thumbnail" data-order-id="${order.id}">
                    </div>
                `;
            }

            const userInfo = order.userId ? `<p><strong>用户ID：</strong>${order.userId.substring(0, 12)}...</p>` : '';

            orderElement.innerHTML =
                `
                <div class="order-id">订单号：${order.id}</div>
                <div class="order-time">${order.timestamp} | ${deliveryTypeText}</div>
                <div class="order-status ${statusClass}">${statusText}</div>
                
                <div class="order-details">
                    <div class="order-items">
                        ${itemsHTML}
                    </div>
                    
                    <div class="order-total">
                        总计：¥${order.totalPrice.toFixed(2)}
                    </div>
                </div>
                
                <div class="customer-info">
                    ${deliveryHTML}
                    ${userInfo}
                    ${order.orderNote ? `<p><strong>备注：</strong>${order.orderNote}</p>` : ''}
                    ${screenshotHTML}
                </div>
            `;

            if (order.hasScreenshot && order.screenshotData) {
                const screenshotImg = orderElement.querySelector('.screenshot-thumbnail');
                if (screenshotImg) {
                    screenshotImg.addEventListener('click', function() {
                        showFullImage(order.screenshotData);
                    });
                }
            }

            return orderElement;
        }

        // ==================== 新订单徽章 ====================
        function updateOrderBadge() {
            const badge = document.getElementById('newOrderBadge');
            if (newOrdersCount > 0) {
                badge.textContent = newOrdersCount > 9 ? '9+' : newOrdersCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ==================== 图片预览功能 ====================
        function initImagePreview() {
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeModal = document.getElementById('closeModal');

            closeModal.addEventListener('click', function() {
                imageModal.classList.remove('active');
            });

            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.classList.remove('active');
                }
            });
        }

        function showFullImage(imageSrc) {
            const modalImage = document.getElementById('modalImage');
            const imageModal = document.getElementById('imageModal');

            modalImage.src = imageSrc;
            imageModal.classList.add('active');
        }

        // ==================== 辅助函数 ====================
        function showLoading(text = '处理中...') {
            const loadingOverlay = document.getElementById('globalLoading');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            loadingOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function hideLoading() {
            const loadingOverlay = document.getElementById('globalLoading');
            loadingOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = 'custom-notification';
            notification.style.cssText =
                `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#e31837' : '#e31837'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: bold;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                font-size: 14px;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);

            // 添加动画样式
            if (!document.querySelector('#notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent =
                    `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
                document.head.appendChild(style);
            }
        }
    </script>
</body>
</html>
